TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE    1

       2                            .file   "pal.asm"
       3                            .width  132
       4                            .option b,d,l,t
       5                            .mnolist
       6                    
       7                    
       8                            .include        "mproc.equ"
       9                            .include        "display.equ"
      10                            .include        "sys.equ"
      11                            .include        "gsp.equ"
      12                            .include        "game.equ"
      13                            .include        "macros.h"
      14                    
      15                            .include        "fontsimg.glo"
      16                            .include        "bgndtbl.glo"
      17                    
      18                    
      19                            .ref    IRQSKYE
      20                            .REF    IGNORE_SPECIAL,IGNORE_THIS_PAL
      21                    
      22                    
      23                    
      24                    
      25              0008  FPALNUM .equ    8
      26              1000  FPALSZ  .equ    256*16
      27                    
      28                    
      29                    
      30 00000000                   .bss    fade_start,16
      31 00000010                   .bss    fade_end,16
      32 00000020                   .bss    fade_inc,16
      33 00000030                   .bss    fade_list,32            ;list of palettes not to fade
      34                    
      35                    
      36 00000000                   BSSX    PALRAM  ,0              ;Palette allocation ram
      37 00000000                   BSSX    PALFRAM ,PALRSIZ*NMFPAL
      38 00000000                   BSSX    PALBRAM ,PALRSIZ*NMBPAL
      39 00000000                   BSSX    PALTRAM ,PALTSIZ*NUMPALT
      40                    
      41 00000000                   BSSX    FADERAM ,FPALSZ*NMFPAL  ;Fade mem for palettes
      42                    
      43 00000000                   BSSX    palfmin ,16
      44 00051960                   .bss    irqskyeo,16             ;Orignal autoerase color
      45                    
      46                    
      47              1950- morfpal1        equ     FADERAM+0*16*64
      48              1d50- morfpal2        equ     FADERAM+1*16*64
      49              2150- morfpal3        equ     FADERAM+2*16*64
      50              2550- morfpal4        equ     FADERAM+3*16*64
      51              2950- morfpal5        equ     FADERAM+4*16*64
      52              2d50- morfpal6        equ     FADERAM+5*16*64
      53              3150- morfpal7        equ     FADERAM+6*16*64
      54              3550- morfpal8        equ     FADERAM+7*16*64
      55              3950- morfpal9        equ     FADERAM+8*16*64
      56              3d50- morfpal10       equ     FADERAM+9*16*64
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE    2

      57              4150- morfpal11       equ     FADERAM+10*16*64
      58                    
      59                            .def    morfpal1,morfpal2
      60                            .def    morfpal3,morfpal4
      61                            .def    morfpal5,morfpal6
      62                            .def    morfpal7,morfpal8
      63                            .def    morfpal9,morfpal10
      64                            .def    morfpal11
      65                    
      66 00000000                   .text
      67                    
      68                    
      69                    
      70                    
      71 00000000            SUBR   pal_init
      72                    
      73 00000000     09e0          movi    PALRAM,a0               ;*Pal list
         00000010 00000050- 
      74 00000030     09d0          movi    PALRSIZ*NUMPAL/16,b0    ;# of words
         00000040     00a0  
      75                    
      76 00000050     5621          clr     a1
      77 00000060     9020  hlwcl1  move    a1,*a0+
      78 00000070     3c50          dsj     b0,hlwcl1
      79                    
      80 00000080     09e0          movi    PALTRAM,a0              ;*xfer ram
         00000090 00000a50- 
      81 000000b0     09d0          movi    PALTSIZ*NUMPALT/16,b0   ;# of words
         000000c0     00f0  
      82                    
      83 000000d0     9020  hlwcl2  move    a1,*a0+
      84 000000e0     3c50          dsj     b0,hlwcl2
      85                    
      86                            ;always start with DIAGP as pal 0!
      87 000000f0     09e0          movi    DIAGP,a0
         00000100 00000000! 
      88 00000120     0d3f          callr   pal_getf
         00000130     0046  
      89 00000140     0960          rets
      90                    
      91                    
      92                    
      93 00000150            SUBR   pal_clean
      94                    
      95 00000150                   PUSH    a0,a2,a3,a4
      96 00000170     09e2          movi    PALRAM+PALRSIZ,a2       ;Skip 1st pal
         00000180 00000070- 
      97                    
      98 000001a0     09c3          movi    NUMPAL-1,a3             ;Chk all pals
         000001b0     004f  
      99 000001c0     09c4          movi    00101H,a4               ;2nd PAL #
         000001d0     0101  
     100                    
     101 000001e0     07a0  mlpglp  move    @OBJLST,a0,L
         000001f0 00000000! 
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE    3

     102 00000210     ca06          jrz     cp30                    ;No objs, chk backgnd
     103                    
     104 00000220     b40e  cp20    move    *a0(OPAL),a14
         00000230     0150  
     105 00000240     49c4          cmp     a14,a4
     106 00000250     ca17          jreq    cp80                    ;Used? Chk next
     107 00000260     8600          move    *a0,a0,L
     108 00000270     cbfa          jrnz    cp20
     109                    
     110 00000280     07a0  cp30    move    @BAKLST,a0,L            ;Check in bgnd list
         00000290 00000000! 
     111 000002b0     ca06          jrz     cp60                    ;No objects, clean it out
     112                    
     113 000002c0     b40e  cp50    move    *a0(OPAL),a14
         000002d0     0150  
     114 000002e0     49c4          cmp     a14,a4
     115 000002f0     ca0d          jreq    cp80                    ;Used? Chk next
     116 00000300     8600          move    *a0,a0,L
     117 00000310     cbfa          jrnz    cp50
     118                    
     119 00000320           cp60
     120                    
     121 00000320           cp70
     122 00000320     05ae          MOVE    @IGNORE_SPECIAL,A14
         00000330 00000000! 
     123 00000350     ca05          JRZ     cp70a
     124 00000360     8640          move    *a2,a0,L
     125 00000370     0d5f          CALLA   IGNORE_THIS_PAL
         00000380 00000000! 
     126 000003a0     c802          JRC     cp80
     127 000003b0           cp70a
     128                    
     129 000003b0     5600          clr     a0                      ;Palette not used, free it
     130 000003c0     8202          move    a0,*a2,L
     131                    
     132 000003d0     0b04  cp80    addi    00101H,a4               ;Next pal
         000003e0     0101  
     133                            .if     PAL64
     134                            btst    4,a4
     135                            jrz     cp90
     136                            addi    03030H,a4
     137                            sext    a4                      ;For compare
     138                            .endif
     139                    
     140 000003f0     1002  cp90    addk    PALRSIZ,a2
     141 00000400     0d83          dsj     a3,mlpglp
         00000410     ffdc  
     142                    
     143 00000420                   PULL    a0,a2,a3,a4
     144 00000440     0960          rets
     145                    
     146                    
     147                    
     148 00000450            SUBR   pal_find
     149                    
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE    4

     150 00000450     09e1          movi    PALRAM,a1
         00000460 00000050- 
     151 00000480     09d0          movi    NUMPAL,b0
         00000490     0050  
     152                    
     153 000004a0     962e  pxerlp  move    *a1+,a14,L      ;Get * palette
     154 000004b0     480e          cmp     a0,a14
     155 000004c0     ca03          jreq    pxerok          ;Found?
     156 000004d0     3c90          dsj     b0,pxerlp
     157 000004e0     5600          clr     a0              ;Set Z
     158 000004f0     0960          rets
     159                    
     160 00000500     4c2e  pxerok  move    A1,a14
     161 00000510     0bf0          subi    NUMPAL,b0       ;Compute pal #
         00000520     ffaf  
     162 00000530     03b0          neg     b0
     163 00000540     4e11          move    b0,a1
     164                    
     165                    
     166 00000550     4c20          move    a1,a0           ;Return pal #
     167 00000560     2501          sll     8,a1
     168 00000570     4020          add     a1,a0
     169 00000580     1021          addk    1,a1            ;Clr Z (OK)
     170 00000590     0960          rets
     171                    
     172                    
     173                    
     174                    
     175 000005a0            SUBR   pal_getf
     176                    
     177 000005a0                   PUSH    a2,a3
     178                    
     179 000005c0     09e1          movi    PALRAM,a1       ;0CHheck if palette already exists
         000005d0 00000050- 
     180 000005f0     09c3          movi    NUMPAL,a3
         00000600     0050  
     181 00000610     9622  gfp4    move    *a1+,a2,L       ;Get *palette
     182 00000620     4802          cmp     a0,a2
     183 00000630     ca25          jreq    getpn           ;Already in color ram?
     184 00000640     3c83          dsj     a3,gfp4
     185                    
     186 00000650     09e1          movi    PALFRAM,a1      ;0CHheck for a spare palette
         00000660 00000050- 
     187 00000680     09c3          movi    NMFPAL,a3
         00000690     0050  
     188 000006a0     9622  gfp8    move    *a1+,a2,L
     189 000006b0     ca0f          jrz     getfp           ;Palette empty? Grab it
     190 000006c0     3c63          dsj     a3,gfp8
     191                    
     192                            .if     DEBUG
     193                            .endif
     194 000006d0     0d3f          callr   pal_clean
         000006e0     ffa6  
     195                    
     196 000006f0     09e1          movi    PALFRAM,a1      ;0CHheck for a spare palette
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE    5

         00000700 00000050- 
     197 00000720     09c3          movi    NMFPAL,a3
         00000730     0050  
     198 00000740     9622  gfp20   move    *a1+,a2,L
     199 00000750     ca05          jrz     getfp           ;Palette empty? Grab it
     200 00000760     3c63          dsj     a3,gfp20
     201                    
     202 00000770           flnuerr PULL    a2,a3
     203 00000790     5600          clr     a0              ;Set Z error
     204 000007a0     0960          rets
     205                    
     206                    
     207                    
     208                            .if     NMBPAL
     209                    
     210                     SUBR   pal_getb
     211                    
     212                            PUSH    a2,a3
     213                    
     214                            movi    PALRAM,a1       ;0CHheck if palette already exists
     215                            movi    NUMPAL,a3
     216                    gbp4    move    *a1+,a2,L       ;Get *palette
     217                            cmp     a0,a2
     218                            jreq    getpn           ;Already in color ram?
     219                            dsj     a3,gbp4
     220                    
     221                            movi    PALBRAM,a1      ;0CHheck for a spare palette
     222                            movk    NMBPAL,a3
     223                    gbp8    move    *a1+,a2,L
     224                            jrz     gbp30           ;Palette empty? Grab it
     225                            dsj     a3,gbp8
     226                    
     227                            .if     DEBUG
     228                            LOCKUP
     229                            eint
     230                            .endif
     231                            callr   pal_clean
     232                    
     233                            movi    PALBRAM,a1      ;0CHheck for a spare palette
     234                            movk    NMBPAL,a3
     235                    gbp10   move    *a1+,a2,L
     236                            jrz     gbp30           ;Palette empty? Grab it
     237                            dsj     a3,gbp10
     238                            jruc    flnuerr
     239                    
     240                    
     241                    getfp   addk    NMBPAL,a3       ;>Setup your new palette
     242                    
     243                            .else
     244 000007b0           getfp
     245                    
     246                            .endif
     247                    
     248                    
     249 000007b0           gbp30   PUSH    a0,a1
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE    6

     250 000007d0     4c61          move    a3,a1           ;Palette #
     251 000007e0     0be1          subi    NUMPAL,a1       ;Compute palette #
         000007f0     ffaf  
     252 00000800     03a1          neg     a1
     253                    
     254                            .if     PAL64
     255                            movk    0fH,a2
     256                            and     a1,a2           ;A2=4 low bits
     257                            srl     4,a1            ;Move B4/B5 to B6/B7
     258                            sll     6,a1
     259                            add     a2,a1
     260                            .endif
     261                    
     262 00000810     2501          sll     8,a1            ;*256
     263 00000820     9402          move    *a0+,a2         ;Get # colors in pal
     264 00000830     0d3f          callr   pal_set         ;Setup pal transfer
         00000840     000e  
     265 00000850     09af          mmfm    sp,a0,a1
         00000860     0003  
     266 00000870     caef          jrz     flnuerr         ;Failed to get transfer?
     267 00000880     a201          move    a0,-*a1,L       ;Stuff palette *
     268                    
     269 00000890     0be3  getpn   subi    NUMPAL,a3       ;Compute palette #
         000008a0     ffaf  
     270 000008b0     03a3          neg     a3
     271                    
     272                            .if     PAL64
     273                            movk    0fH,a1
     274                            and     a3,a1           ;A2=4 low bits
     275                            srl     4,a3            ;Move B4/B5 to B6/B7
     276                            sll     6,a3
     277                            add     a1,a3
     278                            .endif
     279                    
     280 000008c0     4c60          move    a3,a0           ;Return palette #
     281 000008d0     2503          sll     8,a3
     282 000008e0     4060          add     a3,a0           ;Double it up for DMA
     283                    
     284 000008f0                   PULL    a2,a3
     285 00000910     1021          addk    1,a1            ;Clr Z for OK
     286 00000920     0960          rets
     287                    
     288                    
     289                    
     290 00000930            SUBR   pal_set
     291                    
     292 00000930     4e61          move    a3,b1
     293                    
     294 00000940     09e3          movi    PALTRAM,a3
         00000950 00000a50- 
     295 00000970     09d0          movi    NUMPALT,b0      ;# of palette transfers allowed
         00000980     003c  
     296                    
     297 00000990     946e  dbvnlp  move    *a3+,a14
     298 000009a0     ca04          jrz     dbvnset         ;Cell free?
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE    7

     299 000009b0     0b03          addi    PALTSIZ-16,a3
         000009c0     0030  
     300 000009d0     3cb0          dsj     b0,dbvnlp
     301                            .if     DEBUG
     302                            LOCKUP
     303                            eint
     304                            .endif
     305 000009e0     c004          jruc    dbvnx
     306                    
     307 000009f0     9203  dbvnset move    a0,*a3+,L       ;Set PALSRC
     308 00000a00     8023          move    a1,*a3          ;Set PALDEST
     309 00000a10     b043          move    a2,*a3(-48)     ;Set PLDCNT (Must set last)
         00000a20     ffd0  
     310                    
     311 00000a30     4e33  dbvnx   move    b1,a3
     312 00000a40     4c10          move    b0,b0           ;Return Z (error) or NZ (ok)
     313 00000a50     0960          rets
     314                    
     315                    
     316                    
     317                    
     318 00000a60            SUBR   pal_transfer
     319                    
     320 00000a60     09e0          movi    PALTRAM,a0
         00000a70 00000a50- 
     321 00000a90     09c3          movi    NUMPALT,a3      ;# OF PALETTES
         00000aa0     003c  
     322                    
     323 00000ab0     56c6          clr     a6
     324 00000ac0     09e7          movi    COLRAM,a7
         00000ad0 01880000  
     325                    
     326 00000af0     8404  sxcllp  move    *a0,a4          ;Get count
     327 00000b00     ca18          jrz     sxclx           ;End?
     328                    
     329              0000  PAL_DEBUG       equ     0
     330                            .if PAL_DEBUG
     331                            move    @HEBLNK,a1
     332                            cmpi    HEBLNKINIT,a1
     333                            jrnz    sxclhb_ok
     334                            LOCKUP
     335                    sxclhb_ok
     336                            .endif
     337                    
     338 00000b10     90c0          move    a6,*a0+         ;Clear out tranfer count
     339 00000b20     9601          move    *a0+,a1,L       ;Source address
     340 00000b30     9402          move    *a0+,a2         ;Destination palette
     341 00000b40     0522          zext    a2
     342                    
     343                            .if     PAL64
     344                            move    a2,a5           ;Convert to color ram address
     345                            sll     32-12,a5
     346                            srl     32-12-4,a5      ;*16
     347                            srl     14,a2           ;Move B14/15 to B6/7
     348                            sll     6+4,a2
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE    8

     349                            add     a5,a2
     350                            .else
     351 00000b50     2482          sll     4,a2            ;*16 for word addr
     352                            .endif
     353                    
     354 00000b60     40e2          add     a7,a2           ;+color ram base address
     355                    
     356 00000b70     26e4          sll     32-9,a4         ;Make 0-511
     357 00000b80     2d04          srl     32-9+1,a4
     358 00000b90     c901          jrnc    sxcl1           ;Even data count?
     359 00000ba0     9822          move    *a1+,*a2+
     360                    
     361 00000bb0     2fe4  sxcl1   srl     1,a4            ;/2 data count
     362 00000bc0     c901          jrnc    sxcl2           ;Even?
     363 00000bd0     9a22          move    *a1+,*a2+,L
     364                    
     365 00000be0     2fe4  sxcl2   srl     1,a4            ;/2 data count
     366 00000bf0     c902          jrnc    sxcl3           ;Even?
     367 00000c00     9a22          move    *a1+,*a2+,L
     368 00000c10     9a22          move    *a1+,*a2+,L
     369 00000c20     ca05  sxcl3   jrz     sxcl5           ;Cnt=0?
     370                    
     371 00000c30     9a22  sxcl4   move    *a1+,*a2+,L
     372 00000c40     9a22          move    *a1+,*a2+,L
     373 00000c50     9a22          move    *a1+,*a2+,L
     374 00000c60     9a22          move    *a1+,*a2+,L
     375 00000c70     3ca4          dsj     a4,sxcl4
     376                    
     377 00000c80     3f43  sxcl5   dsj     a3,sxcllp
     378                    
     379 00000c90     0960  sxclx   rets
     380                    
     381                    
     382                    
     383                    
     384 00000ca0            SUBR   pal_blacken
     385                    
     386 00000ca0                   PUSH    a2
     387                    
     388 00000cb0     0d3f          callr   pal_find
         00000cc0     ff78  
     389 00000cd0     ca10          jrz     luymerr
     390 00000ce0     2500          sll     8,a0
     391 00000cf0     4c01          move    a0,a1
     392 00000d00     09e0          movi    FADERAM,a0
         00000d10 00001950- 
     393 00000d30     1810          movk    32,b0
     394 00000d40     5642          clr     a2
     395 00000d50     9240  luymlp  move    a2,*a0+,L
     396 00000d60     3c50          dsj     b0,luymlp
     397 00000d70     09e0          movi    FADERAM,a0
         00000d80 00001950- 
     398 00000da0     09c2          movi    64,a2
         00000db0     0040  
     399 00000dc0     0d3f          callr   pal_set
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE    9

         00000dd0     ffb5  
     400                    
     401 00000de0           luymerr PULL    a2
     402 00000df0     0960          rets
     403                    
     404                    
     405                    
     406                    
     407                    
     408                    
     409                    
     410                    
     411 00000e00            SUBR   pal_fadein
     412                    
     413 00000e00     4c09          move    a0,a9           ;A9=*Palette list
     414 00000e10     4c2a          move    a1,a10          ;A10=Fade delay
     415 00000e20                   CREATE0 fadein
     416 00000e90     0960          rets
     417                    
     418 00000ea0           fadein
     419 00000ea0     4da6          move    a13,a6
     420 00000eb0     0b06          addi    PDATA,a6
         00000ec0     0100  
     421 00000ed0     1907          movk    FPALNUM,a7
     422                    
     423 00000ee0     4d2b          move    a9,a11
     424 00000ef0     9760          move    *a11+,a0,L              ;!-=Autoerase color
     425 00000f00     ce05          jrn     fi30
     426 00000f10     0580          move    a0,@irqskyeo            ;Save color
         00000f20 00051960- 
     427                    
     428 00000f40     9760  fi20    move    *a11+,a0,L              ;Get * palette
     429 00000f50     ca07          jrz     fi70                    ;0=End
     430 00000f60     0d3f  fi30    callr   pal_find
         00000f70     ff4d  
     431 00000f80     cb01          jrnz    fi60                    ;OK?
     432 00000f90     03e0          not     a0                      ;Make neg (should = -256)
     433 00000fa0     2500  fi60    sll     8,a0
     434 00000fb0     9006          move    a0,*a6+                 ;Save palette #
     435 00000fc0     3d27          dsj     a7,fi20
     436                    
     437 00000fd0     5708  fi70    clr     a8                      ;A8=Brightness
     438                    
     439                    
     440 00000fe0     1108  fi100   addk    8,a8
     441                    
     442 00000ff0     09e5          movi    FADERAM,a5
         00001000 00001950- 
     443 00001020     4da6          move    a13,a6
     444 00001030     0b06          addi    PDATA,a6
         00001040     0100  
     445 00001050     1907          movk    FPALNUM,a7
     446                    
     447 00001060     4d2b          move    a9,a11
     448 00001070     8761          move    *a11,a1,L
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE   10

     449 00001080     ce04          jrn     fi200
     450 00001090     100b          addk    32,a11
     451 000010a0     4d02          move    a8,a2
     452 000010b0     0d3f          callr   pal_fadeae
         000010c0     006c  
     453                    
     454 000010d0     9761  fi200   move    *a11+,a1,L
     455 000010e0     ca0f          jrz     fi400                   ;End?
     456 000010f0     4ca0          move    a5,a0
     457 00001100     4d02          move    a8,a2
     458 00001110     0d3f          callr   pal_fade
         00001120     0070  
     459 00001130     4ca0          move    a5,a0                   ;*Palette colors
     460 00001140     94c1          move    *a6+,a1                 ;Palette #
     461 00001150     0b41          cmpi    -256,a1                 ;FF00
         00001160     00ff  
     462 00001170     ca03          jreq    fi230                   ;Couldn't find?
     463 00001180     9402          move    *a0+,a2                 ;luymColors
     464 00001190     0d3f          callr   pal_set
         000011a0     ff78  
     465 000011b0     0b05  fi230   addi    FPALSZ,a5
         000011c0     1000  
     466 000011d0     3e27          dsj     a7,fi200
     467                    
     468 000011e0     4d40  fi400   move    a10,a0
     469 000011f0     0d5f          calla   PRCSLP
         00001200 00000000! 
     470 00001220     0b48          cmpi    128,a8
         00001230     ff7f  
     471 00001240     c8d9          jrlo    fi100
     472                    
     473 00001250           fi800   DIE
     474                    
     475                    
     476                    
     477                    
     478                    
     479                    
     480 00001280            SUBR   pal_fadeout
     481                    
     482 00001280     574a          clr     a10
     483 00001290     058a          move    a10,@palfmin
         000012a0 00051950- 
     484                    
     485 000012c0            SUBR   pal_fadeout2
     486                    
     487 000012c0     4c09          move    a0,a9           ;A9=*Palette list
     488 000012d0     4c2a          move    a1,a10          ;A10=Fade delay
     489 000012e0                   CREATE0 fadeout
     490 00001350     0960          rets
     491                    
     492 00001360           fadeout
     493 00001360     4da6          move    a13,a6
     494 00001370     0b06          addi    PDATA,a6
         00001380     0100  
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE   11

     495 00001390     1907          movk    FPALNUM,a7
     496                    
     497 000013a0     4d2b          move    a9,a11
     498 000013b0     9760          move    *a11+,a0,L              ;!-=Autoerase color
     499 000013c0     ce08          jrn     fo30
     500 000013d0     05a0          move    @IRQSKYE,a0             ;Save color
         000013e0 00000000! 
     501 00001400     0580          move    a0,@irqskyeo
         00001410 00051960- 
     502                    
     503 00001430     9760  fo20    move    *a11+,a0,L              ;Get * palette
     504 00001440     ca07          jrz     fo70                    ;0=End
     505 00001450     0d3f  fo30    callr   pal_find
         00001460     fefe  
     506 00001470     cb01          jrnz    fo60
     507 00001480     03e0          not     a0                      ;Make neg
     508 00001490     2500  fo60    sll     8,a0
     509 000014a0     9006          move    a0,*a6+                 ;Save palette #
     510 000014b0     3d27          dsj     a7,fo20
     511                    
     512 000014c0     09c8  fo70    movi    128,a8                  ;A8=Brightness
         000014d0     0080  
     513                    
     514                    
     515 000014e0     1508  fo100   subk    8,a8
     516                    
     517 000014f0     09e5          movi    FADERAM,a5
         00001500 00001950- 
     518 00001520     4da6          move    a13,a6
     519 00001530     0b06          addi    PDATA,a6
         00001540     0100  
     520 00001550     1907          movk    FPALNUM,a7
     521                    
     522 00001560     4d2b          move    a9,a11
     523 00001570     9761          move    *a11+,a1,L
     524 00001580     ce05          jrn     fo220
     525 00001590     4d02          move    a8,a2
     526 000015a0     0d3f          callr   pal_fadeae
         000015b0     001d  
     527                    
     528 000015c0     9761  fo200   move    *a11+,a1,L
     529 000015d0     ca0f          jrz     fo400
     530 000015e0     4ca0  fo220   move    a5,a0
     531 000015f0     4d02          move    a8,a2
     532 00001600     0d3f          callr   pal_fade
         00001610     0021  
     533 00001620     4ca0          move    a5,a0                   ;*Palette colors
     534 00001630     94c1          move    *a6+,a1                 ;Palette #
     535 00001640     0b41          cmpi    -256,a1                 ;FF00
         00001650     00ff  
     536 00001660     ca03          jrz     fo250
     537 00001670     9402          move    *a0+,a2                 ;luymColors
     538 00001680     0d3f          callr   pal_set
         00001690     ff29  
     539 000016a0     0b05  fo250   addi    FPALSZ,a5
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE   12

         000016b0     1000  
     540 000016c0     3e27          dsj     a7,fo200
     541                    
     542 000016d0     4d40  fo400   move    a10,a0
     543 000016e0     0d5f          calla   PRCSLP
         000016f0 00000000! 
     544 00001710     05a0          move    @palfmin,a0
         00001720 00051950- 
     545 00001740     4808          cmp     a0,a8
     546 00001750     c7d8          jrgt    fo100
     547                    
     548 00001760           fo800   DIE
     549                    
     550                    
     551                    
     552 00001790            SUBRP  pal_fadeae      ;A2=Brightness (0-128)
     553                    
     554 00001790                   PUSH    a3,a5,a7,a8
     555                    
     556 000017b0     09e0          movi    IRQSKYE,a0
         000017c0 00000000! 
     557 000017e0     09e1          movi    irqskyeo,a1
         000017f0 00051960- 
     558 00001810     182e          movk    1,a14
     559 00001820     c006          jruc    pf1c
     560                    
     561                    
     562                    
     563 00001830            SUBRP  pal_fade
     564                    
     565 00001830                   PUSH    a3,a5,a7,a8
     566                    
     567 00001850     942e          move    *a1+,a14        ;# Colors
     568 00001860     91c0          move    a14,*a0+
     569                    
     570 00001870     26ee          sll     32-9,a14        ;Remove any flags
     571 00001880     2d2e          srl     32-9,a14        ;9 bits needed for # colors
     572                    
     573 00001890     1be8  pf1c    movk    01fH,a8         ;A8=5 bit color mask
     574                    
     575 000018a0     9423  pf100   move    *a1+,a3
     576 000018b0     1be7          movk    01fH,a7
     577 000018c0     5067          and     a3,a7           ;A7=Blue
     578 000018d0     2f63          srl     5,a3
     579 000018e0     1be5          movk    01fH,a5
     580 000018f0     5065          and     a3,a5           ;A5=Green
     581 00001900     2f63          srl     5,a3            ;A3=Red
     582                    
     583 00001910     5e43          mpyu    a2,a3
     584 00001920     5e45          mpyu    a2,a5
     585 00001930     5e47          mpyu    a2,a7
     586 00001940     2f23          srl     7,a3            ;/128
     587 00001950     2f25          srl     7,a5
     588 00001960     2f27          srl     7,a7
     589                    
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE   13

     590 00001970     4903          cmp     a8,a3
     591 00001980     c201          jrls    pfrok
     592 00001990     4d03          move    a8,a3
     593                    
     594 000019a0     4905  pfrok   cmp     a8,a5
     595 000019b0     c201          jrls    pfgok
     596 000019c0     4d05          move    a8,a5
     597                    
     598 000019d0     4907  pfgok   cmp     a8,a7
     599 000019e0     c201          jrls    pfbok
     600 000019f0     4d07          move    a8,a7
     601                    
     602 00001a00     2543  pfbok   sll     10,a3
     603 00001a10     24a5          sll     5,a5
     604 00001a20     54a3          or      a5,a3
     605 00001a30     54e3          or      a7,a3
     606 00001a40     9060          move    a3,*a0+         ;Save color
     607 00001a50     3f8e          dsj     a14,pf100
     608                    
     609 00001a60                   PULL    a3,a5,a7,a8
     610 00001a80     0960          rets
     611                    
     612                    
     613                    
     614                    
     615 00001a90            SUBR   pal_fadeinx
     616                    
     617 00001a90                   PUSH    a2,a6,a7,a8,a9,a10
     618 00001ab0     190a          movk    8,a10
     619 00001ac0     c004          jruc    fbf10
     620                    
     621                    
     622                    
     623 00001ad0            SUBR   pal_fadeoutx
     624                    
     625 00001ad0                   PUSH    a2,a6,a7,a8,a9,a10
     626 00001af0     09ca          movi    -8,a10
         00001b00     fff8  
     627                    
     628 00001b10     4c06  fbf10   move    a0,a6
     629                                                            ;Start proc to fade each palette
     630 00001b20     5729          clr     a9                      ;palette slot
     631 00001b30     09e2          movi    PALRAM,a2               ;A2=*Palette table
         00001b40 00000050- 
     632                    
     633 00001b60     9648  fbf20   move    *a2+,a8,L               ;Ptr to palette
     634 00001b70     ca0e          jrz     fbf70
     635 00001b80     4cc7          move    a6,a7                   ;A6=*List of palettes to skip
     636 00001b90     ca05          jrz     fbf60
     637                    
     638 00001ba0     96e1  fbf50   move    *a7+,a1,L
     639 00001bb0     ca03          jrz     fbf60
     640 00001bc0     4828          cmp     a1,a8
     641 00001bd0     ca08          jreq    fbf70                   ;Skip pal?
     642 00001be0     c0fb          jruc    fbf50
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE   14

     643                    
     644 00001bf0           fbf60   CREATE0 fadeonep
     645                    
     646 00001c60     1029  fbf70   addk    1,a9
     647 00001c70     0b49          cmpi    NUMPAL,a9
         00001c80     ffaf  
     648 00001c90     c4ec          jrlt    fbf20
     649                    
     650 00001ca0           fbfx    PULL    a2,a6,a7,a8,a9,a10
     651 00001cc0     0960          rets
     652                    
     653                    
     654                    
     655 00001cd0           fadeonep
     656                    
     657                            .if     PAL64
     658                            movk    0fH,a2
     659                            and     a9,a2           ;A2=4 low bits
     660                            srl     4,a9            ;Move B4/B5 to B6/B7
     661                            sll     6,a9
     662                            add     a2,a9
     663                            .endif
     664                    
     665 00001cd0     2509          sll     8,a9            ;B8-15 dest pal, B0-7 color (0)
     666                    
     667 00001ce0     576b          clr     a11             ;For up fade
     668 00001cf0     4d4a          move    a10,a10
     669 00001d00     c714          jrgt    fop60
     670 00001d10     09cb          movi    128,a11         ;For dn fade
         00001d20     0080  
     671 00001d30     c011          jruc    fop60
     672                                                    ;>Set up faded pal in process data space
     673 00001d40           foplp
     674 00001d40     4d62          move    a11,a2          ;A2=Color Multiplier
     675 00001d50     4da0          move    a13,a0
     676 00001d60     0b00          addi    PDATA,a0        ;A0=Dest Ram for Pal
         00001d70     0100  
     677 00001d80     4c05          move    a0,a5
     678 00001d90     4d01          move    a8,a1           ;A1=Src for Pal
     679 00001da0     0d3f          callr   pal_fade
         00001db0     ffa7  
     680                    
     681 00001dc0     4ca0          move    a5,a0           ;>Move faded palette to palram
     682 00001dd0     4d21          move    a9,a1
     683 00001de0     9402          move    *a0+,a2         ;Get # colors in palette
     684 00001df0     0d3f          callr   pal_set         ;Set transfer
         00001e00     feb2  
     685                    
     686 00001e10                   SLEEPK  2
     687 00001e50     414b  fop60   add     a10,a11
     688 00001e60     0b4b          cmpi    128,a11
         00001e70     ff7f  
     689 00001e80     c2eb          jrls    foplp
     690                    
     691                    
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE   15

     692 00001e90                   SLEEPK  2               ;Wait on last pal_set
     693 00001ed0                   DIE
     694                    
     695                    
     696                    
     697 00001f00            SUBR   pal_fmwht
     698                    
     699 00001f00                   PUSH    a2,a6,a7,a8,a9,a10
     700 00001f20     09ca          movi    -1,a10
         00001f30     ffff  
     701 00001f40     c009          jruc    ptw10
     702                    
     703                    
     704                    
     705 00001f50            SUBR   pal_towht
     706                    
     707 00001f50                   PUSH    a2,a6,a7,a8,a9,a10
     708 00001f70     05a2          move    @IRQSKYE,a2             ;Save color
         00001f80 00000000! 
     709 00001fa0     0582          move    a2,@irqskyeo
         00001fb0 00051960- 
     710 00001fd0     182a          movk    1,a10
     711                    
     712 00001fe0     4c06  ptw10   move    a0,a6
     713 00001ff0     4c21          move    a1,a1
     714 00002000     ca07          jrz     ptw15                   ;Skip AE
     715 00002010                   CREATE0 addbrt_ae
     716                                                            ;Start proc to fade each palette
     717 00002080     5729  ptw15   clr     a9                      ;palette slot
     718 00002090     09e2          movi    PALRAM,a2               ;A2=*Palette table
         000020a0 00000050- 
     719                    
     720 000020c0     9648  ptw20   move    *a2+,a8,L               ;Ptr to palette
     721 000020d0     ca0e          jrz     ptw70
     722 000020e0     4cc7          move    a6,a7                   ;A6=*List of palettes to skip
     723 000020f0     ca05          jrz     ptw60
     724                    
     725 00002100     96e1  ptw50   move    *a7+,a1,L
     726 00002110     ca03          jrz     ptw60
     727 00002120     4828          cmp     a1,a8
     728 00002130     ca08          jreq    ptw70                   ;Skip pal?
     729 00002140     c0fb          jruc    ptw50
     730                    
     731 00002150           ptw60   CREATE0 brightenonep
     732                    
     733 000021c0     1029  ptw70   addk    1,a9
     734 000021d0     0b49          cmpi    NUMPAL,A9
         000021e0     ffaf  
     735 000021f0     c4ec          jrlt    ptw20
     736                    
     737 00002200           ptwx    PULL    a2,a6,a7,a8,a9,a10
     738 00002220     0960          rets
     739                    
     740                    
     741                    
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE   16

     742 00002230           brightenonep
     743                            .if     PAL64
     744                            movk    0fH,a2
     745                            and     a9,a2           ;A2=4 low bits
     746                            srl     4,a9            ;Move B4/B5 to B6/B7
     747                            sll     6,a9
     748                            add     a2,a9
     749                            .endif
     750                    
     751 00002230     2509          sll     8,a9            ;B8-15 dest pal, B0-7 color (0)
     752                    
     753 00002240     576b          clr     a11             ;For up fade
     754 00002250     4d4a          move    a10,a10
     755 00002260     c701          jrgt    bop20
     756 00002270     1beb          movk    31,a11          ;For dn fade
     757 00002280           bop20
     758                                                    ;Set up faded pal in process data space
     759 00002280     414b  boplp   add     a10,a11
     760 00002290     0b4b          cmpi    31,a11
         000022a0     ffe0  
     761 000022b0     c312          jrhi    bopx
     762 000022c0     4d62          move    a11,a2          ;A2=Brightness
     763 000022d0     4da0          move    a13,a0
     764 000022e0     0b00          addi    PDATA,a0        ;A0=Dest Ram for Pal
         000022f0     0100  
     765 00002300     4c05          move    a0,a5
     766 00002310     4d01          move    a8,a1           ;A1=Src for Pal
     767 00002320     0d3f          callr   pal_addb
         00002330     002e  
     768                    
     769 00002340     4ca0          move    a5,a0           ;>Move faded palette to palram
     770 00002350     4d21          move    a9,a1
     771 00002360     9402          move    *a0+,a2         ;Get # colors in palette
     772 00002370     0d3f          callr   pal_set         ;Set transfer
         00002380     fe5a  
     773                    
     774 00002390                   SLEEPK  3
     775 000023d0     c0ea          jruc    boplp
     776                    
     777 000023e0           bopx    SLEEPK  1               ;give last xfer a chance to go
     778 00002420                   DIE
     779                    
     780                    
     781                    
     782 00002450            SUBR   addbrt_ae
     783                    
     784 00002450     576b          clr     a11             ;For up fade
     785 00002460     4d4a          move    a10,a10
     786 00002470     c701          jrgt    abae20
     787 00002480     1beb          movk    31,a11          ;For dn fade
     788 00002490           abae20
     789 00002490     414b  abaelp  add     a10,a11
     790 000024a0     0b4b          cmpi    31,a11
         000024b0     ffe0  
     791 000024c0     c308          jrhi    abaex
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE   17

     792 000024d0     4d62          move    a11,a2          ;A2=Brightness
     793 000024e0     0d3f          callr   addbae
         000024f0     0008  
     794                    
     795 00002500                   SLEEPK  3
     796 00002540     c0f4          jruc    abaelp
     797                    
     798 00002550           abaex   DIE
     799                    
     800                    
     801                    
     802 00002580            SUBRP  addbae
     803                    
     804 00002580                   PUSH    a3,a5,a7,a8
     805                    
     806 000025a0     09e0          movi    IRQSKYE,a0
         000025b0 00000000! 
     807 000025d0     09e1          movi    irqskyeo,a1
         000025e0 00051960- 
     808 00002600     182e          movk    1,a14
     809 00002610     c006          jruc    pb1c
     810                    
     811                    
     812                    
     813 00002620            SUBRP  pal_addb
     814                    
     815 00002620                   PUSH    a3,a5,a7,a8
     816                    
     817 00002640     942e          move    *a1+,a14        ;# Colors
     818 00002650     91c0          move    a14,*a0+
     819                    
     820 00002660     26ee          sll     23,a14          ;Remove any flags
     821 00002670     2d2e          srl     23,a14          ;9 bits needed for # colors
     822                    
     823 00002680     1be8  pb1c    movk    01fH,a8         ;A8=Mask for 5 bits of color
     824                    
     825 00002690     9423  pb100   move    *a1+,a3
     826 000026a0     1be7          movk    01fH,a7
     827 000026b0     5067          and     a3,a7           ;A7=Blue
     828 000026c0     2f63          srl     5,a3
     829 000026d0     1be5          movk    01fH,a5
     830 000026e0     5065          and     a3,a5           ;A5=Green
     831 000026f0     2f63          srl     5,a3            ;A3=Red
     832                    
     833 00002700     4043          add     a2,a3
     834 00002710     4045          add     a2,a5
     835 00002720     4047          add     a2,a7
     836                    
     837 00002730     4903          cmp     a8,a3
     838 00002740     c201          jrls    pbrok
     839 00002750     4d03          move    a8,a3
     840                    
     841 00002760     4905  pbrok   cmp     a8,a5
     842 00002770     c201          jrls    pbgok
     843 00002780     4d05          move    a8,a5
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE   18

     844                    
     845 00002790     4907  pbgok   cmp     a8,a7
     846 000027a0     c201          jrls    pbbok
     847 000027b0     4d07          move    a8,a7
     848                    
     849 000027c0     2543  pbbok   sll     10,a3
     850 000027d0     24a5          sll     5,a5
     851 000027e0     54a3          or      a5,a3
     852 000027f0     54e3          or      a7,a3
     853 00002800     9060          move    a3,*a0+         ;Save color
     854 00002810     3f2e          dsj     a14,pb100
     855                    
     856 00002820                   PULL    a3,a5,a7,a8
     857 00002840     0960          rets
     858                    
     859                    
     860                    
     861 00002850            SUBR   fade_up
     862                    
     863 00002850     078a          move    a10,@fade_list,L
         00002860 00000030- 
     864                    
     865 00002880     5600          clr     a0
     866 00002890     0580          move    a0,@fade_start
         000028a0 00000000- 
     867                    
     868 000028c0     09c0          movi    256,a0
         000028d0     0100  
     869 000028e0     0580          move    a0,@fade_end
         000028f0 00000010- 
     870                    
     871 00002910     4d60          move    a11,a0                  ;movk 8
     872 00002920     0580          move    a0,@fade_inc
         00002930 00000020- 
     873                    
     874 00002950     c034          jruc    do_fade
     875                    
     876                    
     877 00002960            SUBR   fade_down
     878                    
     879 00002960     078a          move    a10,@fade_list,L
         00002970 00000030- 
     880                    
     881 00002990     09c0          movi    256,a0
         000029a0     0100  
     882 000029b0     0580          move    a0,@fade_start
         000029c0 00000000- 
     883                    
     884 000029e0     5600          clr     a0
     885 000029f0     0580          move    a0,@fade_end
         00002a00 00000010- 
     886                    
     887 00002a20     058b          move    a11,@fade_inc
         00002a30 00000020- 
     888                    
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE   19

     889 00002a50     c024          jruc    do_fade
     890                    
     891                    
     892 00002a60            SUBR   fade_up_half
     893                    
     894 00002a60     078a          move    a10,@fade_list,L
         00002a70 00000030- 
     895                    
     896 00002a90     09c0          movi    128,a0
         00002aa0     0080  
     897 00002ab0     0580          move    a0,@fade_start
         00002ac0 00000000- 
     898                    
     899 00002ae0     09c0          movi    256,a0
         00002af0     0100  
     900 00002b00     0580          move    a0,@fade_end
         00002b10 00000010- 
     901                    
     902 00002b30     1a00          movk    16,a0
     903 00002b40     0580          move    a0,@fade_inc
         00002b50 00000020- 
     904                    
     905 00002b70     c012          jruc    do_fade
     906                    
     907                    
     908 00002b80            SUBR   fade_down_half
     909                    
     910 00002b80     078a          move    a10,@fade_list,L
         00002b90 00000030- 
     911                    
     912 00002bb0     09c0          movi    256,a0
         00002bc0     0100  
     913 00002bd0     0580          move    a0,@fade_start
         00002be0 00000000- 
     914                    
     915 00002c00     09c0          movi    128,a0
         00002c10     0080  
     916 00002c20     0580          move    a0,@fade_end
         00002c30 00000010- 
     917                    
     918 00002c50     1a00          movk    16,a0
     919 00002c60     0580          move    a0,@fade_inc
         00002c70 00000020- 
     920                    
     921 00002c90     0300          jruc    do_fade
     922                    
     923                    
     924 00002ca0            SUBRP  do_fade
     925                    
     926 00002ca0     05a0          move    @IRQSKYE,a0
         00002cb0 00000000! 
     927 00002cd0     0580          move    a0,@irqskyeo
         00002ce0 00051960- 
     928                    
     929 00002d00     05aa          move    @fade_start,a10
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE   20

         00002d10 00000000- 
     930 00002d30           pryvfade_loop
     931                    
     932 00002d30     05ab          move    @irqskyeo,a11
         00002d40 00051960- 
     933 00002d60     1be7          movk    01fH,a7
     934 00002d70     5167          and     a11,a7          ;A7  = Blue
     935 00002d80     2f6b          srl     5,a11
     936 00002d90     1be9          movk    01fH,a9
     937 00002da0     5169          and     a11,a9          ;A9  = Green
     938 00002db0     2f6b          srl     5,a11           ;A11 = Red
     939                    
     940 00002dc0     5f47          mpyu    a10,a7          ; X (0 - 32)
     941 00002dd0     2f07          srl     8,a7            ;/256
     942 00002de0     5f49          mpyu    a10,a9
     943 00002df0     2f09          srl     8,a9
     944 00002e00     5f4b          mpyu    a10,a11
     945 00002e10     2f0b          srl     8,a11
     946                    
     947 00002e20     254b          sll     10,a11          ;red
     948 00002e30     5567          or      a11,a7
     949 00002e40     24a9          sll     5,a9            ;green
     950 00002e50     5527          or      a9,a7
     951                    
     952 00002e60     0587          move    a7,@IRQSKYE
         00002e70 00000000! 
     953                    
     954                    
     955 00002e90     09e4          movi    FADERAM,a4
         00002ea0 00001950- 
     956 00002ec0     09e1          movi    PALRAM,a1
         00002ed0 00000050- 
     957 00002ef0     09c3          movi    NUMPAL,a3
         00002f00     0050  
     958 00002f10           pryvnext_pal
     959 00002f10     9622          move    *a1+,a2,L       ;Get *palette
     960 00002f20     ca2b          jrz     pryvempty_pal
     961                    
     962 00002f30     07a7          move    @fade_list,a7,L
         00002f40 00000030- 
     963 00002f60     ca05          jrz     pryvskip_check
     964 00002f70     c002          jruc    pryvstart
     965                    
     966 00002f80           pryvnext_check
     967 00002f80     4922          cmp     a9,a2
     968 00002f90     ca24          jreq    pryvdone                ;skip this palette
     969 00002fa0           pryvstart
     970 00002fa0     96e9          move    *a7+,a9,L
     971 00002fb0     cbfc          jrnz    pryvnext_check
     972                    
     973 00002fc0           pryvskip_check
     974                    
     975 00002fc0     9445          move    *a2+,a5         ;Number colours in palette
     976 00002fd0     4ca8          move    a5,a8
     977 00002fe0     4c86          move    a4,a6
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE   21

     978                    
     979 00002ff0           pryvcopy_loop
     980 00002ff0     944b          move    *a2+,a11
     981 00003000     1be7          movk    01fH,a7
     982 00003010     5167          and     a11,a7          ;A7  = Blue
     983 00003020     2f6b          srl     5,a11
     984 00003030     1be9          movk    01fH,a9
     985 00003040     5169          and     a11,a9          ;A9  = Green
     986 00003050     2f6b          srl     5,a11           ;A11 = Red
     987                    
     988 00003060     5f47          mpyu    a10,a7          ; X (0 - 32)
     989 00003070     2f07          srl     8,a7            ;/256
     990 00003080     5f49          mpyu    a10,a9
     991 00003090     2f09          srl     8,a9
     992 000030a0     5f4b          mpyu    a10,a11
     993 000030b0     2f0b          srl     8,a11
     994                    
     995 000030c0     254b          sll     10,a11          ;red
     996 000030d0     5567          or      a11,a7
     997 000030e0     24a9          sll     5,a9            ;green
     998 000030f0     5527          or      a9,a7
     999                    
    1000 00003100     90e6          move    a7,*a6+         ;1 word
    1001                    
    1002 00003110     3e68          dsj     a8,pryvcopy_loop
    1003                    
    1004                    
    1005 00003120                   PUSH    a1,a2
    1006 00003140     4c80          move    a4,a0           ;* colour data
    1007 00003150     09c1          movi    NUMPAL,a1
         00003160     0050  
    1008 00003170     4461          sub     a3,a1           ;dest palette ( 0 - NUMPAL-1 )
    1009 00003180     2501          sll     8,a1            ;
    1010 00003190     4ca2          move    a5,a2           ;# colours
    1011 000031a0     0d3f          callr   pal_set
         000031b0     fd77  
    1012 000031c0                   PULL    a1,a2
    1013 000031e0           pryvdone
    1014 000031e0           pryvempty_pal
    1015 000031e0     0b04          addi    FPALSZ,a4
         000031f0     1000  
    1016 00003200     0d83          dsj     a3,pryvnext_pal
         00003210     ffcf  
    1017                    
    1018 00003220                   SLEEPK  1
    1019                    
    1020 00003260     05a0          move    @fade_start,a0
         00003270 00000000- 
    1021 00003290     05a1          move    @fade_end,a1
         000032a0 00000010- 
    1022 000032c0     4801          cmp     a0,a1
    1023 000032d0     c309          jrhi    pryvfading_up
    1024                                                    ;fading_down
    1025 000032e0     05a0          move    @fade_inc,a0    ;signed inc
         000032f0 00000020- 
TMS340 COFF Macro Assembler Version 6.10     Mon Oct 30 16:53:58 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

palette allocator and fader control                                  PAGE   22

    1026 00003310     440a          sub     a0,a10
    1027 00003320     482a          cmp     a1,a10
    1028 00003330     c59f          jrge    pryvfade_loop
    1029                    
    1030 00003340                   DIE
    1031                    
    1032 00003370           pryvfading_up
    1033 00003370     05a0          move    @fade_inc,a0    ;signed inc
         00003380 00000020- 
    1034 000033a0     400a          add     a0,a10
    1035 000033b0     482a          cmp     a1,a10
    1036 000033c0     c296          jrls    pryvfade_loop
    1037                    
    1038 000033d0                   DIE
    1039                    
    1040                    
    1041                    
    1042                            .end

 No Errors,  No Warnings
