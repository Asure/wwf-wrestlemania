TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

                                                                     PAGE    1

       1                    *ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
       2                    *³                                                                      ³
       3                    *³ File         :       display.asm                                     ³
       4                    *³ Contents     :       DMA object handler                              ³
       5                    *³ Project      :       WWF Wrestlemania                                ³
       6                    *³ Programmer   :                                                       ³
       7                    *³                                                                      ³
       8                    *³ COPYRIGHT (C) 1993 WILLIAMS ELECTRONICS GAMES, INC.                  ³
       9                    *³                                                                      ³
      10                    *ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
      11                    *************************************************************************
      12                    
      13                            .file   "display.asm"
      15                            .width  132
      16                            .option b,d,l,t
      17                            .mnolist
      18                    
      19                    
      20                            .include        "gsp.equ"
      21                            .include        "sys.equ"
      22                            .include        "mproc.equ"
      23                            .include        "display.equ"
      24                            .include        "macros.h"
      25                            .include        "fontsimg.glo"
      26                            .include        "game.equ"
      27                            .INCLUDE        "PLYR.EQU"
      28                    
      29                    ******************************************************************************
      30                    * EXTERNAL REFERENCES
      31                    
      32                            .REF    process_ptrs
      33                            .ref    special_screen
      34                            .REF    DUMRETS,WHICH_SCREEN
      35                            .REF    TOP_LEFT,BOT_RIGHT
      36                            .def    clear_objs
      37                            .ref    FRANIMQ
      38                            .ref    HALT
      39                            .ref    SYSCOPY
      40                            .ref    pal_getf
      41                            .ref    IRQSKYE
      42                    
      43                    ******************************************************************************
      44                    
      45                    ;global variables
      46                    
      47 00000000                   .sect   "OFIXED"
      48                    
      49 00000000 00000000  OBJLST          .long   0       ;*Active object list
      50 00000020 00000000  OFREE           .long   0       ;*Free object block
      51 00000040 00000000  BAKLST          .long   0       ;*Background list
      52                    
      53                    
      54                    
      55              004c  GND_Y           .equ    116-40
      56              0074  GNDI_Y          .equ    116
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE    2

      57              04fd  GNDI_W          .equ    1277
      58              008a  GNDI_H          .equ    138
      59              00b2  GND_H           .equ    GNDI_H+40
      60              037e  GZBASE          .equ    894
      61                    
      62                    
      63 00000000                   .bss    present_pos,16
      64 00000060                   BSSX    page_addr,32
      65                    
      66 00000030                   .bss    SCROLLX         ,32     ;X scroll value
      67 00000050                   .bss    SCROLLY         ,32     ;Y scroll value
      68                                                            ;/ Must stay in order
      69 00000070                   .bss    WORLDTLX        ,32     ;Left X screen coord (16:16)
      70 00000090                   .bss    WORLDTLY        ,32     ;Top Y screen coord (16:16)
      71 000000b0                   .bss    WORLDTL         ,32     ;Top left world Y:X
      72                    
      73 000000d0                   .bss    SCRNTL          ,32     ;TOP LEFT [Y,X] SCREEN (SCRN COORD.)
      74 000000f0                   .bss    SCRNLR          ,32     ;LOWER RIGHT [Y,X] SCREEN (SCRN COORD.)
      75                    
      76 00000110                   .bss    dpage           ,16     ;Display page; 0=Page0, -1=Page1
      77 00000060                   BSSX    dtype           ,16     ;Display type; 0=2D, 1=3D, -=Special
      78 00000060                   BSSX    dcode_p         ,32     ;!0=*Special code (^ must = neg)
      79 00000150                   .bss    DMAQCUR         ,32     ;Misc DMAQ position
      80                    
      81 00000170                   .bss    OBJSTR,NOBJ*OBSIZ       ;Object structure mem
      82                    
      83          00016e00  QSIZE   .set    (NOBJ+GNDI_H)*BQCELL
      84          00010680  QMSIZE  .set    NOBJ*BQCELL
      85 000340b0                   .bss    dmaq0           ,QSIZE  ;Main DMA queue
      86 00000060                   BSSX    DMAQ            ,QMSIZE ;Misc DMA queue
      87                    
      88 00000060                   BSSX    gndstat         ,16     ;!0=Show ground
      89 00000060                   BSSX    gndpos_t        ,16*GND_H
      90 00000060                   BSSX    gndx            ,32
      91 0005c080                   .bss    DISPLAYON       ,16     ;!0=Do display processing
      92                    ;       BSSX    QDMAFLG         ,16     ;!0=Misc DMAQ being updated
      93                    
      94 00000060                   BSSX    _3dstat         ,16     ;!0=Show polygons
      95                    
      96 00000060                   BSSX    dma_foo         ,32
      97                    
      98 00000000                   .text
      99                    
     100                    
     101                    ******************************************************************************
     102                    * NO CODE BEFORE DMA INT!!! (Cache aligned)
     103                    *
     104                    *****************************************************************************
     105                    * DMA interrupt
     106                    * B12=*End of DMA regs
     107                    * B13=DMAQ count-1 or Neg
     108                    * B14=*Next DMAQ fetch
     109                    
     110                    
     111 00000000            SUBR   dma_irq
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE    3

     112                    
     113                            ;temp!
     114                    ;       move    b14,@dma_foo,L
     115                    
     116 00000000     abdc          move    -*b14,-*b12,L           ;[Y SCALE : X SCALE]
     117 00000010     abdc          move    -*b14,-*b12,L           ;[COLOR CONST : PAL REGISTER]
     118 00000020     abdc          move    -*b14,-*b12,L           ;[HEIGHT : WIDTH]
     119 00000030     abdc          move    -*b14,-*b12,L           ;[DEST Y : DEST X]
     120 00000040     abdc          move    -*b14,-*b12,L           ;[SOURCE ADDRESS]
     121 00000050     abdc          move    -*b14,-*b12,L           ;[CNTRL REG-DMA go! : OFFSET/CLIP]
     122                    
     123 00000060     0b1c          addi    0c0h,b12                ;DMAREGS (End of DMA)
         00000070     00c0  
     124 00000080     143d          subk    1,b13
     125 00000090     ce09          jrn     nijxdone                        ;Queue empty?
     126 000000a0     0940          RETI
     127                    
     128 000000b0                   push    b11
     129 000000c0     05bb          move    @present_pos,b11
         000000d0 00000000- 
     130 000000f0     497d          cmp     b11,b13
     131 00000100     ca09          jreq    do_shadows
     132 00000110                   pull    b11
     133 00000120     0940          reti
     134                    
     135 00000130           nijxdone
     136 00000130     0541          setf    1,0,0                   ;Disable dma interrupt
     137 00000140     059c          move    b12,@INTENB+1           ;Clr X1E
         00000150 c0000111  
     138 00000170     57bd          clr     b13                     ;For safety!
     139 00000180     143d          subk    1,b13                   ;-1
     140 00000190     0940          reti
     141                    
     142 000001a0           do_shadows
     143 000001a0                   pull    b11
     144 000001b0     01e0          pushst
     145 000001c0     0360          dint
     146 000001d0     0d3f          callr   PLACE_SHADOWS
         000001e0     07df  
     147 000001f0     01c0          popst
     148 00000200     0940          reti
     149                    
     150                    
     151                    *****************************************************************************
     152                    * Load DMA Q from obj list (2D type)
     153                    * A0=*Obj list
     154                    * A4=*DMAQ next free spot
     155                    * A13=Screen BR, A14=Screen TL
     156                    * B2=Y offset for top of page : XPad offset
     157                    * B4=World Y:X
     158                    * B5=OFLAGS offset
     159                    * B6=World center scrn X * 64K
     160                    * B11=*DMACTRL
     161                    
     162 00000210           dma_objlst2d
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE    4

     163                    ;       movi    [100h,100h],a5          ;A5=Y:X scale
     164 00000210     c000          jruc    lwyxnxt
         00000220     0093  
     165                    
     166                            .align
     167                    
     168 00000400           lwyxlp
     169 00000400     b401          MOVE    *A0(OFLAGS),A1
         00000410     00e0  
     170 00000420     1f01          BTST    B_NODISP,A1
     171 00000430     cb72          JRNZ    lwyxnxt
     172 00000440     b605          move    *a0(OSCALE),a5,L
         00000450     0240  
     173                    
     174 00000460     4eb3          move    b5,a3
     175 00000470     4003          add     a0,a3
     176 00000480     9461          move    *a3+,a1                 ;Get OFLAGS
     177 00000490     09a3          mmfm    a3,a12,a11,a9,a8
         000004a0     1b00  
     178                    
     179 000004b0     b60a          move    *a0(OYVAL),a10,L        ;Get int Y
         000004c0     00a0  
     180                    
     181 000004d0     b402          move    *a0(OXPOS),a2           ;X
         000004e0     0090  
     182 000004f0     ec4a          movx    a2,a10                  ;A10=Obj Y:X
     183 00000500     1e41          btst    B_SCRNREL,a1
     184 00000510     cb02          jrnz    lwyxnoscl                       ;Screen relative XY?
     185 00000520     4e96          move    b4,a6                   ;A6=World TL Y:X
     186 00000530     e2ca          subxy   a6,a10                  ;-world coord to get screen coord
     187 00000540           lwyxnoscl
     188                                                            ;A8=Const:PAL
     189                                                            ;A9=HEIGHT:WIDTH
     190                                                            ;A10=Dest Y:X
     191                                                            ;A11=*SAG
     192                                                            ;A12=Offset:Ctrl
     193                    
     194 00000540     1e21          btst    B_BOBJ,a1
     195 00000550     cb0a          jrnz    lwyxis_bgnd_obj
     196                    
     197 00000560     b603          move    *a0(ODOFF),a3,L         ;display offset Y:X
         00000570     0220  
     198                    
     199 00000580     1f6c          btst    B_FLIPH,a12
     200 00000590     ca05          jrz     lwyxno_x_flip0
     201                    
     202 000005a0     ec62          movx    a3,a2
     203 000005b0     03a2          neg     a2
     204 000005c0     1422          dec     a2              ; -1
     205 000005d0     e122          addxy   a9,a2           ;- image width (gets added later)
     206 000005e0     ec43          movx    a2,a3
     207                    
     208 000005f0           lwyxno_x_flip0
     209                    
     210                    ;       btst    B_FLIPV,a12
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE    5

     211                    ;       jrz     lwyxno_y_flip0
     212                    ;
     213                    ;       move    a3,a2
     214                    ;       srl     16,a2
     215                    ;       neg     a2
     216                    ;       dec     a2              ; -1
     217                    ;       sll     16,a2
     218                    ;       addxy   a9,a2           ;- image height (gets added later)
     219                    ;       movy    a2,a3
     220                    ;
     221                    ;lwyxno_y_flip0
     222                    
     223 000005f0     e26a          subxy   a3,a10
     224                    
     225                    
     226 00000600           lwyxis_bgnd_obj
     227                    
     228                    
     229                    
     230                    ;Check for flipping, clipping, adjust offset, sag
     231                    
     232                                                    ;Calc top,bot,left,right clips
     233                                                    ;a2 = BR clip size
     234 00000600     5663          clr     a3              ;a3 = TL clip size
     235 00000610     4d42          move    a10,a2          ;Dest Y:X
     236 00000620     e122          addxy   a9,a2           ; + HEIGHT:WIDTH = BR Y:X
     237 00000630     e3a2          subxy   a13,a2          ;A2=BR clip size
     238 00000640                   JRYGE   lwyxclip_bot
     239 00000650     ee62          movy    a3,a2           ;no bot clip if y neg
     240 00000660           lwyxclip_bot
     241 00000660                   JRXGE   lwyxclip_right
     242 00000670     ec62          movx    a3,a2           ;no right clip if x neg
     243 00000680           lwyxclip_right
     244                    
     245 00000680     4dc7          move    a14,a7          ;screen TL
     246 00000690     e347          subxy   a10,a7          ; - DEST Y:X = TL clip size
     247 000006a0                   JRYLT   lwyxno_top_clip
     248 000006b0     eee3          movy    a7,a3           ;Top clip size
     249 000006c0     1f0c          btst    7,a12           ;zero compression on?
     250 000006d0     cb01          jrnz    lwyxno_top_clip ;can't clip if it is
     251 000006e0     efca          movy    a14,a10         ;Y start = window top edge
     252                    
     253 000006f0           lwyxno_top_clip
     254 000006f0                   JRXLT   lwyxno_left_clip
     255 00000700     ece3          movx    a7,a3           ;Left clip size
     256 00000710     1f0c          btst    7,a12
     257 00000720     cb01          jrnz    lwyxno_left_clip        ;Zero compression on?
     258 00000730     edca          movx    a14,a10         ;X start = window left edge
     259                    
     260 00000740           lwyxno_left_clip
     261 00000740     4e40          move    a2,b0           ;Save BR clip
     262 00000750     4062          add     a3,a2           ;TL clip + BR clip
     263                            ;no need to use addxy as no signs + this sets Z for both
     264                    
     265 00000760     ca25          jrz     lwyxnoclip              ;Zero clip?
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE    6

     266                    
     267                    
     268 00000770     4d26          move    a9,a6           ;Save HEIGHT:WIDTH
     269                    
     270 00000780     e249          subxy   a2,a9           ;Get clipped size
     271 00000790     c43c          JRXLE   lwyxnxt         ;Totally clipped?
     272 000007a0     c23b          JRYLE   lwyxnxt
     273                    
     274 000007b0     1f0c          btst    7,a12
     275 000007c0     ca02          jrz     lwyxnozc                ;Zero compression off?
     276 000007d0     4cc9          move    a6,a9           ;Restore v:h size
     277 000007e0     c01d          jruc    lwyxnoclip
     278                    
     279 000007f0           lwyxnozc
     280 000007f0     5621          clr     a1
     281 00000800     ec41          movx    a2,a1           ;x clip total
     282 00000810     4c21          move    a1,a1
     283 00000820     ca03          jrz     lwyxno_x_clip
     284 00000830     ed21          movx    a9,a1           ;image width
     285 00000840     1501          subk    8,a1
     286 00000850     c630          jrle    lwyxnxt         ;<=8 wide? Skip so DMA doesn't lockup
     287                    
     288 00000860           lwyxno_x_clip
     289 00000860     ecc9          movx    a6,a9           ;Restore hsize
     290                    
     291 00000870     ec61          movx    a3,a1           ;A1=Left clip
     292                    
     293                    
     294 00000880     1f6c          btst    B_FLIPH,a12
     295 00000890     ca04          jrz     lwyxno_x_flip
     296                    
     297 000008a0     e22a          subxy   a1,a10          ;Original X
     298                    
     299 000008b0     4e11          move    b0,a1           ;LClip=RClip
     300 000008c0     0521          zext    a1,W            ;clear Y portion
     301 000008d0     e22a          subxy   a1,a10          ;X-RClip
     302                    
     303                    
     304 000008e0           lwyxno_x_flip
     305                    ;       btst    B_FLIPV,a12
     306                    ;       jrz     lwyxno_y_flip
     307                    ;
     308                    ;       move    b0,a3           ;Bot clip
     309                    ;
     310                    ;lwyxno_y_flip
     311 000008e0     2e03          srl     16,a3           ;A3=Top or bot clip
     312 000008f0     ca02          jrz     lwyxt0
     313 00000900     0526          zext    a6,W            ;clear Y portion
     314 00000910     5ec3          mpyu    a6,a3           ;T or B clip * width
     315                    
     316                    
     317 00000920           lwyxt0
     318 00000920     4023          add     a1,a3           ;Add x clip + y clip * width
     319 00000930     4d81          move    a12,a1
     320 00000940     2621          sll     32-15,a1        ;Get bits 12-14 (PIXEL SIZE)
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE    7

     321 00000950     2c61          srl     32-15+12,a1
     322 00000960     cb01          jrnz    lwyxnot8
     323 00000970     1901          movk    8,a1
     324 00000980     5c23  lwyxnot8        mpys    a1,a3           ;# of bits to skip
     325 00000990     406b          add     a3,a11          ;Add to SAG
     326 000009a0     2602          sll     16,a2
     327 000009b0     e04c          addxy   a2,a12          ;Add clip offset to offset
     328                    
     329                    
     330 000009c0           lwyxnoclip
     331                    
     332                    ;if image is flipped, dma plots from opposite end
     333                    
     334 000009c0     1f6c          btst    B_FLIPH,a12
     335 000009d0     ca04          jrz     lwyx300
     336 000009e0     ed21          movx    a9,a1                   ;image WIDTH
     337 000009f0     1421          subk    1,a1
     338 00000a00     0521          zext    a1
     339 00000a10     e02a          addxy   a1,a10                  ;+ WIDTH-1
     340                    
     341 00000a20           lwyx300
     342                    ;       btst    B_FLIPV,a12
     343                    ;       jrz     lwyx400
     344                    ;       move    a9,a1                   ;image HEIGHT
     345                    ;       srl     16,a1
     346                    ;       subk    1,a1
     347                    ;       sll     16,a1
     348                    ;       addxy   a1,a10                  ;+ HEIGHT-1
     349                    ;lwyx400
     350                    
     351 00000a20     4e51          move    b2,a1
     352 00000a30     e02a          addxy   a1,a10                  ;Add the page y offset : XPad
     353 00000a40     320c          rl      16,a12                  ;Flip ctrl & offset
     354 00000a50     0984          mmtm    a4,a5,a8,a9,a10,a11,a12 ;Save the dma regs
         00000a60     04f8  
     355 00000a70     103d          addk    1,b13                   ;+1 Q cnt
     356 00000a80     c70d          jrgt    lwyxnxt                 ;DMA going?
     357                    
     358 00000a90     0360          dint
     359                    
     360 00000aa0     0541          setf    1,0,0                   ;0EHnable DMA int
     361 00000ab0     1821          movk    1,a1
     362 00000ac0     0581          move    a1,@INTENB+1            ;X1E
         00000ad0 c0000111  
     363 00000af0     0570          setf    16,1,0
     364                    
     365 00000b00     8570          move    *b11,b0
     366 00000b10     ce03          jrn     lwyxdmaok                       ;DMA busy?
     367                    
     368 00000b20     4dbd          move    b13,b13
     369 00000b30     ce01          jrn     lwyxdmaok                       ;DMA int done?
     370                    
     371 00000b40     0901          trap    1                       ;Cause DMA int
     372                    
     373 00000b50     0d60  lwyxdmaok       eint
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE    8

     374 00000b60           lwyxnxt
     375 00000b60     8600          move    *a0,a0,L                ;Get next link
     376 00000b70     cb88          jrnz    lwyxlp                  ;More?
     377 00000b80     0960          rets
     378                    
     379                            .if     0
     380                    
     381                    *****************************************************************************
     382                    * Load DMA Q from obj list (3D type)
     383                    * A0=*Obj list
     384                    * A4=*DMAQ next free spot
     385                    * A13=Screen BR, A14=Screen TL
     386                    * B2=Y offset for top of page : XPad offset
     387                    * B4=World Y:X
     388                    * B5=OFLAGS offset
     389                    * B6=World center scrn X * 64K
     390                    * B11=*DMACTRL
     391                    
     392                    dma_objlst3d
     393                            movi    [100h,100h],a5          ;A5=Y:X scale
     394                            jruc    itymnxt
     395                    
     396                            .align
     397                    
     398                    itymlp
     399                            move    b5,a3
     400                            add     a0,a3
     401                            move    *a3+,a1                 ;Get OFLAGS
     402                            mmfm    a3,a12,a11,a9,a8
     403                    
     404                            move    *a0(OYVAL),a10,L        ;Get int Y
     405                    
     406                            move    *a0(OXPOS),a2           ;X
     407                            movx    a2,a10                  ;A10=Obj Y:X
     408                            btst    B_SCRNREL,a1
     409                            jrnz    itymnoscl                       ;Screen relative XY?
     410                            move    b4,a6                   ;A6=World TL Y:X
     411                            subxy   a6,a10                  ;-world coord to get screen coord
     412                    itymnoscl
     413                                                            ;A8=Const:PAL
     414                                                            ;A9=HEIGHT:WIDTH
     415                                                            ;A10=Dest Y:X
     416                                                            ;A11=*SAG
     417                                                            ;A12=Offset:Ctrl
     418                    
     419                            btst    B_BOBJ,a1
     420                            jrnz    itymis_bgnd_obj
     421                    
     422                            move    *a0(ODOFF),a3,L         ;display offset Y:X
     423                    
     424                            btst    B_FLIPH,a12
     425                            jrz     itymno_x_flip0
     426                    
     427                            movx    a3,a2
     428                            neg     a2
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE    9

     429                            dec     a2              ; -1
     430                            addxy   a9,a2           ;- image width (gets added later)
     431                            movx    a2,a3
     432                    
     433                    itymno_x_flip0
     434                    
     435                            btst    B_FLIPV,a12
     436                            jrz     itymno_y_flip0
     437                    
     438                            move    a3,a2
     439                            srl     16,a2
     440                            neg     a2
     441                            dec     a2              ; -1
     442                            sll     16,a2
     443                            addxy   a9,a2           ;- image height (gets added later)
     444                            movy    a2,a3
     445                    
     446                    itymno_y_flip0
     447                    
     448                            subxy   a3,a10
     449                    
     450                    
     451                    itymis_bgnd_obj
     452                    
     453                    
     454                    
     455                    ;Check for flipping, clipping, adjust offset, sag
     456                    
     457                                                    ;Calc top,bot,left,right clips
     458                                                    ;a2 = BR clip size
     459                            clr     a3              ;a3 = TL clip size
     460                            move    a10,a2          ;Dest Y:X
     461                            addxy   a9,a2           ; + HEIGHT:WIDTH = BR Y:X
     462                            subxy   a13,a2          ;A2=BR clip size
     463                            JRYGE   itymclip_bot
     464                            movy    a3,a2           ;no bot clip if y neg
     465                    itymclip_bot
     466                            JRXGE   itymclip_right
     467                            movx    a3,a2           ;no right clip if x neg
     468                    itymclip_right
     469                    
     470                            move    a14,a7          ;screen TL
     471                            subxy   a10,a7          ; - DEST Y:X = TL clip size
     472                            JRYLT   itymno_top_clip
     473                            movy    a7,a3           ;Top clip size
     474                            btst    7,a12           ;zero compression on?
     475                            jrnz    itymno_top_clip ;can't clip if it is
     476                            movy    a14,a10         ;Y start = window top edge
     477                    
     478                    itymno_top_clip
     479                            JRXLT   itymno_left_clip
     480                            movx    a7,a3           ;Left clip size
     481                            btst    7,a12
     482                            jrnz    itymno_left_clip        ;Zero compression on?
     483                            movx    a14,a10         ;X start = window left edge
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   10

     484                    
     485                    itymno_left_clip
     486                            move    a2,b0           ;Save BR clip
     487                            add     a3,a2           ;TL clip + BR clip
     488                            ;no need to use addxy as no signs + this sets Z for both
     489                    
     490                            jrz     itymnoclip              ;Zero clip?
     491                    
     492                    
     493                            move    a9,a6           ;Save HEIGHT:WIDTH
     494                    
     495                            subxy   a2,a9           ;Get clipped size
     496                            JRXLE   itymnxt         ;Totally clipped?
     497                            JRYLE   itymnxt
     498                    
     499                            btst    7,a12
     500                            jrz     itymnozc                ;Zero compression off?
     501                            move    a6,a9           ;Restore v:h size
     502                            jruc    itymnoclip
     503                    
     504                    itymnozc
     505                            clr     a1
     506                            movx    a2,a1           ;x clip total
     507                            move    a1,a1
     508                            jrz     itymno_x_clip
     509                            movx    a9,a1           ;image width
     510                            subk    8,a1
     511                            jrle    itymnxt         ;<=8 wide? Skip so DMA doesn't lockup
     512                    
     513                    itymno_x_clip
     514                            movx    a6,a9           ;Restore hsize
     515                    
     516                            movx    a3,a1           ;A1=Left clip
     517                    
     518                    
     519                            btst    B_FLIPH,a12
     520                            jrz     itymno_x_flip
     521                    
     522                            subxy   a1,a10          ;Original X
     523                    
     524                            move    b0,a1           ;LClip=RClip
     525                            zext    a1,W            ;clear Y portion
     526                            subxy   a1,a10          ;X-RClip
     527                    
     528                    
     529                    itymno_x_flip
     530                            btst    B_FLIPV,a12
     531                            jrz     itymno_y_flip
     532                    
     533                            move    b0,a3           ;Bot clip
     534                    
     535                    itymno_y_flip
     536                            srl     16,a3           ;A3=Top or bot clip
     537                            jrz     itymt0
     538                            zext    a6,W            ;clear Y portion
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   11

     539                            mpyu    a6,a3           ;T or B clip * width
     540                    
     541                    
     542                    itymt0
     543                            add     a1,a3           ;Add x clip + y clip * width
     544                            move    a12,a1
     545                            sll     32-15,a1        ;Get bits 12-14 (PIXEL SIZE)
     546                            srl     32-15+12,a1
     547                            jrnz    itymnot8
     548                            movk    8,a1
     549                    itymnot8        mpys    a1,a3           ;# of bits to skip
     550                            add     a3,a11          ;Add to SAG
     551                            sll     16,a2
     552                            addxy   a2,a12          ;Add clip offset to offset
     553                    
     554                    
     555                    itymnoclip
     556                    
     557                    ;if image is flipped, dma plots from opposite end
     558                    
     559                            btst    B_FLIPH,a12
     560                            jrz     itym300
     561                            movx    a9,a1                   ;image WIDTH
     562                            subk    1,a1
     563                            zext    a1
     564                            addxy   a1,a10                  ;+ WIDTH-1
     565                    
     566                    itym300
     567                            btst    B_FLIPV,a12
     568                            jrz     itym400
     569                            move    a9,a1                   ;image HEIGHT
     570                            srl     16,a1
     571                            subk    1,a1
     572                            sll     16,a1
     573                            addxy   a1,a10                  ;+ HEIGHT-1
     574                    itym400
     575                    
     576                    
     577                            move    b2,a1
     578                            addxy   a1,a10                  ;Add the page y offset : XPad
     579                            rl      16,a12                  ;Flip ctrl & offset
     580                            mmtm    a4,a5,a8,a9,a10,a11,a12 ;Save the dma regs
     581                            addk    1,b13                   ;+1 Q cnt
     582                            jrgt    itymnxt                 ;DMA going?
     583                    
     584                            dint
     585                    
     586                            setf    1,0,0                   ;0EHnable DMA int
     587                            movk    1,a1
     588                            move    a1,@INTENB+1            ;X1E
     589                            setf    16,1,0
     590                    
     591                            move    *b11,b0
     592                            jrn     itymdmaok                       ;DMA busy?
     593                    
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   12

     594                            move    b13,b13
     595                            jrn     itymdmaok                       ;DMA int done?
     596                    
     597                            trap    1                       ;Cause DMA int
     598                    
     599                    itymdmaok       eint
     600                    itymnxt
     601                            move    *a0,a0,L                ;Get next link
     602                            jrnz    itymlp                  ;More?
     603                            rets
     604                    
     605                            .endif
     606                    
     607                    
     608                    *****************************************************************************
     609                    * Load DMA Q from obj list
     610                    * A0=*Obj list
     611                    * A4=*DMAQ next free spot
     612                    * A13=Screen BR, A14=Screen TL
     613                    * B2=Y offset for top of page : XPad offset
     614                    * B4=World Y:X
     615                    * B5=OFLAGS offset
     616                    * B6=World center scrn X * 64K
     617                    * B11=*DMACTRL
     618                    
     619 00000b90           dma_background
     620                    
     621 00000b90     09e5          movi    [100h,100h],a5          ;A5=Y:X scale
         00000ba0 01000100  
     622 00000bc0     c071          jruc    jvtsnxt
     623                    
     624                            .align
     625                    
     626 00000c00           jvtslp
     627 00000c00     4eb3          move    b5,a3
     628 00000c10     4003          add     a0,a3
     629 00000c20     9461          move    *a3+,a1                 ;Get OFLAGS
     630 00000c30     09a3          mmfm    a3,a12,a11,a9,a8
         00000c40     1b00  
     631                    
     632 00000c50     b60a          move    *a0(OYVAL),a10,L        ;Get int Y
         00000c60     00a0  
     633                    
     634 00000c70     b402          move    *a0(OXPOS),a2           ;X
         00000c80     0090  
     635 00000c90     ec4a          movx    a2,a10                  ;A10=Obj Y:X
     636 00000ca0     1e41          btst    B_SCRNREL,a1
     637 00000cb0     cb02          jrnz    jvtsnoscl                       ;Screen relative XY?
     638 00000cc0     4e96          move    b4,a6                   ;A6=World TL Y:X
     639 00000cd0     e2ca          subxy   a6,a10                  ;-world coord to get screen coord
     640 00000ce0           jvtsnoscl
     641                                                            ;A8=Const:PAL
     642                                                            ;A9=HEIGHT:WIDTH
     643                                                            ;A10=Dest Y:X
     644                                                            ;A11=*SAG
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   13

     645                                                            ;A12=Offset:Ctrl
     646                    
     647                    ;Check for flipping, clipping, adjust offset, sag
     648                    
     649                                                    ;Calc top,bot,left,right clips
     650 00000ce0     5663          clr     a3              ;A3=TL clip size
     651 00000cf0     4d42          move    a10,a2          ;Dest Y:X
     652 00000d00     e122          addxy   a9,a2           ; + HEIGHT:WIDTH = BR Y:X
     653 00000d10     e3a2          subxy   a13,a2          ;A2=BR clip size
     654 00000d20                   JRYGE   jvtsclip_bot
     655 00000d30     ee62          movy    a3,a2           ;no bot clip if y neg
     656 00000d40           jvtsclip_bot
     657 00000d40                   JRXGE   jvtsclip_right
     658 00000d50     ec62          movx    a3,a2           ;no right clip if x neg
     659 00000d60           jvtsclip_right
     660                    
     661 00000d60     4dc7          move    a14,a7          ;screen TL
     662 00000d70     e347          subxy   a10,a7          ; - DEST Y:X = TL clip size
     663 00000d80                   JRYLT   jvtsno_top_clip
     664 00000d90     eee3          movy    a7,a3           ;Top clip size
     665 00000da0     1f0c          btst    7,a12           ;zero compression on?
     666 00000db0     cb01          jrnz    jvtsno_top_clip ;can't clip if it is
     667 00000dc0     efca          movy    a14,a10         ;Y start = window top edge
     668                    
     669 00000dd0           jvtsno_top_clip
     670 00000dd0                   JRXLT   jvtsno_left_clip
     671 00000de0     ece3          movx    a7,a3           ;Left clip size
     672 00000df0     1f0c          btst    7,a12
     673 00000e00     cb01          jrnz    jvtsno_left_clip        ;Zero compression on?
     674 00000e10     edca          movx    a14,a10         ;X start = window left edge
     675                    
     676 00000e20           jvtsno_left_clip
     677 00000e20     4e40          move    a2,b0           ;Save
     678 00000e30     4062          add     a3,a2           ;TL clip+BR clip
     679 00000e40     ca28          jrz     jvtsnoclip              ;Zero clip?
     680                    
     681                    
     682 00000e50     4d26          move    a9,a6           ;Save HEIGHT:WIDTH
     683                    
     684 00000e60     e249          subxy   a2,a9           ;Get clipped size
     685 00000e70     c446          JRXLE   jvtsnxt         ;Totally clipped?
     686 00000e80     c245          JRYLE   jvtsnxt
     687                    
     688 00000e90     1f0c          btst    7,a12
     689 00000ea0     ca02          jrz     jvtsnozc                ;Zero compression off?
     690 00000eb0     4cc9          move    a6,a9           ;Restore v:h size
     691 00000ec0     c020          jruc    jvtsnoclip
     692                    
     693 00000ed0           jvtsnozc
     694 00000ed0     5621          clr     a1
     695 00000ee0     ec41          movx    a2,a1           ;x clip total
     696 00000ef0     4c21          move    a1,a1
     697 00000f00     ca03          jrz     jvtsno_x_clip
     698 00000f10     ed21          movx    a9,a1           ;image width
     699 00000f20     1501          subk    8,a1
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   14

     700 00000f30     c63a          jrle    jvtsnxt         ;<=8 wide? Skip so DMA doesn't lockup
     701                    
     702 00000f40           jvtsno_x_clip
     703 00000f40     ecc9          movx    a6,a9           ;Restore hsize
     704                    
     705 00000f50     ec61          movx    a3,a1           ;A1=Left clip
     706                    
     707                    
     708 00000f60     1f6c          btst    B_FLIPH,a12
     709 00000f70     ca04          jrz     jvtsno_x_flip
     710                    
     711 00000f80     e22a          subxy   a1,a10          ;Original X
     712                    
     713 00000f90     4e11          move    b0,a1           ;LClip=RClip
     714 00000fa0     0521          zext    a1
     715 00000fb0     e22a          subxy   a1,a10          ;X-RClip
     716                    
     717                    
     718 00000fc0           jvtsno_x_flip
     719 00000fc0     1f4c          btst    B_FLIPV,a12
     720 00000fd0     ca01          jrz     jvtsno_y_flip
     721                    
     722 00000fe0     4e13          move    b0,a3           ;Bot clip
     723                    
     724 00000ff0           jvtsno_y_flip
     725 00000ff0     2e03          srl     16,a3           ;A3=Top or bot clip
     726 00001000     ca02          jrz     jvtst0
     727 00001010     0526          zext    a6
     728 00001020     5ec3          mpyu    a6,a3           ;T or B clip * total hsize
     729                    
     730                    
     731 00001030           jvtst0
     732 00001030     4023          add     a1,a3           ;Add left clip + tc*ths
     733 00001040     4d81          move    a12,a1
     734 00001050     2621          sll     32-15,a1        ;Get bits 12-14 (PIXEL SIZE)
     735 00001060     2c61          srl     32-15+12,a1
     736 00001070     cb01          jrnz    jvtsnot8
     737 00001080     1901          movk    8,a1
     738 00001090     5c23  jvtsnot8        mpys    a1,a3           ;# of bits to skip
     739 000010a0     406b          add     a3,a11          ;Add to SAG
     740 000010b0     2602          sll     16,a2
     741 000010c0     e04c          addxy   a2,a12          ;Add clip offset to offset
     742                    
     743                    
     744 000010d0           jvtsnoclip
     745                    
     746 000010d0     1f6c          btst    B_FLIPH,a12             ;if flipped, keep block
     747 000010e0     ca04          jrz     jvts300                 ;in same position
     748 000010f0     ed21          movx    a9,a1                   ;image WIDTH
     749 00001100     1421          subk    1,a1
     750 00001110     0521          zext    a1
     751 00001120     e02a          addxy   a1,a10
     752 00001130     1f4c  jvts300 btst    B_FLIPV,a12
     753 00001140     ca05          jrz     jvts400
     754 00001150     4d21          move    a9,a1                   ;image HEIGHT
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   15

     755 00001160     2e01          srl     16,a1
     756 00001170     1421          subk    1,a1
     757 00001180     2601          sll     16,a1
     758 00001190     e02a          addxy   a1,a10
     759 000011a0           jvts400
     760                    
     761                    
     762 000011a0     4e51          move    b2,a1
     763 000011b0     e02a          addxy   a1,a10                  ;Add the page y offset : XPad
     764 000011c0     320c          rl      16,a12                  ;Flip ctrl & offset
     765 000011d0     0984          mmtm    a4,a5,a8,a9,a10,a11,a12 ;Save the dma regs
         000011e0     04f8  
     766 000011f0     103d          addk    1,b13                   ;+1 Q cnt
     767 00001200     c70d          jrgt    jvtsnxt                 ;DMA going?
     768                    
     769 00001210     0360          dint
     770                    
     771 00001220     0541          setf    1,0,0                   ;0EHnable DMA int
     772 00001230     1821          movk    1,a1
     773 00001240     0581          move    a1,@INTENB+1            ;X1E
         00001250 c0000111  
     774 00001270     0570          setf    16,1,0
     775                    
     776 00001280     8570          move    *b11,b0
     777 00001290     ce03          jrn     jvtsdmaok                       ;DMA busy?
     778                    
     779 000012a0     4dbd          move    b13,b13
     780 000012b0     ce01          jrn     jvtsdmaok                       ;DMA int done?
     781                    
     782 000012c0     0901          trap    1                       ;Cause DMA int
     783                    
     784 000012d0     0d60  jvtsdmaok       eint
     785 000012e0           jvtsnxt
     786 000012e0     8600          move    *a0,a0,L                ;Get next link
     787 000012f0     cb90          jrnz    jvtslp                  ;More?
     788 00001300     0960          rets
     789                    
     790                    
     791                    *****************************************************************************
     792                    * Display object lists, called by DIRQ
     793                    
     794 00001310           DISPLAY
     795 00001310     05a0          move    @DISPLAYON,a0
         00001320 0005c080- 
     796 00001340     ca00          jrz     sadxnovel
         00001350     0086  
     797                    
     798 00001360     09fb          movi    DMACTRL,b11             ;B11=*DMACTRL
         00001370 01a00010  
     799                    
     800                    
     801                    ;this is for use on the pixel wash screen transition
     802 00001390     09f2          movi    [PAGE1YO,SCRNXP],b2
         000013a0 01000038  
     803 000013c0     09f3          movi    [509,256],b3            ;dma window [ bottom : top ]
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   16

         000013d0 01fd0100  
     804 000013f0     05a1          move    @special_screen,a1
         00001400 00000000! 
     805 00001420     cb0f          jrnz    sadxp1
     806                    
     807 00001430     09d2          movi    SCRNXP,b2               ;B2=Page y offset : XPad offset
         00001440     0038  
     808 00001450     09f3          movi    [253,0],b3              ;dma window [ bottom : top ]
         00001460 00fd0000  
     809                    
     810 00001480     05a1          move    @dpage,a1
         00001490 00000110- 
     811 000014b0     cb06          jrnz    sadxp1
     812 000014c0     09f2          movi    [PAGE1YO,SCRNXP],b2
         000014d0 01000038  
     813 000014f0     09f3          movi    [509,256],b3            ;dma window [ bottom : top ]
         00001500 01fd0100  
     814                    
     815 00001520           sadxp1
     816 00001520     0792          move    b2,@page_addr,L
         00001530 00000010- 
     817 00001550     09e4          movi    dmaq0+QSIZE,a4          ;A4=*DMAQ for new data (Top)
         00001560 0004aeb0- 
     818 00001580     57bd          clr     b13                     ;Kill DMA
     819 00001590     81bb          move    b13,*b11
     820 000015a0     81bb          move    b13,*b11
     821                    
     822 000015b0     09fc          movi    DMAREGS,b12             ;B12=*DMAREGS
         000015c0 01a000c0  
     823 000015e0     143d          subk    1,b13                   ;B13=Q count (-1)
     824 000015f0     4e8e          move    a4,b14                  ;B14=*DMAQ for next fetch (Top)
     825                    
     826                    ;------> SHAWN WAS SETTING DSZ (BIT6) ALSO  ???????????????
     827                    
     828 00001600     1810          movk    BIT5,b0                 ;DMAWIN (1 = BOTTOM:TOP)
     829 00001610     b01c          move    b0,*b12(30h)            ;DMACONF (Top/Bottom)
         00001620     0030  
     830 00001630     827c          move    b3,*b12,L               ;DMAWINDOW
     831                    
     832                    ;       move    @DISPLAYON,a0
     833                    ;       jrz     sadxdoff                        ;Stop DMA of objects except for score?
     834                    
     835 00001640     09f0          movi    WORLDTLX,b0             ;Left X screen coord (16:16)
         00001650 00000070- 
     836 00001670     9613          move    *b0+,b3,L               ;left x [16:16]
     837 00001680     9614          move    *b0+,b4,L               ;top y [16:16]
     838 00001690     2e13          srl     16,b3                   ;int left x
     839 000016a0     ec74          movx    b3,b4
     840 000016b0     8290          move    b4,*b0,L                ;top left world  [Y:X] (WORLDTL)
     841                    
     842 000016c0     09d5          movi    OFLAGS,b5               ;B5=Obj data offset
         000016d0     00e0  
     843 000016e0     4c96          move    b4,b6
     844 000016f0     0b16          addi    200,b6
         00001700     00c8  
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   17

     845 00001710     2616          sll     16,b6                   ;B6=World center scrn X * 64K
     846 00001720     07ad          move    @SCRNLR,a13,L           ;A13=Screen BR
         00001730 000000f0- 
     847 00001750     07ae          move    @SCRNTL,a14,L           ;A14=Screen TL
         00001760 000000d0- 
     848                    
     849 00001780     07a0          move    @TOP_LEFT,A0,L
         00001790 00000000! 
     850 000017b0     e00e          ADDXY   A0,A14
     851 000017c0     07a0          MOVE    @BOT_RIGHT,A0,L
         000017d0 00000000! 
     852 000017f0     e00d          ADDXY   A0,A13
     853                    
     854 00001800     09e0          movi    BAKLST,a0
         00001810 00000040+ 
     855 00001830     0d3f          callr   dma_background
         00001840     ff34  
     856                    
     857 00001850     059d          move    b13,@present_pos
         00001860 00000000- 
     858                    
     859 00001880     09e0          movi    OBJLST,a0
         00001890 00000000+ 
     860 000018b0     0d3f          callr   dma_objlst2d
         000018c0     fe94  
     861                    
     862 000018d0     07a0          MOVE    @WHICH_SCREEN,A0,L
         000018e0 00000000! 
     863 00001900     0920          CALL    A0
     864                    
     865 00001910           sadxdoff
     866 00001910     07a2          move    @DMAQCUR,a2,L
         00001920 00000150- 
     867 00001940     09e1          movi    DMAQ+QMSIZE,a1
         00001950 0005b530- 
     868 00001970     4822          cmp     a1,a2
     869 00001980     c91a          jrhs    sadxnoman                       ;Empty?
     870 00001990     0781          move    a1,@DMAQCUR,L           ;Reset top of queue
         000019a0 00000150- 
     871                    
     872 000019c0     4e55          move    b2,a5
     873                    
     874 000019d0     aa24  sadxlp  move    -*a1,-*a4,L             ;0CHopy manual DMAQ to end of Q
     875 000019e0     aa24          move    -*a1,-*a4,L
     876 000019f0     aa24          move    -*a1,-*a4,L
     877 00001a00     a620          move    -*a1,a0,L
     878 00001a10     e0a0          addxy   a5,a0                   ;+Y
     879 00001a20     a204          move    a0,-*a4,L
     880 00001a30     aa24          move    -*a1,-*a4,L
     881 00001a40     aa24          move    -*a1,-*a4,L
     882 00001a50     103d          addk    1,b13
     883 00001a60     4841          cmp     a2,a1
     884 00001a70     c3f5          jrhi    sadxlp
     885                    
     886                    
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   18

     887 00001a80     8570          move    *b11,b0
     888 00001a90     ce09          jrn     sadxnoman                       ;DMA busy?
     889                    
     890 00001aa0     4dbd          move    b13,b13
     891 00001ab0     ce07          jrn     sadxnoman                       ;DMA int done?
     892                    
     893 00001ac0     0541          setf    1,0,0                   ;0EHnable DMA int
     894 00001ad0     1821          movk    1,a1
     895 00001ae0     0581          move    a1,@INTENB+1            ;X1E
         00001af0 c0000111  
     896 00001b10     0570          setf    16,1,0
     897                    
     898 00001b20     0901          trap    1                       ;Cause DMA int
     899                    
     900 00001b30           sadxnoman
     901                    
     902 00001b30     05a0          move    @HALT,a0
         00001b40 00000000! 
     903 00001b60     cb05          jrnz    sadxnovel                       ;Skip vel update?
     904 00001b70     09e0          movi    OBJLST,a0
         00001b80 00000000+ 
     905 00001ba0     0d3f          callr   vel_add
         00001bb0     002e  
     906 00001bc0           sadxnovel
     907 00001bc0           sadxx
     908 00001bc0     0960          rets
     909                    
     910                    
     911                    ;Null dma data
     912 00001bd0 80000000  nulldma .long   080000000H,IROM,0,000010001H,0,01000100H
     913                    
     914                    
     915                    *****************************************************************************
     916                    * Velocity add loop
     917                    * A0=*Obj list
     918                    * Trashes A0-A7
     919                            .align
     920 00001e00     4c01  nktrlp  move    a0,a1
     921 00001e10     1001          addk    OXVEL,a1
     922                    
     923 00001e20     09a1          mmfm    a1,a2,a3,a4,a5,a6,a7    ;A7=XV, A6=YV, A5=ZV, A4=X, A3=Y, A2=Z
         00001e30     00fc  
     924                    
     925 00001e40     40a2          add     a5,a2                   ;Add ZVEL to Z
     926 00001e50     a241          move    a2,-*a1,L
     927 00001e60     40c3          add     a6,a3                   ;Add YVEL to Y (Uses hidden cycle!)
     928 00001e70     a261          move    a3,-*a1,L
     929 00001e80     40e4          add     a7,a4                   ;Add XVEL to X ^
     930 00001e90     a281          move    a4,-*a1,L
     931                    
     932 00001ea0     8600  vel_add move    *a0,a0,L
     933 00001eb0     cbf4          jrnz    nktrlp                  ;!End?
     934 00001ec0     0960          rets
     935                    
     936                    
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   19

     937                    
     938                    *****************************************************************************
     939                    * Manual DMA
     940                    * A1=Constant color:Palette
     941                    * A2=height:width
     942                    * A3=Dest Y:X
     943                    * A4=SAG
     944                    * A5=Offset:Control
     945                    * Trashes A0,A14
     946                    
     947 00001ed0           QDMAN
     948                    ;       movk    1,a0
     949                    ;       move    a0,@QDMAFLG             ;Q being modified
     950                    
     951 00001ed0     07ae          move    @DMAQCUR,a14,L
         00001ee0 00000150- 
     952 00001f00     0b6e          cmpi    DMAQ,a14
         00001f10 fffb514f- 
     953 00001f30     c20a          jrls    ilfyx                   ;Q full?
     954                    
     955 00001f40     09e0          movi    [100h,100h],a0          ;No scale
         00001f50 01000100  
     956 00001f70     3205          rl      16,a5                   ;Flip DMA & offset
     957 00001f80     098e          mmtm    a14,a0,a1,a2,a3,a4,a5
         00001f90     fc00  
     958 00001fa0     3205          rl      16,a5                   ;Flip DMA & offset
     959 00001fb0     078e          move    a14,@DMAQCUR,L
         00001fc0 00000150- 
     960                    
     961 00001fe0           ilfyx
     962                    ;       clr     a0
     963                    ;       move    a0,@QDMAFLG
     964 00001fe0     0960          rets
     965                    
     966                            .if     0
     967                    
     968                    *******************************
     969                    * Turn on the 2d with scaling display mode
     970                    * Trashes scratch
     971                    
     972                     SUBRP  display_2dsclmodeon
     973                    
     974                            movi    gqxpdrawcode,a0
     975                            move    a0,@dcode_p,L
     976                            movi    -1,a0
     977                            move    a0,@dtype
     978                    
     979                            rets
     980                    
     981                    gqxpdrawcode
     982                            movi    BAKLST,a0
     983                            callr   dma_objlst2d
     984                    
     985                            movi    OBJLST,a0
     986                    ;;;;    jruc    dma_objlst2dscl
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   20

     987                    
     988                    
     989                    *******************************
     990                    * Turn on the 2d, with scaling and stars, display mode
     991                    * Trashes scratch
     992                    
     993                            .asg    SCRATCH+8*128*1024,STARBUF
     994                    NSTARS  .equ    900
     995                    STARSIZE .equ   32*6+16
     996                    
     997                     SUBRP  display_2dsclstarmodeon
     998                    
     999                            movi    NSTARS,b0               ;>Init star array
    1000                            movi    STARBUF,a1
    1001                            movi    -1,a0
    1002                    mdqlsilp        move    a0,*a1,L                ;X
    1003                            addi    STARSIZE,a1
    1004                            dsj     b0,mdqlsilp
    1005                    
    1006                            movi    mdqldrawcode,a0
    1007                            move    a0,@dcode_p,L
    1008                            movi    -1,a0
    1009                            move    a0,@dtype
    1010                    
    1011                            rets
    1012                    
    1013                    ********************************
    1014                    * B2=Y offset for top of page : XPad offset
    1015                    * Trashes A0-A3,A5-A12,B0-B3
    1016                    
    1017                    CFRAC   .equ    2
    1018                    
    1019                            .bss    starcolor       ,16
    1020                    
    1021                    mdqldrawcode
    1022                            PUSH    a13,a14
    1023                            PUSH    b4
    1024                    
    1025                            movk    3,a0
    1026                            callr   rnd
    1027                            move    @starcolor,a6
    1028                            add     a0,a6
    1029                            move    a6,@starcolor
    1030                            sll     32-3-6,a6
    1031                            srl     32-3,a6                 ;Remove fraction
    1032                            sll     5+CFRAC,a6
    1033                    
    1034                    
    1035                            movi    NSTARS,a5               ;0FHind a free star
    1036                            movi    STARBUF,a2
    1037                            movk    3,a3
    1038                    mdqlflp move    *a2,a0,L                ;X
    1039                            jrn     mdqlfound
    1040                            addi    STARSIZE,a2
    1041                    mdqlfnxt        dsj     a5,mdqlflp
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   21

    1042                            jruc    mdqlnofree
    1043                    
    1044                    mdqlfound       movi    [200,0],a0              ;0CHreate star
    1045                            move    a0,*a2+,L               ;X
    1046                            movi    [252,0],a0
    1047                            move    a0,*a2+,L               ;Y
    1048                    
    1049                            clr     a0
    1050                            move    a0,*a2+,L               ;XV
    1051                            movi    -03e000H,a0
    1052                            move    a0,*a2+,L               ;YV
    1053                    
    1054                            movi    07ffH,a0
    1055                            callr   rnd
    1056                            subi    03ffH,a0
    1057                            move    a0,*a2+,L               ;XA
    1058                            movi    03ffH,a0
    1059                            callr   rnd
    1060                            addi    07ffH,a0
    1061                            move    a0,*a2+,L               ;YA
    1062                    
    1063                            move    a6,*a2+                 ;Color type
    1064                            dsj     a3,mdqlfnxt
    1065                    mdqlnofree
    1066                    
    1067                            movi    mdqlstar_p,a0           ;>Update stars
    1068                            calla   pal_getf
    1069                            move    a0,@DMACMAP
    1070                    
    1071                            movi    512*8,b3
    1072                            lmo     b3,b0
    1073                            move    b0,@CONVDP
    1074                            clr     b4
    1075                    
    1076                            movi    1<<(32-5-CFRAC),a11
    1077                            movi    [400,0],a13             ;A13=X max+1
    1078                            movi    [254,0],a14             ;A14=Y max+1
    1079                            move    b2,a12
    1080                            movi    NSTARS,b0
    1081                            movi    STARBUF,a8
    1082                    mdqllp
    1083                    ;       move    *a8+,a2,L               ;X
    1084                    ;       move    *a8+,a3,L               ;Y
    1085                    ;       move    *a8+,a5,L               ;XV
    1086                    ;       move    *a8+,a6,L               ;YV
    1087                    ;       move    *a8+,a9,L               ;XA
    1088                    ;       move    *a8+,a10,L              ;YA
    1089                            mmfm    a8,a2,a3,a5,a6,a9,a10   ;YA,XA,YV,XV,Y,X
    1090                            move    *a8+,a1                 ;Color
    1091                            move    a10,a10
    1092                            jrn     mdqlnxt
    1093                    
    1094                            add     a2,a5
    1095                            add     a3,a6
    1096                            add     a5,a9
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   22

    1097                            add     a6,a10
    1098                            cmp     a13,a10
    1099                            jrhs    mdqloffscr                      ;X off screen?
    1100                            cmp     a14,a9
    1101                            jrlo    mdqlplot                        ;Y on screen?
    1102                    mdqloffscr
    1103                            movi    -1,a0
    1104                            move    a0,*a8(-STARSIZE),L
    1105                            jruc    mdqlnxt
    1106                    mdqlplot
    1107                            move    a10,*a8(-STARSIZE),L
    1108                            move    a9,*a8(-STARSIZE+32),L
    1109                            move    a6,*a8(-STARSIZE+32*2),L
    1110                            move    a5,*a8(-STARSIZE+32*3),L
    1111                    
    1112                            move    a1,a0
    1113                            sll     32-5-CFRAC,a0
    1114                            add     a11,a0
    1115                            jrc     mdqlmaxc                        ;Overflow?
    1116                    ;       cmpi    32*4,a1
    1117                    ;       jrge    mdqloffscr
    1118                            addk    1,a1
    1119                            move    a1,*a8(-16)
    1120                    mdqlmaxc        srl     CFRAC,a1                ;Remove fraction
    1121                            srl     16,a10
    1122                            movx    a10,a9
    1123                            addxy   a12,a9
    1124                            pixt    a1,*a9.XY
    1125                    mdqlnxt
    1126                            dsj     b0,mdqllp
    1127                    
    1128                            PULL    b4
    1129                            PULL    a13,a14
    1130                    
    1131                            movi    BAKLST,a0
    1132                            callr   dma_objlst2d
    1133                    
    1134                            movi    OBJLST,a0
    1135                    ;;;     jruc    dma_objlst2dscl
    1136                    
    1137                    mdqlstar_p
    1138                            .word   256
    1139                            COLORW  01,01,01, 02,02,02, 03,03,03, 04,04,04  ;Grey
    1140                            COLORW  05,05,05, 06,06,06, 07,07,07, 08,08,08
    1141                            COLORW  09,09,09, 10,10,10, 11,11,11, 12,12,12
    1142                            COLORW  13,13,13, 14,14,14, 15,15,15, 16,16,16
    1143                            COLORW  17,17,17, 18,18,18, 19,19,19, 20,20,20
    1144                            COLORW  21,21,21, 22,22,22, 23,23,23, 24,24,24
    1145                            COLORW  25,25,25, 26,26,26, 27,27,27, 28,28,28
    1146                            COLORW  29,29,29, 30,30,30, 31,31,31, 31,31,31
    1147                            COLORW  01,01,00, 02,02,00, 03,03,00, 04,04,00  ;Yellow
    1148                            COLORW  05,05,00, 06,06,00, 07,07,00, 08,08,00
    1149                            COLORW  09,09,00, 10,10,00, 11,11,00, 12,12,00
    1150                            COLORW  13,13,00, 14,14,00, 15,15,00, 16,16,00
    1151                            COLORW  17,17,00, 18,18,00, 19,19,00, 20,20,00
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   23

    1152                            COLORW  21,21,00, 22,22,00, 23,23,00, 24,24,00
    1153                            COLORW  25,25,00, 26,26,00, 27,27,00, 28,28,00
    1154                            COLORW  29,29,00, 30,30,00, 31,31,00, 31,31,00
    1155                            COLORW  01,00,00, 02,00,00, 03,00,00, 04,00,00  ;Red
    1156                            COLORW  05,00,00, 06,00,00, 07,00,00, 08,00,00
    1157                            COLORW  09,00,00, 10,00,00, 11,00,00, 12,00,00
    1158                            COLORW  13,00,00, 14,00,00, 15,00,00, 16,00,00
    1159                            COLORW  17,00,00, 18,00,00, 19,00,00, 20,00,00
    1160                            COLORW  21,00,00, 22,00,00, 23,00,00, 24,00,00
    1161                            COLORW  25,00,00, 26,00,00, 27,00,00, 28,00,00
    1162                            COLORW  29,00,00, 30,00,00, 31,00,00, 31,00,00
    1163                            COLORW  00,01,00, 00,02,00, 00,03,00, 00,04,00  ;Green
    1164                            COLORW  00,05,00, 00,06,00, 00,07,00, 00,08,00
    1165                            COLORW  00,09,00, 00,10,00, 00,11,00, 00,12,00
    1166                            COLORW  00,13,00, 00,14,00, 00,15,00, 00,16,00
    1167                            COLORW  00,17,00, 00,18,00, 00,19,00, 00,20,00
    1168                            COLORW  00,21,00, 00,22,00, 00,23,00, 00,24,00
    1169                            COLORW  00,25,00, 00,26,00, 00,27,00, 00,28,00
    1170                            COLORW  00,29,00, 00,30,00, 00,31,00, 00,31,00
    1171                            COLORW  00,00,01, 00,00,02, 00,00,03, 00,00,04  ;Blue
    1172                            COLORW  00,00,05, 00,00,06, 00,00,07, 00,00,08
    1173                            COLORW  00,00,09, 00,00,10, 00,00,11, 00,00,12
    1174                            COLORW  00,00,13, 00,00,14, 00,00,15, 00,00,16
    1175                            COLORW  00,00,17, 00,00,18, 00,00,19, 00,00,20
    1176                            COLORW  00,00,21, 00,00,22, 00,00,23, 00,00,24
    1177                            COLORW  00,00,25, 00,00,26, 00,00,27, 00,00,28
    1178                            COLORW  00,00,29, 00,00,30, 00,00,31, 00,00,31
    1179                            COLORW  00,00,01, 00,00,02, 00,00,03, 00,00,04  ;Lt blue
    1180                            COLORW  00,00,05, 00,00,06, 00,00,07, 00,00,08
    1181                            COLORW  00,00,09, 01,01,10, 02,02,11, 03,03,12
    1182                            COLORW  04,04,13, 05,05,14, 06,06,15, 07,07,16
    1183                            COLORW  08,08,17, 09,09,18, 10,10,19, 11,11,20
    1184                            COLORW  12,12,21, 14,14,22, 16,16,23, 18,18,24
    1185                            COLORW  20,20,25, 22,22,26, 24,24,27, 26,26,28
    1186                            COLORW  28,28,29, 30,30,30, 30,30,31, 31,31,31
    1187                            COLORW  01,00,01, 02,00,02, 03,00,03, 04,00,04  ;Purple
    1188                            COLORW  05,00,05, 06,00,06, 07,00,07, 08,00,08
    1189                            COLORW  09,00,09, 10,00,10, 11,00,11, 12,00,12
    1190                            COLORW  13,00,13, 14,00,14, 15,00,15, 16,00,16
    1191                            COLORW  17,00,17, 18,00,18, 19,00,19, 20,00,20
    1192                            COLORW  21,00,21, 22,00,22, 23,00,23, 24,00,24
    1193                            COLORW  25,00,25, 26,00,26, 27,00,27, 28,00,28
    1194                            COLORW  29,00,29, 30,00,30, 31,00,31, 31,00,31
    1195                            COLORW  00,01,01, 00,02,02, 00,03,03, 00,04,04  ;Cyan
    1196                            COLORW  00,05,05, 00,06,06, 00,07,07, 00,08,08
    1197                            COLORW  00,09,09, 00,10,10, 00,11,11, 00,12,12
    1198                            COLORW  00,13,13, 00,14,14, 00,15,15, 00,16,16
    1199                            COLORW  00,17,17, 00,18,18, 00,19,19, 00,20,20
    1200                            COLORW  00,21,21, 00,22,22, 00,23,23, 00,24,24
    1201                            COLORW  00,25,25, 00,26,26, 00,27,27, 00,28,28
    1202                            COLORW  00,29,29, 00,30,30, 00,31,31, 00,31,31
    1203                    
    1204                            .endif
    1205                    
    1206                    ********************************
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   24

    1207                    * Get random # with mask
    1208                    * A0=Mask
    1209                    * 0A0H=Rnd # (Pass CC)
    1210                    * Trashes scratch
    1211                    
    1212 00001ff0            SUBRP  rnd
    1213                    
    1214 00001ff0     07a1          move    @RAND,a1,L
         00002000 00000000! 
    1215 00002020     6821          rl      a1,a1
    1216 00002030     05ae          move    @HCOUNT,a14
         00002040 c00001c0  
    1217 00002060     69c1          rl      a14,a1
    1218 00002070     41e1          add     sp,a1
    1219 00002080     0781          move    a1,@RAND,L
         00002090 00000000! 
    1220                    
    1221 000020b0     5020          and     a1,a0
    1222 000020c0     0960          rets
    1223                    
    1224                    
    1225                    ********************************
    1226                    * Zeros velocities for all objects on OBJLST
    1227                    
    1228 000020d0           STOPOBJS
    1229 000020d0     5600          clr     a0
    1230 000020e0     09e1          movi    OBJLST,a1
         000020f0 00000000+ 
    1231 00002110     c006          jruc    so20
    1232                    
    1233 00002120     b201  so10    move    a0,*a1(OXVEL),L
         00002130     0020  
    1234 00002140     b201          move    a0,*a1(OYVEL),L
         00002150     0040  
    1235 00002160     b201          move    a0,*a1(OZVEL),L
         00002170     0060  
    1236 00002180     8621  so20    move    *a1,a1,L
    1237 00002190     cbf8          jrnz    so10
    1238                    
    1239 000021a0     0960          rets
    1240                    
    1241                    
    1242                    ********************************
    1243                    * Sort object list in Z:Y priority
    1244                    * Trashes A0-A7
    1245                    
    1246                            .align
    1247                    
    1248 00002200            SUBR   obj_yzsort
    1249                    
    1250 00002200     09e0          movi    OBJLST,a0
         00002210 00000000+ 
    1251 00002230     1821          movk    1,a1                    ;Lowest Z
    1252 00002240     27e1          sll     31,a1                   ;Make 080000000H
    1253 00002250     c014          jruc    yzlp
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   25

    1254                    
    1255 00002260           yz0
    1256 00002260     b446          move    *a2(OZPOS),a6           ;Get Z
         00002270     00d0  
    1257 00002280     b447          move    *a2(OYPOS),a7           ;Get Y
         00002290     00b0  
    1258                    
    1259 000022a0     4826          cmp     a1,a6
    1260 000022b0     c70a          jrgt    priok                   ;Next Z > Current Z?
    1261 000022c0     c402          jrlt    priswap
    1262                    
    1263 000022d0     48a7          cmp     a5,a7
    1264 000022e0     c507          jrge    priok                   ;Next Y > Current Y?
    1265                    
    1266 000022f0     0360  priswap dint                            ;>Make current after next
    1267 00002300     8244          move    a2,*a4,L                ;Point last to next
    1268 00002310     8a40          move    *a2,*a0,L               ;Point current to block after next
    1269 00002320     8202          move    a0,*a2,L                ;Point next to current
    1270 00002330     0d60          eint
    1271 00002340     4c44          move    a2,a4
    1272 00002350     c004          jruc    yzlp                    ;Continue sort of current obj
    1273                    
    1274 00002360     4c04  priok   move    a0,a4                   ;A4=*Last obj
    1275 00002370     4c40          move    a2,a0                   ;A0=*Current obj
    1276 00002380     4cc1          move    a6,a1                   ;A1=Current Z
    1277 00002390     4ce5          move    a7,a5                   ;A5=Current Y
    1278                    
    1279 000023a0     8602  yzlp    move    *a0,a2,L                ;A2=*Next obj
    1280 000023b0     cbea          jrnz    yz0
    1281                    
    1282 000023c0     0960          rets
    1283                    
    1284                    
    1285                    **************************************************************************
    1286                    * TEST IF OBJECT ON SCREEN
    1287                    * A8=OBJECT
    1288                    * RETURNS Z IF ON SCREEN
    1289                    
    1290                    *ENTER HERE AND PROVIDE YOUR OWN SCREEN BOUNDRIES
    1291 000023d0           SCRTSTG
    1292 000023d0     098f          mmtm    sp,a1,a2,a3
         000023e0     7000  
    1293 000023f0     c008          jruc    scrtst1
    1294                    
    1295                    *NORMAL SCREEN BOUNDRIES
    1296 00002400           SCRTST
    1297 00002400     098f          mmtm    sp,a1,a2,a3
         00002410     7000  
    1298 00002420     07a2          move    @SCRNTL,a2,L            ;Get screen top left
         00002430 000000d0- 
    1299 00002450     07a3          move    @SCRNLR,a3,L            ;Get screen lower rgt
         00002460 000000f0- 
    1300                    
    1301 00002480     b500  scrtst1 move    *a8(OYPOS),a0
         00002490     00b0  
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   26

    1302 000024a0     b501          move    *a8(OXPOS),a1
         000024b0     0090  
    1303 000024c0     2600          sll     16,a0
    1304 000024d0     ec20          movx    a1,a0                   ;get top left of object
    1305 000024e0     07a1          move    @WORLDTL,a1,L
         000024f0 000000b0- 
    1306 00002510     e220          subxy   a1,a0                   ;subtract out world base
    1307 00002520     b701          move    *a8(OSIZE),a1,L
         00002530     0130  
    1308 00002540     e001          addxy   a0,a1                   ;get lower rt of object
    1309                    
    1310 00002550     e460          cmpxy   a3,a0                   ;is it lower than lower rt?
    1311 00002560                   JRYGE   scrtf_d                 ;lower
    1312 00002570                   JRXGE   scrtf_r                 ;to the right
    1313                    
    1314 00002580     e441          cmpxy   a2,a1
    1315 00002590     c20d          JRYLE   scrtf_u                 ;above...
    1316 000025a0     c404          JRXLE   scrtf_l                 ;to the left..
    1317                    
    1318 000025b0     09af          mmfm    sp,a1,a2,a3
         000025c0     000e  
    1319 000025d0     5600          clr     a0                      ;On screen Z
    1320 000025e0     0960          rets
    1321 000025f0     1820  scrtf_l movk    1,a0                    ;Pass NZ
    1322 00002600     09af          mmfm    sp,a1,a2,a3
         00002610     000e  
    1323 00002620     0960          rets
    1324                    
    1325 00002630     1840  scrtf_r movk    2,a0
    1326 00002640     09af          mmfm    sp,a1,a2,a3
         00002650     000e  
    1327 00002660     0960          rets
    1328                    
    1329 00002670     1860  scrtf_u movk    3,a0
    1330 00002680     09af          mmfm    sp,a1,a2,a3
         00002690     000e  
    1331 000026a0     0960          rets
    1332                    
    1333 000026b0     1880  scrtf_d movk    4,a0
    1334 000026c0     09af          mmfm    sp,a1,a2,a3
         000026d0     000e  
    1335 000026e0     0960          rets
    1336                    
    1337                    
    1338                    *******************************
    1339                    * Initialize display system
    1340                    * Trashes scratch
    1341                    
    1342 000026f0            SUBR   SPECIAL_DISPLAY_INIT
    1343                    
    1344 000026f0     01e0          pushst
    1345 00002700     0360          dint
    1346 00002710     09c0          movi    DIE+X2E,a0
         00002720     0404  
    1347 00002730     0580          move    a0,@INTENB              ;Display int on, DMA int off
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   27

         00002740 c0000110  
    1348                    
    1349 00002760     5600          clr     a0
    1350 00002770     0580          move    a0,@DMACTRL             ;Init DMA
         00002780 01a00010  
    1351 000027a0     0580          move    a0,@DMACTRL
         000027b0 01a00010  
    1352 000027d0     0580          move    a0,@CMAPSEL             ;Clear color map select
         000027e0 01a80080  
    1353 00002800     0580          move    a0,@DMATEST
         00002810 01a000e0  
    1354 00002830     0580          move    a0,@DMACONF
         00002840 01a000f0  
    1355 00002860     09e1          movi    [511,0],a1              ;RIGHT:LEFT (full width to fix glitch)
         00002870 01ff0000  
    1356 00002890     0781          move    a1,@DMAWINDOW,L
         000028a0 01a000c0  
    1357 000028c0     09c1          movi    30h,a1          ;<--------------------check this!!!!!!!!!!!
         000028d0     0030  
    1358 000028e0     0581          move    a1,@DMACONF             ;BOTTOM:TOP
         000028f0 01a000f0  
    1359 00002910     09e1          movi    [509,0],a1
         00002920 01fd0000  
    1360 00002940     0781          move    a1,@DMAWINDOW,L
         00002950 01a000c0  
    1361 00002970     09e1          movi    [100h,100h],a1
         00002980 01000100  
    1362 000029a0     0781          move    a1,@DMASCALEX,L
         000029b0 01a000a0  
    1363                    
    1364 000029d0     09dd          movi    -1,b13                  ;DMAQ cnt
         000029e0     ffff  
    1365                    
    1366 000029f0     09e1          MOVI    DUMRETS,A1
         00002a00 00000000! 
    1367 00002a20     0781          MOVE    A1,@WHICH_SCREEN,L
         00002a30 00000000! 
    1368 00002a50     5600          CLR     A0
    1369 00002a60     0780          MOVE    A0,@TOP_LEFT,L
         00002a70 00000000! 
    1370 00002a90     0780          MOVE    A0,@BOT_RIGHT,L
         00002aa0 00000000! 
    1371 00002ac0     0580          move    a0,@special_screen
         00002ad0 00000000! 
    1372 00002af0     0d3f          callr   clear_objs
         00002b00     0055  
    1373 00002b10     01c0          popst
    1374                    
    1375 00002b20     0960          rets
    1376                    
    1377                    
    1378                    *******************************
    1379                    * Initialize display system
    1380                    * Trashes scratch
    1381                    
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   28

    1382 00002b30            SUBR   display_init
    1383                    
    1384 00002b30     01e0          pushst
    1385 00002b40     0360          dint
    1386 00002b50     09c0          movi    DIE+X2E,a0
         00002b60     0404  
    1387 00002b70     0580          move    a0,@INTENB              ;Display int on, DMA int off
         00002b80 c0000110  
    1388                    
    1389 00002ba0     5600          clr     a0
    1390 00002bb0     0580          move    a0,@DMACTRL             ;Init DMA
         00002bc0 01a00010  
    1391 00002be0     0580          move    a0,@DMACTRL
         00002bf0 01a00010  
    1392 00002c10     0580          move    a0,@CMAPSEL             ;Clear color map select
         00002c20 01a80080  
    1393 00002c40     0580          move    a0,@DMATEST
         00002c50 01a000e0  
    1394 00002c70     0580          move    a0,@DMACONF
         00002c80 01a000f0  
    1395 00002ca0     09e1          movi    [511,0],a1              ;RIGHT:LEFT (full width to fix glitch)
         00002cb0 01ff0000  
    1396 00002cd0     0781          move    a1,@DMAWINDOW,L
         00002ce0 01a000c0  
    1397 00002d00     09c1          movi    30h,a1          ;<--------------------check this!!!!!!!!!!!
         00002d10     0030  
    1398 00002d20     0581          move    a1,@DMACONF             ;BOTTOM:TOP
         00002d30 01a000f0  
    1399 00002d50     09e1          movi    [509,0],a1
         00002d60 01fd0000  
    1400 00002d80     0781          move    a1,@DMAWINDOW,L
         00002d90 01a000c0  
    1401 00002db0     09e1          movi    [100h,100h],a1
         00002dc0 01000100  
    1402 00002de0     0781          move    a1,@DMASCALEX,L
         00002df0 01a000a0  
    1403                    
    1404 00002e10     09dd          movi    -1,b13                  ;DMAQ cnt
         00002e20     ffff  
    1405                    
    1406 00002e30     5621          clr     a1                      ;0CHlr video mem
    1407 00002e40     09d0          movi    (SCRNE-512*8*2)/64,b0
         00002e50     7f80  
    1408 00002e60     9201  cpnbclp move    a0,*a1+,L
    1409 00002e70     9201          move    a0,*a1+,L
    1410 00002e80     3c70          dsj     b0,cpnbclp
    1411                                                            ;>Set autoerase lines
    1412 00002e90     09e1          movi    510*512*8,a1            ;Store to last 2 lines of bitmap
         00002ea0 001fe000  
    1413 00002ec0     09ce          movi    ERASECOL,a14            ;Color pair
         00002ed0     0000  
    1414 00002ee0     09d0          movi    512*8*2/16,b0
         00002ef0     0200  
    1415 00002f00     91c1  cpnblp  move    a14,*a1+
    1416 00002f10     3c50          dsj     b0,cpnblp
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   29

    1417                    
    1418                    
    1419                    
    1420 00002f20     09e1          MOVI    DUMRETS,A1
         00002f30 00000000! 
    1421 00002f50     0781          MOVE    A1,@WHICH_SCREEN,L
         00002f60 00000000! 
    1422 00002f80     5600          CLR     A0
    1423 00002f90     0780          MOVE    A0,@TOP_LEFT,L
         00002fa0 00000000! 
    1424 00002fc0     0780          MOVE    A0,@BOT_RIGHT,L
         00002fd0 00000000! 
    1425 00002ff0     0580          move    a0,@special_screen
         00003000 00000000! 
    1426 00003020     0d3f          callr   clear_objs
         00003030     0002  
    1427 00003040     01c0          popst
    1428                    
    1429 00003050     0960          rets
    1430                    
    1431 00003060           clear_objs
    1432 00003060     5600          CLR     A0
    1433 00003070     0780          move    a0,@WORLDTLX,L
         00003080 00000070- 
    1434 000030a0     0780          move    a0,@WORLDTLY,L
         000030b0 00000090- 
    1435 000030d0     0780          move    a0,@WORLDTL,L
         000030e0 000000b0- 
    1436 00003100     0780          move    a0,@SCROLLX,L
         00003110 00000030- 
    1437 00003130     0780          move    a0,@SCROLLY,L
         00003140 00000050- 
    1438                    
    1439 00003160     0780          move    a0,@BAKLST,L            ;Null backgnd object list
         00003170 00000040+ 
    1440 00003190     0780          move    a0,@OBJLST,L            ;Null object list
         000031a0 00000000+ 
    1441                    
    1442 000031c0     0780          move    a0,@dcode_p,L
         000031d0 00000130- 
    1443                    
    1444 000031f0     09e1          movi    SCRNST,a1               ;Screen top left [Y,X]
         00003200 0000ffe0  
    1445 00003220     0781          move    a1,@SCRNTL,L
         00003230 000000d0- 
    1446 00003250     09e1          movi    SCRNEND,a1              ;Screen lower right [Y,X]
         00003260 00fe01b0  
    1447 00003280     0781          move    a1,@SCRNLR,L
         00003290 000000f0- 
    1448                    
    1449 000032b0     09e1          movi    DMAQ+QMSIZE,a1
         000032c0 0005b530- 
    1450 000032e0     0781          move    a1,@DMAQCUR,L           ;Init misc DMA queue
         000032f0 00000150- 
    1451                    
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   30

    1452 00003310     09e1          movi    OBJSTR,a1,L             ;>Init free list
         00003320 00000170- 
    1453 00003340     0781          move    a1,@OFREE,L
         00003350 00000020+ 
    1454 00003370     09d0          movi    NOBJ,b0                 ;# of object blocks
         00003380     015e  
    1455                    
    1456 00003390     4c2e  cpnbolp move    a1,a14
    1457 000033a0     0b01          addi    OBSIZ,a1
         000033b0     0260  
    1458 000033c0     822e          move    a1,*a14,L               ;link em up
    1459 000033d0     3cb0          dsj     b0,cpnbolp
    1460                    
    1461 000033e0     820e          move    a0,*a14,L               ;Null end
    1462 000033f0     0960          rets
    1463                    
    1464                    
    1465                    ********************************
    1466                    * Get a free object block
    1467                    * Trashes scratch
    1468                    * 0A0H=*Object or 0 (Z)
    1469                    
    1470 00003400           GETOBJ
    1471 00003400     07a0          move    @OFREE,a0,L
         00003410 00000020+ 
    1472 00003430     ca0b          jrz     nonelft                 ;None free?
    1473                    
    1474 00003440     8601          move    *a0,a1,L
    1475 00003450     0781          move    a1,@OFREE,L             ;Unlink
         00003460 00000020+ 
    1476 00003480     5621          clr     a1
    1477 00003490     b220          move    a1,*a0(OPLINK),L
         000034a0     01a0  
    1478 000034b0     b220          move    a1,*a0(ODATA_p),L
         000034c0     01c0  
    1479 000034d0           getox
    1480 000034d0     4c00          move    a0,a0
    1481 000034e0     0960          rets
    1482                    
    1483 000034f0           nonelft
    1484                            .if     DEBUG
    1485                            LOCKUP
    1486                            eint
    1487                            .else
    1488 000034f0                   CALLERR 3,0
    1489                            .endif
    1490 000035a0     c0f2          jruc    getox
    1491                    
    1492                    
    1493                    ********************************
    1494                    * Add object to free list
    1495                    * Can trash A0-A1 (currently doesn't)
    1496                    
    1497 000035b0           FREEOBJ
    1498 000035b0     d600          move    @OFREE,*a0+,L
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   31

         000035c0 00000020+ 
    1499 000035e0     1400          subk    32,a0
    1500 000035f0     0780          move    a0,@OFREE,L
         00003600 00000020+ 
    1501 00003620     0960          rets
    1502                    
    1503                    
    1504                    *******************************
    1505                    * Unlink an object from object list
    1506                    * A0=*Obj
    1507                    * Trashes scratch
    1508                    
    1509                    ; SUBR  obj_unlink
    1510                    ;
    1511                    ;       movi    OBJLST,a14
    1512                    ;
    1513                    ;dfdjlp move    a14,a1          ;A1=*Prev
    1514                    ;       move    *a14,a14,L      ;A14=*Next
    1515                    ;       jrz     dfdjerr
    1516                    ;       cmp     a14,a0
    1517                    ;       jrne    dfdjlp
    1518                    ;
    1519                    ;       move    *a0,*a1,L       ;Unlink from obj list
    1520                    ;       rets
    1521                    ;
    1522                    ;dfdjerr
    1523                    ;       .if     DEBUG
    1524                    ;       LOCKUP
    1525                    ;       eint
    1526                    ;       .endif
    1527                    ;       rets
    1528                    
    1529                    
    1530                    ********************************
    1531                    * Insert an object block into an object list
    1532                    * List is sorted by increasing z and increasing y within constant z
    1533                    
    1534                    
    1535                    *******************************
    1536                    * Insert background object
    1537                    * A0=*Obj
    1538                    * Trashes scratch
    1539                    
    1540 00003630           INSBOBJ
    1541 00003630     09ee          movi    BAKLST,a14
         00003640 00000040+ 
    1542 00003660     c003          jruc    rbkmstrt
    1543                    
    1544                    ********************************
    1545                    * Insert foreground object
    1546                    * A0=*Obj
    1547                    * Trashes scratch
    1548                    
    1549 00003670           INSOBJ
    1550                    
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   32

    1551 00003670     09ee          movi    OBJLST,a14
         00003680 00000000+ 
    1552                    
    1553 000036a0           rbkmstrt        PUSH    a2,a3,a4
    1554                    
    1555 000036c0     b401          move    *a0(OZPOS),a1
         000036d0     00d0  
    1556 000036e0     b404          move    *a0(OYPOS),a4
         000036f0     00b0  
    1557 00003700           rbkmlp
    1558 00003700     4dc2          move    a14,a2                  ;A2=*prev
    1559 00003710     87ce          move    *a14,a14,L              ;A14=*next
    1560 00003720     ca09          jrz     rbkmx
    1561 00003730     b5c3          move    *a14(OZPOS),a3
         00003740     00d0  
    1562 00003750     4861          cmp     a3,a1
    1563 00003760     c7f9          jrgt    rbkmlp
    1564 00003770     c404          jrlt    rbkmx
    1565                    
    1566 00003780     b5c3          move    *a14(OYPOS),a3          ;Test y position
         00003790     00b0  
    1567 000037a0     4864          cmp     a3,a4
    1568 000037b0     c7f4          jrgt    rbkmlp
    1569                    
    1570                    
    1571 000037c0     83c0  rbkmx   move    a14,*a0,L               ;Put *next in new block
    1572 000037d0     8202          move    a0,*a2,L                ;Put *new in prev block
    1573                    
    1574 000037e0                   PULL    a2,a3,a4
    1575 00003800     0960          rets
    1576                    
    1577                    
    1578                    *******************************
    1579                    * Delete background object
    1580                    * A0=*Obj
    1581                    
    1582 00003810           DELBOBJ
    1583                    
    1584 00003810     09ee          movi    BAKLST,a14
         00003820 00000040+ 
    1585 00003840     c004          jruc    vfqhlp
    1586                    
    1587                    
    1588                    ********************************
    1589                    * Delete foreground object
    1590                    * A8=*Obj
    1591                    
    1592 00003850           DELOBJA8
    1593                    
    1594 00003850     4d00          move    a8,a0
    1595                    
    1596                    ********************************
    1597                    * Delete foreground object
    1598                    * A0=*Obj
    1599                    * Trashes scratch
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   33

    1600                    
    1601 00003860           DELOBJ
    1602 00003860     09ee          movi    OBJLST,a14
         00003870 00000000+ 
    1603                    
    1604 00003890     4dc1  vfqhlp  move    a14,a1          ;A1=*Prev
    1605 000038a0     87ce          move    *a14,a14,L      ;A14=*Next
    1606 000038b0     ca0e          jrz     delerr
    1607 000038c0     49c0          cmp     a14,a0
    1608 000038d0     cbfb          jrne    vfqhlp
    1609                    
    1610 000038e0     8a01          move    *a0,*a1,L       ;Unlink from obj list
    1611                    
    1612 000038f0     5621          clr     a1
    1613 00003900     b020          move    a1,*a0(OXPOS)   ;Indicates not in use for collisions
         00003910     0090  
    1614                    
    1615 00003920     d600          move    @OFREE,*a0+,L   ;Add to free list
         00003930 00000020+ 
    1616 00003950     1400          subk    32,a0
    1617 00003960     0780          move    a0,@OFREE,L
         00003970 00000020+ 
    1618                    
    1619 00003990     0960  vfqhx   rets
    1620                    
    1621 000039a0           delerr
    1622                            .if     DEBUG
    1623                            LOCKUP
    1624                            eint
    1625                            .else
    1626 000039a0                   CALLERR 1,0
    1627                            .endif
    1628 00003a50     c0f3          jruc    vfqhx
    1629                    
    1630                    
    1631                    
    1632                    ********************************
    1633                    * FRANIM list an object, delete it and DIE
    1634                    * A8=*Obj
    1635                    * A9=*FRANIM list
    1636                    
    1637 00003a60           FRQDELDIE
    1638                    
    1639 00003a60                   JSRP    FRANIMQ
    1640                    
    1641                    *******************************
    1642                    * Delete foreground object and DIE
    1643                    * A8=*Obj
    1644                    
    1645 00003ad0           DELOBJDIE
    1646                    
    1647 00003ad0     09ee          movi    OBJLST,a14
         00003ae0 00000000+ 
    1648                    
    1649 00003b00     4dc1  sleglp  move    a14,a1          ;A1=*Prev
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   34

    1650 00003b10     87ce          move    *a14,a14,L      ;A14=*Next
    1651 00003b20     ca10          jrz     doderr
    1652 00003b30     49c8          cmp     a14,a8
    1653 00003b40     cbfb          jrne    sleglp
    1654                    
    1655 00003b50     8b01          move    *a8,*a1,L       ;Unlink from obj list
    1656                    
    1657 00003b60     5621          clr     a1
    1658 00003b70     b028          move    a1,*a8(OXPOS)   ;Indicates not in use for collisions
         00003b80     0090  
    1659                    
    1660 00003b90     d608          move    @OFREE,*a8+,L   ;Add to free list
         00003ba0 00000020+ 
    1661 00003bc0     1408          subk    32,a8
    1662 00003bd0     0788          move    a8,@OFREE,L
         00003be0 00000020+ 
    1663                    
    1664 00003c00     c080  slegx   jauc    SUCIDE
         00003c10 00000000! 
    1665                    
    1666 00003c30           doderr
    1667                            .if     DEBUG
    1668                            LOCKUP
    1669                            eint
    1670                            .else
    1671 00003c30                   CALLERR 1,0
    1672                            .endif
    1673 00003ce0     c0f1          jruc    slegx
    1674                    
    1675                    
    1676                    
    1677                    *******************************
    1678                    * Delete one class from the obj list
    1679                    * A0=OID
    1680                    * Trashes scratch
    1681                    
    1682 00003cf0           obj_del1c
    1683                    
    1684 00003cf0     5621          clr     a1
    1685                    
    1686                    ********************************
    1687                    * Delete a class from the obj list
    1688                    * A0=OID
    1689                    * A1=!Mask (Bits to remove)
    1690                    * Trashes scratch
    1691                    
    1692 00003d00           obj_delc
    1693 00003d00     4e40          move    a2,b0
    1694 00003d10     4e61          move    a3,b1
    1695                    
    1696 00003d20     09ee          movi    OBJLST,a14
         00003d30 00000000+ 
    1697 00003d50     0500          sext    a0
    1698 00003d60     5220          andn    a1,a0           ;Form match
    1699                    
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   35

    1700 00003d70     4dc3  znpclp  move    a14,a3          ;A3=*Prev
    1701 00003d80     87ce          move    *a14,a14,L      ;A14=*Next
    1702 00003d90     ca0f          jrz     znpcx
    1703 00003da0     b5c2  znpccmp move    *a14(OID),a2
         00003db0     0190  
    1704 00003dc0     5222          andn    a1,a2           ;Mask
    1705 00003dd0     4802          cmp     a0,a2
    1706 00003de0     cbf8          jrne    znpclp
    1707                    
    1708 00003df0     8bc3          move    *a14,*a3,L      ;Unlink from obj list
    1709                    
    1710 00003e00     d60e          move    @OFREE,*a14+,L  ;Add to free list
         00003e10 00000020+ 
    1711 00003e30     140e          subk    32,a14
    1712 00003e40     078e          move    a14,@OFREE,L
         00003e50 00000020+ 
    1713 00003e70     866e          move    *a3,a14,L
    1714 00003e80     cbf1          jrnz    znpccmp
    1715                    
    1716 00003e90           znpcx
    1717 00003e90     4e33          move    b1,a3
    1718 00003ea0     4e12          move    b0,a2
    1719 00003eb0     0960          rets
    1720                    
    1721                    
    1722                    
    1723                    *******************************
    1724                    * Check objlst for an object with a certain OID
    1725                    * A0=OID
    1726                    * A1=!Mask (Bits to remove)
    1727                    * 0A0H=*Obj or 0 (Z)
    1728                    * Trashes scratch
    1729                    
    1730 00003ec0           EXISTOBJ
    1731 00003ec0     4e40          move    a2,b0
    1732                    
    1733 00003ed0     09ee          movi    OBJLST,a14
         00003ee0 00000000+ 
    1734 00003f00     0500          sext    a0
    1735 00003f10     5220          andn    a1,a0           ;Form match
    1736 00003f20           xitllp
    1737 00003f20     87ce          move    *a14,a14,L
    1738 00003f30     ca05          jrz     xitlx
    1739 00003f40     b5c2          move    *a14(OID),a2
         00003f50     0190  
    1740 00003f60     5222          andn    a1,a2           ;Mask
    1741 00003f70     4802          cmp     a0,a2
    1742 00003f80     cbf9          jrne    xitllp
    1743                    
    1744 00003f90     4e12  xitlx   move    b0,a2
    1745 00003fa0     4dc0          move    a14,a0
    1746 00003fb0     0960          rets
    1747                    
    1748                    
    1749                    *******************************
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   36

    1750                    * Check if object on free list
    1751                    * A0=*Obj
    1752                    * 0A0H=*Obj or 0 (Z)
    1753                    * Trashes scratch
    1754                    
    1755                    ;ISFREE
    1756                    ;       movi    OFREE,a1
    1757                    ;       jruc    ftiylp
    1758                    
    1759                    
    1760                    ********************************
    1761                    * Check if object on OBJLST
    1762                    * A0=*Obj
    1763                    * 0A0H=*Obj or 0 (Z)
    1764                    * Trashes scratch
    1765                    
    1766 00003fc0           ISOBJ
    1767 00003fc0     09e1          movi    OBJLST,a1
         00003fd0 00000000+ 
    1768                    
    1769 00003ff0     8621  ftiylp  move    *a1,a1,L
    1770 00004000     ca04          jrz     ftiyx           ;End?
    1771 00004010     4801          cmp     a0,a1
    1772 00004020     cbfc          jrne    ftiylp          ;No match?
    1773                    
    1774 00004030     4c00          move    a0,a0           ;Clr Z
    1775 00004040     0960          rets
    1776                    
    1777 00004050     5600  ftiyx   clr     a0              ;Set Z
    1778 00004060     0960          rets
    1779                    
    1780                    
    1781                    ********************************
    1782                    * Add world coordinates to an object
    1783                    * A0=*Obj
    1784                    * Trashes scratch, !A0
    1785                    
    1786 00004070            SUBR   obj_addworldxy
    1787                    
    1788 00004070     07ae          move    @WORLDTLX,a14,L
         00004080 00000070- 
    1789 000040a0     b601          move    *a0(OXVAL),a1,L
         000040b0     0080  
    1790 000040c0     41c1          add     a14,a1
    1791 000040d0     b220          move    a1,*a0(OXVAL),L
         000040e0     0080  
    1792                    
    1793 000040f0     07ae          move    @WORLDTLY,a14,L
         00004100 00000090- 
    1794 00004120     b601          move    *a0(OYVAL),a1,L
         00004130     00a0  
    1795 00004140     41c1          add     a14,a1
    1796 00004150     b220          move    a1,*a0(OYVAL),L
         00004160     00a0  
    1797                    
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   37

    1798 00004170     0960          rets
    1799                    
    1800                    
    1801                    **************************************************************************
    1802                    *                                                                        *
    1803                    * ADJNEWTL - ADJUST AN OBJECT TO A NEW SET OF X,Y WORLD COORDINATES      *
    1804                    *          BEFORE THEY ARE STORED(TAKE EFFECT).                          *
    1805                    * NOTE: CURRENT OBJECT COORDS. MUST BE ABSOLUTE WORLD.                   *
    1806                    * A0 = PTR TO OBJECT                                                     *
    1807                    * A4 = NEW WTLX, 32 BITS                                                 *
    1808                    * A5 = NEW WTLY, 32 BITS                                                 *
    1809                    
    1810 00004180           ADJNEWTL
    1811 00004180                   PUSH    a1,a2
    1812 000041a0     0d3f          CALLR   GSCRNREL                ;SCREEN RELATIVE PLEASE
         000041b0     0009  
    1813 000041c0     4081          ADD     A4,A1
    1814 000041d0     40a2          ADD     A5,A2                   ;ADJUST
    1815 000041e0     b220          MOVE    A1,*A0(OXVAL),L
         000041f0     0080  
    1816 00004200     b240          MOVE    A2,*A0(OYVAL),L         ;STORE
         00004210     00a0  
    1817 00004220                   PULL    a1,a2
    1818 00004240     0960          RETS
    1819                    
    1820                    
    1821                    **************************************************************************
    1822                    *                                                                        *
    1823                    * GSCRNREL - GET THE SCREEN RELATIVE X,Y COORDINATES OF AN OBJECT        *
    1824                    *          IT IS ASSUMED THAT THE CURRENT X,Y COORDINATES ARE            *
    1825                    *          WORLD ABSOLUTE.                                               *
    1826                    * A0 = PTR TO THE OBJECT BLOCK                                           *
    1827                    * RETURNS                                                                *
    1828                    * A1 = X SCREEN RELATIVE, 32 BITS                                        *
    1829                    * A2 = Y SCREEN RELATIVE, 32 BITS                                        *
    1830                    
    1831 00004250           GSCRNREL
    1832 00004250                   PUSH    a5
    1833 00004260     07a5          MOVE    @WORLDTLX,A5,L
         00004270 00000070- 
    1834 00004290     b601          MOVE    *A0(OXVAL),A1,L
         000042a0     0080  
    1835 000042b0     44a1          SUB     A5,A1
    1836 000042c0     07a5          MOVE    @WORLDTLY,A5,L
         000042d0 00000090- 
    1837 000042f0     b602          MOVE    *A0(OYVAL),A2,L
         00004300     00a0  
    1838 00004310     44a2          SUB     A5,A2
    1839 00004320                   PULL    a5
    1840 00004330     0960          RETS
    1841                    
    1842                    
    1843                    **************************************************************************
    1844                    *                                                                        *
    1845                    * SCRNRELV - MAKE THE X & Y VELOCITIES OF AN OBJECT RELATIVE TO THE      *
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   38

    1846                    *          SCREEN. IN OTHER WORDS, ADJUST THEM SO THAT THE CURRENT       *
    1847                    *          SCROLL RATE DOESN'T AFFECT THEM.                              *
    1848                    * A0 = PTR TO OBJECT                                                     *
    1849                    *                                                                        *
    1850                    **************************************************************************
    1851                    
    1852 00004340           SCRNRELV
    1853 00004340                   PUSH    a1,a5
    1854 00004360     07a5          MOVE    @SCROLLX,A5,L
         00004370 00000030- 
    1855 00004390     b601          MOVE    *A0(OXVEL),A1,L
         000043a0     0020  
    1856 000043b0     40a1          ADD     A5,A1
    1857 000043c0     b220          MOVE    A1,*A0(OXVEL),L
         000043d0     0020  
    1858 000043e0     07a5          MOVE    @SCROLLY,A5,L
         000043f0 00000050- 
    1859 00004410     b601          MOVE    *A0(OYVEL),A1,L
         00004420     0040  
    1860 00004430     40a1          ADD     A5,A1
    1861 00004440     b220          MOVE    A1,*A0(OYVEL),L
         00004450     0040  
    1862 00004460                   PULL    a1,a5
    1863 00004480     0960          RETS
    1864                    
    1865                    
    1866                    ********************************
    1867                    * Adjust current object image with respect to it's anipt and flip flags
    1868                    * A0=*Object
    1869                    * A2=New YVAL
    1870                    * A3=New XVAL
    1871                    * A4=New FLAGS (Only DMA bits)
    1872                    * Trashes A1,A14,B0-B1
    1873                    * 0A2H=Adjusted YVAL
    1874                    * 0A3H=Adjusted XVAL
    1875                    
    1876 00004490           GANISAG
    1877 00004490                   PUSH    a4,a6,a7
    1878                    
    1879 000044b0                   PUSH    a2
    1880 000044c0     b601          move    *a0(OIMG),a1,L
         000044d0     0170  
    1881 000044e0     8622          move    *a1,a2,L                ;ISIZE
    1882 000044f0     b240          move    a2,*a0(OSIZE),L
         00004500     0130  
    1883 00004510     0d3f          callr   GANIOF
         00004520     019e  
    1884 00004530                   PULL    a2
    1885                    
    1886 00004540     44c3          sub     a6,a3
    1887 00004550     44e2          sub     a7,a2                   ;adjust upper left corner
    1888 00004560     b260          move    a3,*a0(OXVAL),L
         00004570     0080  
    1889 00004580     b240          move    a2,*a0(OYVAL),L
         00004590     00a0  
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   39

    1890                    
    1891 000045a0     b421          move    *a1(ICTRL),a1           ;Get DMA flags
         000045b0     0060  
    1892 000045c0     0b84          andi    0803fH,a4               ;Kill mode bits
         000045d0 ffff7fc0  
    1893 000045f0     5424          or      a1,a4
    1894 00004600     b280          move    a4,*a0(OCTRL),L         ;&OFFSET
         00004610     00f0  
    1895                    
    1896 00004620                   PULL    a4,a6,a7
    1897 00004640     0960          rets
    1898                    
    1899                    
    1900                    ******************************************************************************
    1901                    * Begin an object
    1902                    * A0=XVAL, A1=YVAL, A2=*IMG, A3=ZPOS, A4=FLAGS, A5=OID, A6=XVEL, A7=YVEL
    1903                    * 0A8H=*Obj
    1904                    * Trashes scratch
    1905                    
    1906 00004650           BEGINOBJW
    1907 00004650     07a8          move    @WORLDTLX,a8,L          ;Adjust for world coord
         00004660 00000070- 
    1908 00004680     4100          add     a8,a0
    1909 00004690     1ee4          btst    B_3D,a4
    1910 000046a0     cb04          jrnz    BEGINOBJ                ;No Y add for 3D?
    1911 000046b0     07a8          move    @WORLDTLY,a8,L
         000046c0 00000090- 
    1912 000046e0     4101          add     a8,a1
    1913                    
    1914 000046f0           BEGINOBJ
    1915 000046f0                   PUSH    a2,a3,a4,a6,a7,a9,a10
    1916 00004710     4c09          move    a0,a9                   ;X
    1917 00004720     4c2a          move    a1,a10                  ;Y
    1918                    
    1919 00004730     b640          move    *a2(ICMAP),a0,L         ;Get *palette
         00004740     0070  
    1920                            .if     DEBUG
    1921                            jrnn    bopalerr                ;No palette?
    1922                            .endif
    1923 00004750     0d5f          calla   pal_getf
         00004760 00000000! 
    1924                    
    1925 00004780     07a8  bo20    move    @OFREE,a8,L             ;Pointer to next available obj block
         00004790 00000020+ 
    1926 000047b0     ca45          jrz     begobjerr               ;No objs?
    1927 000047c0     8701          move    *a8,a1,L
    1928 000047d0     0781          move    a1,@OFREE,L             ;Adjust pointer to free list
         000047e0 00000020+ 
    1929                    
    1930 00004800     b208          move    a0,*a8(OPAL),L          ;Set palette & constant
         00004810     0150  
    1931 00004820     5600          clr     a0
    1932 00004830     b208          move    a0,*a8(ODATA_p),L       ;Clr stuff
         00004840     01c0  
    1933 00004850     b208          move    a0,*a8(OXANI),L
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   40

         00004860     01e0  
    1934 00004870     b208          move    a0,*a8(OZVEL),L
         00004880     0060  
    1935 00004890     b008          move    a0,*a8(OMISC)
         000048a0     0210  
    1936                    
    1937 000048b0     b208          move    a0,*a8(ODOFF),L
         000048c0     0220  
    1938 000048d0     09e0          movi    01000100H,a0
         000048e0 01000100  
    1939 00004900     b208          move    a0,*a8(OSCALE),L
         00004910     0240  
    1940                    
    1941 00004920     b068          move    a3,*a8(OZPOS)
         00004930     00d0  
    1942                    
    1943 00004940     b0a8          move    a5,*a8(OID)
         00004950     0190  
    1944 00004960     b2c8          move    a6,*a8(OXVEL),L
         00004970     0020  
    1945 00004980     b2e8          move    a7,*a8(OYVEL),L
         00004990     0040  
    1946                    
    1947 000049a0     4c41          move    a2,a1                   ;*Img
    1948 000049b0     8622          move    *a1,a2,L                ;ISIZE
    1949 000049c0     0d3f          callr   GANIOF                  ;Adjust animation offset
         000049d0     0153  
    1950                    
    1951                    ;here!!!!!!!!!!!!!!
    1952 000049e0     b828          move    *a1(IANIOFFX),*a8(ODXOFF) ;display x offset
         000049f0     0020  
         00004a00     0220  
    1953 00004a10     b828          move    *a1(IANIOFFY),*a8(ODYOFF) ;display y offset
         00004a20     0030  
         00004a30     0230  
    1954                    
    1955 00004a40     b623          move    *a1(ISAG),a3,L          ;Get top left sag
         00004a50     0040  
    1956                    
    1957                    ;;;     sub     a6,a9                   ;- x anioff
    1958                    ;;;     sub     a7,a10                  ;- y anioff
    1959 00004a60     b328          move    a9,*a8(OXVAL),L
         00004a70     0080  
    1960 00004a80     b348          move    a10,*a8(OYVAL),L
         00004a90     00a0  
    1961                    
    1962 00004aa0     b228          move    a1,*a8(OIMG),L
         00004ab0     0170  
    1963 00004ac0     b248          move    a2,*a8(OSIZE),L
         00004ad0     0130  
    1964 00004ae0     b268          move    a3,*a8(OSAG),L
         00004af0     0110  
    1965 00004b00     b088          move    a4,*a8(OFLAGS)
         00004b10     00e0  
    1966 00004b20     b420          move    *a1(ICTRL),a0           ;Get DMA flags
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   41

         00004b30     0060  
    1967 00004b40     0b84          andi    0803fH,a4               ;Kill mode bits
         00004b50 ffff7fc0  
    1968 00004b70     5404          or      a0,a4
    1969 00004b80     b288          move    a4,*a8(OCTRL),L         ;&OFSET
         00004b90     00f0  
    1970                    
    1971 00004ba0                   PULL    a2,a3,a4,a6,a7,a9,a10
    1972                    
    1973 00004bc0     b3a8          move    a13,*a8(OPLINK),L
         00004bd0     01a0  
    1974 00004be0     4d00          move    a8,a0
    1975 00004bf0     c000          jruc    INSOBJ                  ;Insert object into list
         00004c00     fea6  
    1976                    
    1977                    
    1978                            .if     DEBUG
    1979                    bopalerr
    1980                            LOCKUP                          ;Object doesn't have pallette!
    1981                            eint
    1982                            clr     a0
    1983                            jruc    bo20
    1984                            .endif
    1985                    
    1986 00004c10           begobjerr
    1987                            .if     DEBUG
    1988                            LOCKUP                          ;Out of objects!
    1989                            eint
    1990                            .else
    1991 00004c10                   CALLERR 3,7
    1992                            .endif
    1993 00004cc0     07a8          move    @OBJLST,a8,L            ;Pass 1st obj on list
         00004cd0 00000000+ 
    1994 00004cf0                   PULL    a2,a3,a4,a6,a7,a9,a10
    1995 00004d10     0960          rets
    1996                    
    1997                    
    1998                    
    1999                    *******************************
    2000                    * Begin an object with specified palette
    2001                    * A0=XVAL, A1=YVAL, A2=*IMG, A3=ZPOS, A4=FLAGS, A5=OID, A6=XVEL, A7=YVEL
    2002                    * B0=*Palette
    2003                    * 0A8H=*Obj
    2004                    * Trashes scratch
    2005                    
    2006 00004d20           BEGINOBJWP
    2007 00004d20     07a8          move    @WORLDTLX,a8,L          ;Adjust for world coord
         00004d30 00000070- 
    2008 00004d50     4100          add     a8,a0
    2009 00004d60     1ee4          btst    B_3D,a4
    2010 00004d70     cb04          jrnz    BEGINOBJP               ;No Y add for 3D?
    2011 00004d80     07a8          move    @WORLDTLY,a8,L
         00004d90 00000090- 
    2012 00004db0     4101          add     a8,a1
    2013                    
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   42

    2014 00004dc0           BEGINOBJP
    2015 00004dc0                   PUSH    a2,a3,a4,a6,a7,a9,a10
    2016 00004de0     4c09          move    a0,a9                   ;X
    2017 00004df0     4c2a          move    a1,a10                  ;Y
    2018                    
    2019 00004e00     4e10          move    b0,a0                   ;Get *palette
    2020                            .if     DEBUG
    2021                            jrnn    uqyebopalerr            ;No pallette?
    2022                            .endif
    2023 00004e10     0d5f          calla   pal_getf
         00004e20 00000000! 
    2024                    
    2025 00004e40     07a8  uqyebo20        move    @OFREE,a8,L             ;Pointer to next available obj block
         00004e50 00000020+ 
    2026 00004e70     cad9          jrz     begobjerr               ;No objs?
    2027 00004e80     8701          move    *a8,a1,L
    2028 00004e90     0781          move    a1,@OFREE,L             ;Adjust pointer to free list
         00004ea0 00000020+ 
    2029                    
    2030 00004ec0     b208          move    a0,*a8(OPAL),L          ;Set pallette & constant
         00004ed0     0150  
    2031 00004ee0     5600          clr     a0
    2032 00004ef0     b208          move    a0,*a8(ODATA_p),L       ;Clr stuff
         00004f00     01c0  
    2033 00004f10     b208          move    a0,*a8(OXANI),L
         00004f20     01e0  
    2034 00004f30     b208          move    a0,*a8(OZVEL),L
         00004f40     0060  
    2035 00004f50     b008          move    a0,*a8(OMISC)
         00004f60     0210  
    2036                    
    2037 00004f70     b208          move    a0,*a8(ODOFF),L
         00004f80     0220  
    2038 00004f90     09e0          movi    01000100H,a0
         00004fa0 01000100  
    2039 00004fc0     b208          move    a0,*a8(OSCALE),L
         00004fd0     0240  
    2040                    
    2041 00004fe0     b068          move    a3,*a8(OZPOS)
         00004ff0     00d0  
    2042                    
    2043 00005000     b0a8          move    a5,*a8(OID)
         00005010     0190  
    2044 00005020     b2c8          move    a6,*a8(OXVEL),L
         00005030     0020  
    2045 00005040     b2e8          move    a7,*a8(OYVEL),L
         00005050     0040  
    2046                    
    2047 00005060     4c41          move    a2,a1                   ;*Img
    2048 00005070     8622          move    *a1,a2,L                ;ISIZE
    2049 00005080     0d3f          callr   GANIOF                  ;Adjust animation offset
         00005090     00e7  
    2050                    
    2051                    ;here!!!!!!!!!!!!!!
    2052 000050a0     b828          move    *a1(IANIOFFX),*a8(ODXOFF) ;display x offset
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   43

         000050b0     0020  
         000050c0     0220  
    2053 000050d0     b828          move    *a1(IANIOFFY),*a8(ODYOFF) ;display y offset
         000050e0     0030  
         000050f0     0230  
    2054                    
    2055 00005100     b623          move    *a1(ISAG),a3,L          ;Get top left sag
         00005110     0040  
    2056                    
    2057                    ;;;     sub     a6,a9                   ;- x anioff
    2058                    ;;;     sub     a7,a10                  ;- y anioff
    2059 00005120     b328          move    a9,*a8(OXVAL),L
         00005130     0080  
    2060 00005140     b348          move    a10,*a8(OYVAL),L
         00005150     00a0  
    2061                    
    2062 00005160     b228          move    a1,*a8(OIMG),L
         00005170     0170  
    2063 00005180     b248          move    a2,*a8(OSIZE),L
         00005190     0130  
    2064 000051a0     b268          move    a3,*a8(OSAG),L
         000051b0     0110  
    2065 000051c0     b088          move    a4,*a8(OFLAGS)
         000051d0     00e0  
    2066 000051e0     b420          move    *a1(ICTRL),a0           ;Get DMA flags
         000051f0     0060  
    2067 00005200     0b84          andi    0803fH,a4               ;Kill mode bits
         00005210 ffff7fc0  
    2068 00005230     5404          or      a0,a4
    2069 00005240     b288          move    a4,*a8(OCTRL),L         ;&OFSET
         00005250     00f0  
    2070                    
    2071 00005260                   PULL    a2,a3,a4,a6,a7,a9,a10
    2072                    
    2073 00005280     b3a8          move    a13,*a8(OPLINK),L
         00005290     01a0  
    2074 000052a0     4d00          move    a8,a0
    2075 000052b0     c000          jruc    INSOBJ                  ;Insert object into list
         000052c0     fe3a  
    2076                    
    2077                    
    2078                            .if     DEBUG
    2079                    uqyebopalerr
    2080                            LOCKUP                          ;Object doesn't have pallette!
    2081                            eint
    2082                            clr     a0
    2083                            jruc    uqyebo20
    2084                            .endif
    2085                    
    2086                    
    2087                    *******************************
    2088                    * Set new image for an object
    2089                    * A1=*Image hdr
    2090                    * A4=New FLAGS
    2091                    * A8=*Obj
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   44

    2092                    * Trashes A1,A14
    2093                    
    2094 000052d0            SUBR   ANI
    2095                    
    2096 000052d0                   PUSH    a0,a2,a3,a4,a5,a6,a7
    2097                    
    2098 000052f0     0b61          cmpi    ROM,a1
         00005300 f87fffff  
    2099 00005320     c82f          jrlo    anierr
    2100                    
    2101 00005330     4c23          move    a1,a3
    2102 00005340     4c85          move    a4,a5
    2103 00005350     b701          move    *a8(OIMG),a1,L
         00005360     0170  
    2104 00005370     b504          move    *a8(OCTRL),a4
         00005380     00f0  
    2105 00005390     4823          cmp     a1,a3
    2106 000053a0     cb03          jrne    ogjc1                   ;Different img?
    2107                    
    2108 000053b0     0505          sext    a5
    2109 000053c0     4885          cmp     a4,a5
    2110 000053d0     ca21          jreq    ogjcx                   ;All the same?
    2111                    
    2112 000053e0     b702  ogjc1   move    *a8(OSIZE),a2,L
         000053f0     0130  
    2113 00005400     0d3f          callr   GANIOF                  ;Get old animation offset
         00005410     00af  
    2114 00005420     4c61          move    a3,a1                   ;New OIMG
    2115 00005430     2f44          srl     6,a4
    2116 00005440     24c4          sll     6,a4
    2117 00005450     54a4          or      a5,a4                   ;Set new OCTRL
    2118 00005460     4cc0          move    a6,a0
    2119 00005470     4ce5          move    a7,a5
    2120 00005480     b623          move    *a1(ISAG),a3,L          ;Get top left sag
         00005490     0040  
    2121 000054a0     8622          move    *a1,a2,L                ;ISIZE
    2122 000054b0     0d3f          callr   GANIOF                  ;Get new animation offset
         000054c0     00a4  
    2123 000054d0     b228          move    a1,*a8(OIMG),L
         000054e0     0170  
    2124 000054f0     44c0          sub     a6,a0                   ;Subtract new from old
    2125 00005500     44e5          sub     a7,a5
    2126 00005510     0524          zext    a4                      ;Zero offset in A4
    2127                    
    2128 00005520     4d06          move    a8,a6                   ;Get push address of octrl,osag,osize
    2129 00005530     0b06          addi    OCTRL+060H,a6
         00005540     0150  
    2130 00005550     0986          mmtm    a6,a2,a3,a4             ;Save new data
         00005560     3800  
    2131                    
    2132 00005570     0be6          subi    OCTRL-OXVAL,a6
         00005580     ff8f  
    2133 00005590     86c7          move    *a6,a7,L                ;New OXVAL
    2134 000055a0     4007          add     a0,a7
    2135 000055b0     92e6          move    a7,*a6+,L
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   45

    2136 000055c0     86c7          move    *a6,a7,L                ;New OYVAL
    2137 000055d0     40a7          add     a5,a7
    2138 000055e0     82e6          move    a7,*a6,L
    2139                    
    2140 000055f0           ogjcx   PULL    a0,a2,a3,a4,a5,a6,a7
    2141 00005610     0960          rets
    2142                    
    2143 00005620           anierr
    2144                            .if     DEBUG
    2145                            LOCKUP
    2146                            eint
    2147                            .else
    2148 00005620                   CALLERR 2,7
    2149                            .endif
    2150 000056d0     c0f1          jruc    ogjcx
    2151                    
    2152                    
    2153                    *****************************************************************************
    2154                    * Change an objects image (Doesn't check VFLIP)
    2155                    * A0=*New image
    2156                    * A1=New flip flags & const
    2157                    * A8=*Obj
    2158                    * Trashes scratch
    2159                    
    2160 000056e0            SUBRP  obj_aniq
    2161                    
    2162                    
    2163 000056e0                   PUSH    a2,a3
    2164                    
    2165 00005700     0b60          cmpi    ROM,a0
         00005710 f87fffff  
    2166 00005730     c826          jrlo    iasdanierr
    2167                    
    2168 00005740     4c02          move    a0,a2
    2169 00005750     4c23          move    a1,a3
    2170                    
    2171 00005760     0d3f          callr   anipt_getxy
         00005770     002e  
    2172                    
    2173 00005780     b248          move    a2,*a8(OIMG),L
         00005790     0170  
    2174 000057a0     ba48          move    *a2(0),*a8(OSIZE),L
         000057b0     0000  
         000057c0     0130  
    2175 000057d0     ba48          move    *a2(ISAG),*a8(OSAG),L
         000057e0     0040  
         000057f0     0110  
    2176                    
    2177 00005800     0545          setf    5,0,0
    2178 00005810     b848          move    *a2(ICTRL+7),*a8(OCTRL+7) ;Write 5 z comp bits
         00005820     0067  
         00005830     00f7  
    2179 00005840     0546          setf    6,0,0
    2180 00005850     b068          move    a3,*a8(OCTRL)           ;Write 6 low bits
         00005860     00f0  
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   46

    2181 00005870     0570          setf    16,1,0
    2182                    
    2183 00005880     4c02          move    a0,a2
    2184 00005890     4c23          move    a1,a3
    2185 000058a0     0d3f          callr   anipt_getxy
         000058b0     001a  
    2186                    
    2187 000058c0     4402          sub     a0,a2                   ;Subtract new from old
    2188 000058d0     4423          sub     a1,a3
    2189                    
    2190 000058e0     4d00          move    a8,a0                   ;Get base address
    2191 000058f0     0b00          addi    OXVAL,a0
         00005900     0080  
    2192 00005910     860e          move    *a0,a14,L               ;New OXVAL
    2193 00005920     404e          add     a2,a14
    2194 00005930     93c0          move    a14,*a0+,L
    2195 00005940     860e          move    *a0,a14,L               ;New OYVAL
    2196 00005950     406e          add     a3,a14
    2197 00005960     83c0          move    a14,*a0,L
    2198                    
    2199 00005970           iasdx   PULL    a2,a3
    2200 00005990     0960          rets
    2201                    
    2202 000059a0           iasdanierr 
    2203                            .if     DEBUG
    2204                            LOCKUP
    2205                            eint
    2206                            .else
    2207 000059a0                   CALLERR 2,2
    2208                            .endif
    2209 00005a50     c0f1          jruc    iasdx
    2210                    
    2211                    
    2212                    *******************************
    2213                    * Get an objects anipt XY (Doesn't check VFLIP)
    2214                    * A8=*Obj
    2215                    * 0A0H=Scaled Ani X (16:16)
    2216                    * 0A1H=Scaled Ani Y
    2217                    * Trashes scratch
    2218                    
    2219 00005a60            SUBRP  anipt_getxy
    2220                    
    2221 00005a60     4e40          move    a2,b0
    2222                    
    2223 00005a70     b702          move    *a8(OIMG),a2,L
         00005a80     0170  
    2224                    
    2225 00005a90     b440          move    *a2(IANIOFFX),a0
         00005aa0     0020  
    2226 00005ab0     2600          sll     16,a0
    2227 00005ac0     b441          move    *a2(IANIOFFY),a1
         00005ad0     0030  
    2228 00005ae0     2601          sll     16,a1
    2229                    
    2230 00005af0     b50e          move    *a8(OCTRL),a14
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   47

         00005b00     00f0  
    2231 00005b10     1f6e          btst    B_FLIPH,a14
    2232 00005b20     ca05          jrz     newux                   ;No flip?
    2233                    
    2234 00005b30     8442          move    *a2,a2                  ;ISIZEX
    2235 00005b40     1422          subk    1,a2
    2236 00005b50     2602          sll     16,a2                   ;*64K
    2237 00005b60     03a0          neg     a0
    2238 00005b70     4040          add     a2,a0                   ;+size
    2239                    
    2240                    
    2241 00005b80     4e12  newux   move    b0,a2
    2242 00005b90     0960          rets
    2243                    
    2244                    
    2245                    
    2246                    *******************************
    2247                    * Change an objects image (doesn't check flip flags)
    2248                    * A0=*New image
    2249                    * A1=New OCTRL
    2250                    * A8=*Obj
    2251                    * Trashes scratch
    2252                    
    2253 00005ba0            SUBRP  obj_aniq_cnoff
    2254                    
    2255 00005ba0     4e40          move    a2,b0
    2256                    
    2257 00005bb0     b028          move    a1,*a8(OCTRL)           ;Write new ctrl
         00005bc0     00f0  
    2258                    
    2259 00005bd0     b70e          move    *a8(OIMG),a14,L
         00005be0     0170  
    2260 00005bf0     b5c2          move    *a14(IANIOFFX),a2
         00005c00     0020  
    2261 00005c10     b5ce          move    *a14(IANIOFFY),a14
         00005c20     0030  
    2262                    
    2263 00005c30     b208          move    a0,*a8(OIMG),L
         00005c40     0170  
    2264 00005c50     ba08          move    *a0(0),*a8(OSIZE),L
         00005c60     0000  
         00005c70     0130  
    2265 00005c80     ba08          move    *a0(ISAG),*a8(OSAG),L
         00005c90     0040  
         00005ca0     0110  
    2266                    
    2267 00005cb0     b401          move    *a0(IANIOFFY),a1
         00005cc0     0030  
    2268 00005cd0     b400          move    *a0(IANIOFFX),a0
         00005ce0     0020  
    2269                    
    2270 00005cf0     4402          sub     a0,a2                   ;Subtract new from old
    2271 00005d00     442e          sub     a1,a14
    2272 00005d10     2602          sll     16,a2
    2273 00005d20     260e          sll     16,a14
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   48

    2274                    
    2275 00005d30     4d00          move    a8,a0                   ;Get base address
    2276 00005d40     0b00          addi    OXVAL,a0
         00005d50     0080  
    2277 00005d60     8601          move    *a0,a1,L                ;New OXVAL
    2278 00005d70     4041          add     a2,a1
    2279 00005d80     9220          move    a1,*a0+,L
    2280 00005d90     8601          move    *a0,a1,L                ;New OYVAL
    2281 00005da0     41c1          add     a14,a1
    2282 00005db0     8220          move    a1,*a0,L
    2283                    
    2284 00005dc0     4e12          move    b0,a2
    2285 00005dd0     0960          rets
    2286                    
    2287                    
    2288                    
    2289                    ;*******************************
    2290                    ;* Change an scaled objects image (Doesn't check VFLIP)
    2291                    ;* A0=*New image
    2292                    ;* A1=New OCTRL (low 8 bits)
    2293                    ;* A8=*Obj
    2294                    ;* Trashes scratch, A2,A3
    2295                    ;
    2296                    ;
    2297                    ; SUBRP obj_aniq_scld
    2298                    ;
    2299                    ;
    2300                    ;       cmpi    ROM,a0
    2301                    ;       jrlo    ksotanierr
    2302                    ;
    2303                    ;       move    a0,a2
    2304                    ;       move    a1,a3
    2305                    ;
    2306                    ;;;;    calla   anipt_getsclxy
    2307                    ;
    2308                    ;       movb    a3,*a8(OCTRL)
    2309                    ;
    2310                    ;       move    a2,*a8(OIMG),L
    2311                    ;       move    *a2(0),*a8(OSIZE),L
    2312                    ;       move    *a2(ISAG),*a8(OSAG),L
    2313                    ;
    2314                    ;       move    a0,a2
    2315                    ;       move    a1,a3
    2316                    ;;;;    calla   anipt_getsclxy
    2317                    ;
    2318                    ;       sub     a0,a2                   ;Subtract new from old
    2319                    ;       sub     a1,a3
    2320                    ;
    2321                    ;       move    a0,*a8(OXANI),L         ;Save scaled anipt
    2322                    ;
    2323                    ;       move    a8,a0                   ;Get base address
    2324                    ;       addi    OXVAL,a0
    2325                    ;       move    *a0,a14,L               ;New OXVAL
    2326                    ;       add     a2,a14
    2327                    ;       move    a14,*a0+,L
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   49

    2328                    ;       move    *a0,a14,L               ;New OYVAL
    2329                    ;       add     a3,a14
    2330                    ;       move    a14,*a0,L
    2331                    ;
    2332                    ;ksotx  rets
    2333                    ;
    2334                    ;
    2335                    ;ksotanierr 
    2336                    ;       .if     DEBUG
    2337                    ;       LOCKUP
    2338                    ;       eint
    2339                    ;       .else
    2340                    ;       CALLERR 2,0
    2341                    ;       .endif
    2342                    ;       jruc    ksotx
    2343                    
    2344                    
    2345                    
    2346                    ********************************
    2347                    * Get the x and y positions of an objects animation point
    2348                    * A8=*Object
    2349                    * Trashes scratch
    2350                    * 0A2H=Ani pt Y 16:16
    2351                    * 0A3H=Ani pt X 16:16
    2352                    
    2353 00005de0           GETANIXY
    2354 00005de0                   PUSH    a4,a6,a7
    2355 00005e00     b701          move    *a8(OIMG),a1,L
         00005e10     0170  
    2356 00005e20     b702          move    *a8(OSIZE),a2,L
         00005e30     0130  
    2357 00005e40     b504          move    *a8(OCTRL),a4
         00005e50     00f0  
    2358 00005e60     0d3f          callr   GANIOF
         00005e70     0009  
    2359 00005e80     b703          move    *a8(OXVAL),a3,L
         00005e90     0080  
    2360 00005ea0     b702          move    *a8(OYVAL),a2,L
         00005eb0     00a0  
    2361 00005ec0     40c3          add     a6,a3
    2362 00005ed0     40e2          add     a7,a2
    2363 00005ee0                   PULL    a4,a6,a7
    2364 00005f00     0960          rets
    2365                    
    2366                    
    2367                    ********************************
    2368                    * Get animation offset (Fast!)
    2369                    * A1=*Image header, A2=H:W, A4=OCTRL
    2370                    * Trashes A14
    2371                    *Rets:
    2372                    * A6=X ani offset * 64K
    2373                    * A7=Y ani offset * 64K
    2374                    
    2375 00005f10           GANIOF
    2376 00005f10     b626          move    *a1(IANIOFF),a6,L
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   50

         00005f20     0020  
    2377 00005f30     0b66          cmpi    IROM,a6
         00005f40 fdffffff  
    2378 00005f60     c513          jrge    vitjerr
    2379                    
    2380 00005f70     56e7  vitjh   clr     a7
    2381 00005f80     eec7          movy    a6,a7
    2382 00005f90     2606          sll     16,a6           ;Move to upper word
    2383                    
    2384 00005fa0     1f64          btst    B_FLIPH,a4
    2385 00005fb0     ca05          jrz     vitjv
    2386 00005fc0     4c4e          move    a2,a14
    2387 00005fd0     142e          subk    1,a14
    2388 00005fe0     260e          sll     16,a14          ;Move W to upper word
    2389 00005ff0     03a6          neg     a6
    2390 00006000     41c6          add     a14,a6          ;Sub Width-1
    2391                    
    2392 00006010     1f44  vitjv   btst    B_FLIPV,a4
    2393 00006020     ca06          jrz     vitjx
    2394 00006030     4c4e          move    a2,a14
    2395 00006040     03a7          neg     a7
    2396 00006050     2e0e          srl     16,a14
    2397 00006060     142e          subk    1,a14
    2398 00006070     260e          sll     16,a14
    2399 00006080     41c7          add     a14,a7          ;Sub Hgt-1
    2400                    
    2401 00006090     0960  vitjx   rets
    2402                    
    2403 000060a0     56c6  vitjerr clr     a6
    2404 000060b0     c0eb          jruc    vitjh
    2405                    
    2406                    
    2407                    *******************************
    2408                    * Scale screen out (JSRP)
    2409                    
    2410                            .asg    SCRATCH+8*256*1024,SCRNBUF
    2411                            .asg    SCRNBUF+8*128*1024,PALBUF
    2412                    
    2413 0005c0c0                   .bss    scrnscl         ,16
    2414                    
    2415 000060c0            SUBR   scrn_scaleout
    2416                    
    2417 000060c0     1820          movk    1,a0
    2418 000060d0     0580          move    a0,@HALT
         000060e0 00000000! 
    2419                    
    2420 00006100     05a0          move    @dtype,a0
         00006110 00000120- 
    2421 00006130                   PUSHP   a0
    2422 00006140     05a0          move    @gndstat,a0
         00006150 0005b530- 
    2423 00006170                   PUSHP   a0
    2424                    
    2425 00006180     09c0          movi    0160H,a0
         00006190     0160  
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   51

    2426 000061a0     0580          move    a0,@scrnscl
         000061b0 0005c0c0- 
    2427                    
    2428 000061d0     09e0          movi    ubpqinitcode,a0
         000061e0 000064d0' 
    2429 00006200     0780          move    a0,@dcode_p,L
         00006210 00000130- 
    2430                    
    2431 00006230     09c0          movi    -1,a0
         00006240     ffff  
    2432 00006250     0580          move    a0,@dtype
         00006260 00000120- 
    2433 00006280     5600          clr     a0
    2434 00006290     0580          move    a0,@gndstat
         000062a0 0005b530- 
    2435 000062c0     0580          move    a0,@IRQSKYE
         000062d0 00000000! 
    2436                    
    2437 000062f0           ubpqlp  SLEEPK  1
    2438                    
    2439 00006330     09ee          movi    scrnscl,a14
         00006340 0005c0c0- 
    2440 00006360     85c5          move    *a14,a5
    2441 00006370     4ca0          move    a5,a0
    2442 00006380     2fa0          srl     3,a0
    2443 00006390     4005          add     a0,a5
    2444 000063a0     80ae          move    a5,*a14
    2445 000063b0     0b45          cmpi    07000H,a5
         000063c0     8fff  
    2446 000063d0     c4f1          jrlt    ubpqlp
    2447                    
    2448 000063e0     5600          clr     a0
    2449 000063f0     0780          move    a0,@dcode_p,L
         00006400 00000130- 
    2450                    
    2451 00006420                   PULLP   a0
    2452 00006430     0580          move    a0,@gndstat
         00006440 0005b530- 
    2453 00006460                   PULLP   a0
    2454 00006470     0580          move    a0,@dtype
         00006480 00000120- 
    2455                    
    2456                    
    2457 000064a0                   RETP
    2458                    
    2459 000064d0           ubpqinitcode
    2460 000064d0     0d3f          callr   scrn_copy
         000064e0     0072  
    2461 000064f0     09e0          movi    scrn_scale,a0
         00006500 00007710' 
    2462 00006520     0780          move    a0,@dcode_p,L
         00006530 00000130- 
    2463 00006550     0160          jump    a0
    2464                    
    2465                    
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   52

    2466                    *******************************
    2467                    * Initialization for scrn_scalein (JSRP)
    2468                    
    2469 00006560            SUBR   scrn_scaleininit
    2470                    
    2471 00006560     0360          dint
    2472 00006570     05a0  hbqjlp  move    @VCOUNT,a0
         00006580 c00001d0  
    2473 000065a0     0b40          cmpi    EOSINT,a0
         000065b0     feed  
    2474 000065c0     c4fa          jrlt    hbqjlp
    2475 000065d0     05a0          move    @HSBLNK,a0      ;Blank screen
         000065e0 c0000020  
    2476 00006600     0580          move    a0,@HEBLNK
         00006610 c0000010  
    2477 00006630     0d60          eint
    2478 00006640                   SLEEPK  2
    2479                    
    2480 00006680                   RETP
    2481                    
    2482                    *******************************
    2483                    * Scale screen in (JSRP)
    2484                    
    2485 000066b0            SUBR   scrn_scalein
    2486                    
    2487 000066b0                   PUSHP   a8
    2488                    
    2489 000066c0     05a0          move    @HALT,a0
         000066d0 00000000! 
    2490 000066f0                   PUSHP   a0
    2491 00006700     1820          movk    1,a0
    2492 00006710     0580          move    a0,@HALT
         00006720 00000000! 
    2493                    
    2494 00006740     05a0          move    @dtype,a0
         00006750 00000120- 
    2495 00006770                   PUSHP   a0
    2496 00006780     05a0          move    @gndstat,a0
         00006790 0005b530- 
    2497 000067b0                   PUSHP   a0
    2498 000067c0     07a0          move    @dcode_p,a0,L
         000067d0 00000130- 
    2499 000067f0                   PUSHP   a0
    2500                    
    2501 00006800     09c0          movi    07000H,a0
         00006810     7000  
    2502 00006820     0580          move    a0,@scrnscl
         00006830 0005c0c0- 
    2503                    
    2504 00006850     09e0          movi    gbasinitcode,a0
         00006860 00006b70' 
    2505 00006880     0780          move    a0,@dcode_p,L
         00006890 00000130- 
    2506 000068b0     09c0          movi    -1,a0
         000068c0     ffff  
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   53

    2507 000068d0     0580          move    a0,@dtype
         000068e0 00000120- 
    2508 00006900     5600          clr     a0
    2509 00006910     0580          move    a0,@gndstat
         00006920 0005b530- 
    2510                    
    2511                    
    2512                            .if     DEBUG
    2513                    ;       movi    01a0H,a0
    2514                    ;       move    a0,@scrnscl
    2515                    ;       SLEEP   TSEC*2
    2516                            .endif
    2517                    
    2518                    
    2519 00006940           gbaslp  SLEEPK  1
    2520                    
    2521 00006980     09ee          movi    scrnscl,a14
         00006990 0005c0c0- 
    2522 000069b0     85c5          move    *a14,a5
    2523 000069c0     4ca0          move    a5,a0
    2524 000069d0     2fc0          srl     2,a0
    2525 000069e0     4405          sub     a0,a5
    2526 000069f0     80ae          move    a5,*a14
    2527 00006a00     0b45          cmpi    0100H,a5
         00006a10     feff  
    2528 00006a20     c7f1          jrgt    gbaslp
    2529                    
    2530                    
    2531 00006a30                   PULLP   a0
    2532 00006a40     0780          move    a0,@dcode_p,L
         00006a50 00000130- 
    2533 00006a70                   PULLP   a0
    2534 00006a80     0580          move    a0,@gndstat
         00006a90 0005b530- 
    2535 00006ab0                   PULLP   a0
    2536 00006ac0     0580          move    a0,@dtype
         00006ad0 00000120- 
    2537                    
    2538 00006af0                   PULLP   a0
    2539 00006b00     0580          move    a0,@HALT
         00006b10 00000000! 
    2540                    
    2541                    
    2542 00006b30                   PULLP   a8
    2543 00006b40                   RETP
    2544                    
    2545                    
    2546 00006b70           gbasinitcode
    2547 00006b70     0d3f          callr   scrn_copy
         00006b80     0008  
    2548 00006b90     09e0          movi    scrn_scaledison,a0
         00006ba0 00007660' 
    2549 00006bc0     0780          move    a0,@dcode_p,L
         00006bd0 00000130- 
    2550 00006bf0     c000          jruc    scrn_scale
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   54

         00006c00     00b0  
    2551                    
    2552                    
    2553                    *******************************
    2554                    * B2=Y offset for top of page : XPad offset
    2555                    * Trashes A0-A3,A7
    2556                    
    2557 00006c10            SUBRP  scrn_copy
    2558                    
    2559 00006c10     4e50          move    b2,a0
    2560 00006c20     2e00          srl     16,a0
    2561 00006c30     0bc0          xori    0100H,a0                        ;Flip to the page being shown
         00006c40 00000100  
    2562 00006c60     2580          sll     12,a0                   ;*512*8
    2563 00006c70     0b00          addi    SCRNXP*8,a0             ;A0=*Scrn mem
         00006c80     01c0  
    2564 00006c90                   PUSH    a0
    2565                    
    2566 00006ca0     09e1          movi    SCRNBUF,a1
         00006cb0 01200000  
    2567 00006cd0     09c3          movi    254,a3
         00006ce0     00fe  
    2568 00006cf0     09c7          movi    (512-400)*8,a7
         00006d00     0380  
    2569 00006d10           nrelcslp
    2570 00006d10     09c2          movi    400/16,a2
         00006d20     0019  
    2571 00006d30     9a01  nrelcslp2       move    *a0+,*a1+,L
    2572 00006d40     9a01          move    *a0+,*a1+,L
    2573 00006d50     9a01          move    *a0+,*a1+,L
    2574 00006d60     9a01          move    *a0+,*a1+,L
    2575 00006d70     3ca2          dsj     a2,nrelcslp2
    2576                    
    2577 00006d80     40e0          add     a7,a0
    2578 00006d90     40e1          add     a7,a1
    2579 00006da0     3d43          dsj     a3,nrelcslp
    2580                    
    2581                    
    2582 00006db0     05a0          move    @SYSCOPY,a0
         00006dc0 00000000! 
    2583                            .if     WWFUNIT
    2584 00006de0     0b80          andni   PALENB,a0
         00006df0 00000800  
    2585 00006e10     0580          move    a0,@SYSCOPY
         00006e20 00000000! 
    2586                            .if     DEBUG
    2587                            andni   LEDON,a0
    2588                            ori     WROMINTCLR,a0
    2589                            .endif
    2590                            .else
    2591                            andni   100000b,a0
    2592                            move    a0,@SYSCOPY
    2593                            .if     DEBUG
    2594                            andni   1000000b,a0
    2595                            .endif
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   55

    2596                            .endif
    2597 00006e40     0580          move    a0,@SYSCTRL
         00006e50 01b00000  
    2598                    
    2599                    
    2600 00006e70                   PULL    a0
    2601 00006e80     09e1          movi    PALBUF,a1
         00006e90 01300000  
    2602 00006eb0     09c3          movi    254,a3
         00006ec0     00fe  
    2603 00006ed0           nrelcplp
    2604 00006ed0     09c2          movi    400/16,a2
         00006ee0     0019  
    2605 00006ef0     9a01  nrelcplp2       move    *a0+,*a1+,L
    2606 00006f00     9a01          move    *a0+,*a1+,L
    2607 00006f10     9a01          move    *a0+,*a1+,L
    2608 00006f20     9a01          move    *a0+,*a1+,L
    2609 00006f30     3ca2          dsj     a2,nrelcplp2
    2610                    
    2611 00006f40     40e0          add     a7,a0
    2612 00006f50     40e1          add     a7,a1
    2613 00006f60     3d43          dsj     a3,nrelcplp
    2614                    
    2615 00006f70     05a0          move    @SYSCOPY,a0
         00006f80 00000000! 
    2616                    
    2617                    
    2618                            .if     WWFUNIT
    2619 00006fa0     0ba0          ori     PALENB,a0
         00006fb0 00000800  
    2620 00006fd0     0580          move    a0,@SYSCOPY
         00006fe0 00000000! 
    2621                            .if     DEBUG
    2622                            andni   LEDON,a0
    2623                            ori     WROMINTCLR,a0
    2624                            .endif
    2625                            .else
    2626                            ori     100000b,a0
    2627                            move    a0,@SYSCOPY
    2628                            .if     DEBUG
    2629                            andni   1000000b,a0
    2630                            .endif
    2631                            .endif
    2632 00007000     0580          move    a0,@SYSCTRL
         00007010 01b00000  
    2633                    
    2634                    
    2635 00007030     0960          rets
    2636                    
    2637                    
    2638                    *******************************
    2639                    * Copy screen data (throw out 1 in 5 pixels)
    2640                    * B2=Y offset for top of page : XPad offset
    2641                    
    2642 00007040            SUBRP  scrn_scale140
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   56

    2643                    
    2644 00007040                   PUSH    a4,a14
    2645                    
    2646 00007060     09c5          movi    0140H,a5
         00007070     0140  
    2647                    
    2648 00007080     4e51          move    b2,a1
    2649 00007090     2e01          srl     16,a1
    2650 000070a0     0b01          addi    25,a1
         000070b0     0019  
    2651 000070c0     2581          sll     12,a1                   ;*512*8
    2652 000070d0     0b01          addi    SCRNXP*8+40*8,a1        ;A1=*Scrn mem
         000070e0     0300  
    2653                    
    2654 000070f0     09e6          movi    DMACMAP,a6
         00007100 01a00080  
    2655 00007120     56e7          clr     a7                      ;Y line 8:8
    2656 00007130           cqyulp
    2657 00007130     4ce2          move    a7,a2
    2658 00007140     2f02          srl     8,a2
    2659 00007150     2582          sll     12,a2                   ;*512*8
    2660 00007160     4c43          move    a2,a3
    2661                    
    2662 00007170     0b22          addi    SCRNBUF,a2
         00007180 01200000  
    2663 000071a0     0b23          addi    PALBUF,a3
         000071b0 01300000  
    2664 000071d0     09d0          movi    400/2/5,b0              ;Copy 1 line
         000071e0     0028  
    2665 000071f0           cqyucslp
    2666 000071f0     8866          move    *a3,*a6                 ;Set pal latch
    2667 00007200     1203          addk    16,a3
    2668 00007210     9841          move    *a2+,*a1+               ;Copy 2 pixels
    2669                    
    2670 00007220     8866          move    *a3,*a6
    2671 00007230     1203          addk    16,a3
    2672 00007240     9841          move    *a2+,*a1+
    2673                    
    2674 00007250     8866          move    *a3,*a6
    2675 00007260     1203          addk    16,a3
    2676 00007270     9841          move    *a2+,*a1+
    2677                    
    2678 00007280     8866          move    *a3,*a6
    2679 00007290     1203          addk    16,a3
    2680 000072a0     9841          move    *a2+,*a1+
    2681                    
    2682 000072b0     1203          addk    16,a3
    2683 000072c0     1202          addk    16,a2
    2684                    
    2685 000072d0     3df0          dsj     b0,cqyucslp
    2686                    
    2687 000072e0     0b01          addi    (512-320)*8,a1
         000072f0     0600  
    2688                    
    2689 00007300     40a7          add     a5,a7
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   57

    2690 00007310     0b67          cmpi    254<<8,a7
         00007320 ffff01ff  
    2691 00007340     c4de          jrlt    cqyulp
    2692                    
    2693                    
    2694 00007350           cqyux   PULL    a4,a14
    2695 00007370     0960          rets
    2696                    
    2697                    
    2698                    
    2699                    *******************************
    2700                    * Copy screen data (throw out 1 in 3 pixels)
    2701                    * B2=Y offset for top of page : XPad offset
    2702                    
    2703 00007380            SUBRP  scrn_scale180
    2704                    
    2705 00007380                   PUSH    a4,a14
    2706                    
    2707 000073a0     09c5          movi    0180H,a5
         000073b0     0180  
    2708                    
    2709 000073c0     4e51          move    b2,a1
    2710 000073d0     2e01          srl     16,a1
    2711 000073e0     0b01          addi    42,a1
         000073f0     002a  
    2712 00007400     2581          sll     12,a1                   ;*512*8
    2713 00007410     0b01          addi    SCRNXP*8+68*8,a1        ;A1=*Scrn mem
         00007420     03e0  
    2714                    
    2715 00007430     09e6          movi    DMACMAP,a6
         00007440 01a00080  
    2716 00007460     56e7          clr     a7                      ;Y line 8:8
    2717 00007470           peahlp
    2718 00007470     4ce2          move    a7,a2
    2719 00007480     2f02          srl     8,a2
    2720 00007490     2582          sll     12,a2                   ;*512*8
    2721 000074a0     4c43          move    a2,a3
    2722                    
    2723 000074b0     0b22          addi    SCRNBUF,a2
         000074c0 01200000  
    2724 000074e0     0b23          addi    PALBUF,a3
         000074f0 01300000  
    2725 00007510     09d0          movi    400/2/3,b0              ;Copy 1 line
         00007520     0042  
    2726 00007530           peahcslp
    2727 00007530     8866          move    *a3,*a6                 ;Set pal latch
    2728 00007540     1203          addk    16,a3
    2729 00007550     9841          move    *a2+,*a1+               ;Copy 2 pixels
    2730                    
    2731 00007560     8866          move    *a3,*a6
    2732 00007570     1203          addk    16,a3
    2733 00007580     9841          move    *a2+,*a1+
    2734                    
    2735 00007590     1203          addk    16,a3
    2736 000075a0     1202          addk    16,a2
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   58

    2737                    
    2738 000075b0     3d30          dsj     b0,peahcslp
    2739                    
    2740 000075c0     0b01          addi    (512-264)*8,a1
         000075d0     07c0  
    2741                    
    2742 000075e0     40a7          add     a5,a7
    2743 000075f0     0b67          cmpi    254<<8,a7
         00007600 ffff01ff  
    2744 00007620     c4e4          jrlt    peahlp
    2745                    
    2746                    
    2747 00007630           peahx   PULL    a4,a14
    2748 00007650     0960          rets
    2749                    
    2750                    
    2751                    ********************************
    2752                    
    2753 00007660            SUBRP  scrn_scaledison
    2754                    
    2755 00007660     09c0          movi    HEBLNKINIT,a0           ;Display on
         00007670     0065  
    2756 00007680     0580          move    a0,@HEBLNK
         00007690 c0000010  
    2757 000076b0     09e0          movi    scrn_scale,a0
         000076c0 00007710' 
    2758 000076e0     0780          move    a0,@dcode_p,L
         000076f0 00000130- 
    2759                    
    2760                    
    2761                    *******************************
    2762                    * Copy screen data with variable down scaling
    2763                    * B2=Y offset for top of page : XPad offset
    2764                    
    2765 00007710            SUBRP  scrn_scale
    2766                    
    2767 00007710     05a5          move    @scrnscl,a5
         00007720 0005c0c0- 
    2768 00007740     0b45          cmpi    0168H,a5
         00007750     fe97  
    2769 00007760     c48d          jrlt    scrn_scale140
    2770 00007770     0b45          cmpi    0190H,a5
         00007780     fe6f  
    2771 00007790     c4be          jrlt    scrn_scale180
    2772                    
    2773 000077a0                   PUSH    a4,a14
    2774                    
    2775 000077c0     4e59          move    b2,a9
    2776 000077d0     2e09          srl     16,a9
    2777 000077e0     09c3          movi    127<<8,a3
         000077f0     7f00  
    2778 00007800     5aa3          divu    a5,a3
    2779 00007810     4469          sub     a3,a9
    2780 00007820     0b09          addi    127,a9
         00007830     007f  
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   59

    2781 00007840     2589          sll     12,a9                   ;*512*8
    2782                    
    2783 00007850     0b09          addi    (SCRNXP+200)*8,a9       ;A9=*Scrn mem
         00007860     0800  
    2784 00007870     09c3          movi    100<<8,a3
         00007880     6400  
    2785 00007890     5aa3          divu    a5,a3
    2786 000078a0     2483          sll     4,a3                    ;*16
    2787 000078b0     4469          sub     a3,a9
    2788                    
    2789 000078c0     09e6          movi    DMACMAP,a6
         000078d0 01a00080  
    2790 000078f0     56e7          clr     a7                      ;Y line 8:8
    2791 00007900     09ea          movi    200<<8,a10
         00007910 0000c800  
    2792 00007930           jmiwlp
    2793 00007930     4ce2          move    a7,a2
    2794 00007940     2f02          srl     8,a2
    2795 00007950     2582          sll     12,a2                   ;*512*8
    2796 00007960     4c43          move    a2,a3
    2797                    
    2798 00007970     4d21          move    a9,a1
    2799 00007980     0b22          addi    SCRNBUF,a2
         00007990 01200000  
    2800 000079b0     0b23          addi    PALBUF,a3
         000079c0 01300000  
    2801 000079e0     5708          clr     a8                      ;X 8:8
    2802 000079f0           jmiwcslp
    2803 000079f0     8866          move    *a3,*a6                 ;Set pal latch
    2804 00007a00     8841          move    *a2,*a1                 ;Copy 2 pixels
    2805 00007a10     1201          addk    16,a1
    2806                    
    2807 00007a20     4d00          move    a8,a0
    2808 00007a30     40a8          add     a5,a8
    2809 00007a40     2b00          sra     8,a0
    2810 00007a50     4d0e          move    a8,a14
    2811 00007a60     2b0e          sra     8,a14
    2812 00007a70     440e          sub     a0,a14
    2813                    
    2814 00007a80           jmiwnxtp
    2815 00007a80     1203          addk    16,a3
    2816 00007a90     1202          addk    16,a2
    2817 00007aa0     142e          subk    1,a14
    2818 00007ab0     c7fc          jrgt    jmiwnxtp
    2819                    
    2820 00007ac0     4948          cmp     a10,a8
    2821 00007ad0     c4f1          jrlt    jmiwcslp
    2822                    
    2823                    
    2824 00007ae0     0b09          addi    512*8,a9                ;Next line
         00007af0     1000  
    2825                    
    2826 00007b00     40a7          add     a5,a7
    2827 00007b10     0b67          cmpi    254<<8,a7
         00007b20 ffff01ff  
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   60

    2828 00007b40     c4de          jrlt    jmiwlp
    2829                    
    2830                    
    2831 00007b50           jmiwx   PULL    a4,a14
    2832 00007b70     0960          rets
    2833                    
    2834                    
    2835                    *****************************************************************************
    2836                    * Remove an object from OBJLST and move it to BAKLST
    2837                    * a0=*obj
    2838                    * Trashes a1,a14
    2839                    
    2840 00007b80            SUBR   fg2bg
    2841                    
    2842 00007b80     09e1          movi    OBJLST,a1
         00007b90 00000000+ 
    2843                    
    2844 00007bb0           gursloop
    2845 00007bb0     4c2e          move    a1,a14
    2846 00007bc0     8621          move    *a1,a1,L
    2847 00007bd0     ca19          jrz     gursnot_found
    2848 00007be0     4801          cmp     a0,a1
    2849 00007bf0     cbfb          jrne    gursloop
    2850                    
    2851                            ;found it
    2852 00007c00     8a0e          move    *a0,*a14,L              ;remove from OBJLST
    2853 00007c10     0d3f          callr   INSBOBJ                 ;add to BAKLST
         00007c20     fba0  
    2854                    
    2855 00007c30     b401          move    *a0(ODXOFF),a1          ;adjust X and Y pos.  BGND objects
         00007c40     0220  
    2856 00007c50     b40e          move    *a0(OXPOS),a14          ; don't use anim points.
         00007c60     0090  
    2857 00007c70     442e          sub     a1,a14
    2858 00007c80     b1c0          move    a14,*a0(OXPOS)
         00007c90     0090  
    2859 00007ca0     57ce          clr     a14
    2860 00007cb0     b1c0          move    a14,*a0(ODXOFF)
         00007cc0     0220  
    2861                    
    2862 00007cd0     b401          move    *a0(ODYOFF),a1
         00007ce0     0230  
    2863 00007cf0     b40e          move    *a0(OYPOS),a14
         00007d00     00b0  
    2864 00007d10     442e          sub     a1,a14
    2865 00007d20     b1c0          move    a14,*a0(OYPOS)
         00007d30     00b0  
    2866 00007d40     57ce          clr     a14
    2867 00007d50     b1c0          move    a14,*a0(ODYOFF)
         00007d60     0230  
    2868                    
    2869 00007d70           gursnot_found
    2870 00007d70     0960          rets
    2871                    
    2872                    *****************************************************************************
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   61

    2873                    * Create an object from one of jason's special header blocks.
    2874                    * 0a0H=*block
    2875                    * <a8=*obj
    2876                    * Trashes a14
    2877                    
    2878 00007d80            SUBR   BEGINOBJ_TBL
    2879                    
    2880 00007d80                   PUSH    a0,a1,a2,a3,a4,a5,a6,a7
    2881 00007da0     4c0e          move    a0,a14
    2882 00007db0     95c0          move    *a14+,a0,W              ;X
    2883 00007dc0     2600          sll     16,a0
    2884 00007dd0     95c1          move    *a14+,a1,W              ;Y
    2885 00007de0     2601          sll     16,a1
    2886 00007df0     95c3          move    *a14+,a3,W              ;Z
    2887 00007e00     97c2          move    *a14+,a2,L              ;IMG
    2888 00007e10     95c4          move    *a14+,a4,W              ;CTRL
    2889 00007e20     95c5          move    *a14+,a5,W              ;OID
    2890 00007e30     97c6          move    *a14+,a6,L              ;X vel
    2891 00007e40     97c7          move    *a14+,a7,L              ;Y vel
    2892                    
    2893 00007e50     0d5f          calla   BEGINOBJ
         00007e60 000046f0' 
    2894                    
    2895 00007e80                   PULL    a0,a1,a2,a3,a4,a5,a6,a7
    2896 00007ea0     0960          rets
    2897                    
    2898 00007eb0            SUBR   BEGINOBJW_TBL
    2899                    
    2900 00007eb0                   PUSH    a0,a1,a2,a3,a4,a5,a6,a7
    2901 00007ed0     4c0e          move    a0,a14
    2902 00007ee0     95c0          move    *a14+,a0,W              ;X
    2903 00007ef0     2600          sll     16,a0
    2904 00007f00     95c1          move    *a14+,a1,W              ;Y
    2905 00007f10     2601          sll     16,a1
    2906 00007f20     95c3          move    *a14+,a3,W              ;Z
    2907 00007f30     97c2          move    *a14+,a2,L              ;IMG
    2908 00007f40     95c4          move    *a14+,a4,W              ;CTRL
    2909 00007f50     95c5          move    *a14+,a5,W              ;OID
    2910 00007f60     97c6          move    *a14+,a6,L              ;X vel
    2911 00007f70     97c7          move    *a14+,a7,L              ;Y vel
    2912                    
    2913 00007f80     0d5f          calla   BEGINOBJW
         00007f90 00004650' 
    2914                    
    2915 00007fb0                   PULL    a0,a1,a2,a3,a4,a5,a6,a7
    2916 00007fd0     0960          rets
    2917                    
    2918                    ******************************************************************************
    2919                    
    2920 00007fe0           PLACE_SHADOWS
    2921 00007fe0     098f          mmtm    sp,a0,a1,a2,a3,a4,a5,a6,a7,a8,a9,a10,a11,a12,a13,a14
         00007ff0     fffe  
    2922 00008000     099f          mmtm    sp,b0,b1,b2,b3,b4,b5,b6,b7,b8,b9,b10,b11,b12,b13,b14
         00008010     fffe  
    2923                    
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   62

    2924 00008020     07ad          move    @process_ptrs,a13,L
         00008030 00000000! 
    2925 00008050     ca00          jrz     shad9
         00008060     00a7  
    2926 00008070     4da3          MOVE    A13,A3
    2927 00008080     0b03          addi    OBJ_BASE,a3
         00008090     0760  
    2928 000080a0     8663          move    *a3,a3,L
    2929 000080b0     0b03          addi    020h,a3
         000080c0     0020  
    2930                    
    2931 000080d0     09f0          movi    DMACTRL,b0
         000080e0 01a00010  
    2932 00008100     8413  shad_1  move    *b0,b3,W
    2933 00008110     cefe          jrn     shad_1          ; wait for dma while busy
    2934                    
    2935 00008120     09e2          movi    001000100H,a2
         00008130 01000100  
    2936 00008150     0782          move    a2,@DMASCALEX,L         ; dma input dmuo1 = scale
         00008160 01a000a0  
    2937                    ;       movi    bpal_black*010000H,a2
    2938                    *TEMP
    2939 00008180     09e2          movi    010101010h,a2
         00008190 10101010  
    2940                    ;       CLR     A2
    2941                    *TEMP
    2942 000081b0     0782          move    a2,@DMACMAP,L           ; dma input dmuo2 = const:palette
         000081c0 01a00080  
    2943                    *
    2944                    * setup dedicated registers
    2945                    *
    2946                    *  b0 = dmactrl
    2947                    *  b1 = worldtly
    2948                    *  a2 = dma y:x size pointer
    2949                    *  a3 = dma control:offset
    2950                    *  a6 = dma y coordinate pointer
    2951                    * a12 = dma sag pointer
    2952                    *
    2953                    
    2954 000081e0     09e6          movi    DMAVERT,a6
         000081f0 01a00050  
    2955 00008210     1828          movk    1,a8
    2956 00008220     b106          move    a8,*a6(020h),W          ; y size is always "1"
         00008230     0020  
    2957 00008240     09e2          movi    DMAOFFST,a2
         00008250 01a00000  
    2958 00008270     5708          clr     a8
    2959 00008280     9102          move    a8,*a2+,W               ; offset is always "0"
    2960 00008290     09f6          movi    DMAHORIZ,b6
         000082a0 01a00040  
    2961 000082c0     09e7          movi    02000000h,a7
         000082d0 02000000  
    2962 000082f0     09ec          movi    DMASAGL,a12
         00008300 01a00020  
    2963 00008320     07a5          move    @page_addr,a5,L
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   63

         00008330 00000010- 
    2964                    
    2965 00008350           shad0   
    2966 00008350     9669          move    *a3+,a9,L
    2967 00008360     b520          move    *a9(OXPOS),a0,W
         00008370     0090  
    2968 00008380     0520          zext    a0,W
    2969                    ;       sll     16,a13
    2970                    ;       or      a13,a0                  ; a0 = ani y:x for all pieces (world)
    2971                    
    2972 00008390     4e3e          move    b1,a14                  ; a14 = worldtly
    2973 000083a0     57ad          CLR     A13
    2974 000083b0     05ad          move    @WORLDTLX+16,a13
         000083c0 00000080- 
    2975 000083e0     e3a0          SUBXY   A13,A0
    2976                    
    2977 000083f0     05ad          move    @WORLDTLY+16,A13
         00008400 000000a0- 
    2978 00008420     0bed          SUBI    10,A13
         00008430     fff5  
    2979 00008440     260d          SLL     16,A13
    2980 00008450     e3a0          SUBXY   A13,A0
    2981                    
    2982 00008460     e0a0          addxy   a5,a0
    2983 00008470     4e08          MOVE    A0,B8
    2984 00008480     8316          MOVE    B8,*B6,L        ;DO XPOS
    2985                    
    2986 00008490     4e04          MOVE    A0,B4
    2987                    
    2988                            .ALIGN
    2989                    **************************************************************************
    2990                    *                                                                                            *
    2991                    *  piece by piece loop                                                                       *
    2992                    *                                                                                            *
    2993                    **************************************************************************
    2994 00008600           shad2
    2995 00008600     b52a          move    *a9(OYPOS),a10
         00008610     00b0  
    2996 00008620     ce4b          jrn     shad9
    2997 00008630     b72a          move    *a9(OSAG),a10,L ; a10 = sag of this piece
         00008640     0110  
    2998 00008650     ca48          jrz     shad9                   ; sag = 0 ---> we are done
    2999                    
    3000 00008660     40ea          add     a7,a10
    3001                    
    3002 00008670     b52d          move    *a9(OSIZEY),a13,W       ; a13 = # of lines
         00008680     0140  
    3003 00008690     2fad          srl     3,a13                   ; shadows are 1/4 the normal height
    3004 000086a0     4fa5          move    a13,b5
    3005                    
    3006 000086b0     b52b          move    *a9(OSIZEX),a11,W
         000086c0     0130  
    3007 000086d0     b166          move    a11,*a6(010h),W         ; set a11 = x size for this piece
         000086e0     0010  
    3008                    
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   64

    3009 000086f0     b52d          move    *a9(ODXOFF),A13
         00008700     0220  
    3010 00008710     b52e          move    *a9(OCTRL),a14,W
         00008720     00f0  
    3011 00008730     1f6e          btst    B_FLIPH,a14             ; flip horizontal ?
    3012 00008740     ca01          jreq    shad1
    3013 00008750     03ad          NEG     A13
    3014                    
    3015 00008760     4dc1  shad1   move    a14,a1
    3016 00008770     4dc4          move    a14,a4
    3017 00008780     2681          sll     16+4,a1
    3018 00008790     2c41          srl     32-2,a1                 ; a1 = trail multiplier
    3019 000087a0     26c4          sll     16+4+2,a4
    3020 000087b0     2c44          srl     32-2,a4                 ; a4 = lead multiplier
    3021                    
    3022 000087c0     0bae          ori     DMACNZ,a14
         000087d0 00008008  
    3023                    
    3024 000087f0     4e90          MOVE    B4,A0
    3025 00008800     e3a0          SUBXY   A13,A0
    3026 00008810     4e08          move    a0,b8
    3027 00008820     8116          move    b8,*b6,W                ; set x coordinate here !!
    3028 00008830     2e00          srl     16,a0
    3029 00008840     b52d          move    *a9(ODYOFF),A13
         00008850     0230  
    3030 00008860     2fad          SRL     3,A13
    3031 00008870     e3a0          SUBXY   A13,A0
    3032                    
    3033                    **************************************************************************
    3034                    *                                                                                            *
    3035                    *  line by line loop                                                                         *
    3036                    *                                                                                            *
    3037                    **************************************************************************
    3038                    
    3039 00008880           shad4
    3040 00008880     8413  shad3   move    *b0,b3,W
    3041 00008890     cefe          jrn     shad3           ; wait for dma while busy
    3042                    
    3043 000088a0     44ea          sub     A7,a10
    3044 000088b0     834c          move    a10,*a12,L      ; stuff sag
    3045 000088c0     40ea          add     A7,a10
    3046                    
    3047 000088d0     8006          move    a0,*a6,W        ; set y coordinate
    3048 000088e0     81c2          move    a14,*a2,W       ; set the GO! bit
    3049 000088f0     3915          dsjs    b5,shad5
    3050                    
    3051                    **************************************************************************
    3052                    *                                                                                            *
    3053                    *  do the last line again to fill in "holes"                                         *
    3054                    *                                                                                            *
    3055                    **************************************************************************
    3056 00008900     1020          inc     a0
    3057 00008910     8006          move    a0,*a6,W        ; set y 1 line down
    3058 00008920     1420          dec     a0
    3059                    
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   65

    3060 00008930     8413  shad6   move    *b0,b3,W
    3061 00008940     cefe          jrn     shad6           ; wait for dma while busy
    3062 00008950     81c2          move    a14,*a2,W       ; set the GO
    3063 00008960     9669          move    *a3+,a9,L
    3064 00008970     c0c8          jruc    shad2
    3065                    
    3066                    *
    3067                    * skip 4 lines
    3068                    *
    3069 00008980     8413  shad5   move    *b0,b3,W
    3070 00008990     cefe          jrn     shad5           ; wait for dma while busy
    3071 000089a0     1020          inc     a0
    3072 000089b0     1913          movk    8,b3
    3073 000089c0     0548          setf    8,0,0           ; field 0 is 8 bits (zero extend)
    3074                    
    3075 000089d0     9548  shad7   move    *a10+,a8,W      ; grab a BYTE !!
    3076                    
    3077 000089e0     4d0d          move    a8,a13
    3078 000089f0     278d          sll     32-4,a13
    3079 00008a00     2c8d          srl     32-4,a13        ; mask off upper b.s.
    3080 00008a10     628d          sll     a4,a13          ; a13 = lead zeros
    3081                    
    3082 00008a20     2f88          srl     4,a8            
    3083 00008a30     6228          sll     a1,a8           ; a8 = trailing zeros
    3084                    
    3085 00008a40     410d          add     a8,a13          ; a13 = lead + trailing = all compressed zeros
    3086 00008a50     4d68          move    a11,a8          ; a8 = x size
    3087 00008a60     45a8          sub     a13,a8          ; a8 = uncompressed pixels to skip
    3088                    
    3089 00008a70     2428          sll     1,a8            ; 2x
    3090 00008a80     410a          add     a8,a10
    3091 00008a90     2428          sll     1,a8            ; + 4x = 6 bits per pixel
    3092 00008aa0     410a          add     a8,a10          ; a10 ---> sag for next line
    3093 00008ab0     3df3          dsjs    b3,shad7
    3094                    
    3095                    ;xx
    3096 00008ac0     0570          setf    16,1,0          ; field 0 is back to 16 bits
    3097 00008ad0     c0da          jruc    shad4
    3098                    
    3099 00008ae0           shad9
    3100 00008ae0     09bf          mmfm    sp,b0,b1,b2,b3,b4,b5,b6,b7,b8,b9,b10,b11,b12,b13,b14
         00008af0     7fff  
    3101 00008b00     09af          mmfm    sp,a0,a1,a2,a3,a4,a5,a6,a7,a8,a9,a10,a11,a12,a13,a14
         00008b10     7fff  
    3102 00008b20     0960          rets
    3103                    
    3104                    ;******************************************************************************
    3105                    ;
    3106                    ;PLACE_SHADOWS
    3107                    ;       mmtm    sp,a0,a1,a2,a3,a4,a5,a6,a7,a8,a9,a10,a11,a12,a13,a14
    3108                    ;       mmtm    sp,b0,b1,b2,b3,b4,b5,b6,b7,b8,b9,b10,b11,b12,b13,b14
    3109                    ;
    3110                    ;       move    @process_ptrs,a3,L
    3111                    ;       jrz     shad9
    3112                    ;       addi    OBJ_BASE,a3
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   66

    3113                    ;       move    *a3,a3,L
    3114                    ;       addi    020h,a3
    3115                    ;
    3116                    ;       movi    DMACTRL,b0
    3117                    ;shad_1 move    *b0,b3,W
    3118                    ;       jrn     shad_1          ; wait for dma while busy
    3119                    ;
    3120                    ;       movi    001000100H,a2
    3121                    ;       move    a2,@DMASCALEX,L         ; dma input dmuo1 = scale
    3122                    ;;      movi    bpal_black*010000H,a2
    3123                    ;*TEMP
    3124                    ;       CLR     A2
    3125                    ;*TEMP
    3126                    ;       move    a2,@DMACMAP,L           ; dma input dmuo2 = const:palette
    3127                    ;*
    3128                    ;* setup dedicated registers
    3129                    ;*
    3130                    ;*  b0 = dmactrl
    3131                    ;*  b1 = worldtly
    3132                    ;*  a2 = dma y:x size pointer
    3133                    ;*  a3 = dma control:offset
    3134                    ;*  a6 = dma y coordinate pointer
    3135                    ;* a12 = dma sag pointer
    3136                    ;*
    3137                    ;
    3138                    ;       movi    DMAVERT,a6
    3139                    ;       movk    1,a8
    3140                    ;       move    a8,*a6(020h),W          ; y size is always "1"
    3141                    ;       movi    DMAOFFST,a2
    3142                    ;       clr     a8
    3143                    ;       move    a8,*a2+,W               ; offset is always "0"
    3144                    ;       movi    DMAHORIZ,b6
    3145                    ;       movi    02000000h,a7
    3146                    ;       movi    DMASAGL,a12
    3147                    ;       move    @page_addr,a5,L
    3148                    ;
    3149                    ;shad0  
    3150                    ;       move    *a3+,a9,L
    3151                    ;       move    *a9(OYPOS),a13,W
    3152                    ;       move    *a9(OXPOS),a0,W
    3153                    ;       zext    a0,W
    3154                    ;       sll     16,a13
    3155                    ;       or      a13,a0                  ; a0 = ani y:x for all pieces (world)
    3156                    ;
    3157                    ;       move    b1,a14                  ; a14 = worldtly
    3158                    ;       CLR     A13
    3159                    ;       move    @WORLDTLX+16,a13
    3160                    ;       SUBXY   A13,A0
    3161                    ;
    3162                    ;       move    @WORLDTLY+16,A13
    3163                    ;       SLL     16,A13
    3164                    ;       ADDXY   A13,A0
    3165                    ;
    3166                    ;       addxy   a5,a0
    3167                    ;       MOVE    A0,B8
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   67

    3168                    ;       MOVE    B8,*B6,L        ;DO XPOS
    3169                    ;
    3170                    ;       MOVE    A0,B4
    3171                    ;
    3172                    ;**************************************************************************
    3173                    ;*                                                                                           *
    3174                    ;*  piece by piece loop                                                                      *
    3175                    ;*                                                                                           *
    3176                    ;**************************************************************************
    3177                    ;
    3178                    ;shad2  move    *a9(OSAG),a10,L ; a10 = sag of this piece
    3179                    ;       jrz     shad9                   ; sag = 0 ---> we are done
    3180                    ;
    3181                    ;       add     a7,a10
    3182                    ;
    3183                    ;       move    *a9(OSIZEY),a13,W       ; a13 = # of lines
    3184                    ;       srl     2,a13                   ; shadows are 1/4 the normal height
    3185                    ;       move    a13,b5
    3186                    ;
    3187                    ;       move    *a9(OSIZEX),a11,W
    3188                    ;       move    a11,*a6(010h),W         ; set a11 = x size for this piece
    3189                    ;
    3190                    ;       move    *a9(OCTRL),a14,W
    3191                    ;       btst    B_FLIPH,a14             ; flip horizontal ?
    3192                    ;       jreq    shad1
    3193                    ;       addxy   a11,a0                  ; yes, adjust coordinates for flip
    3194                    ;       dec     a0                      ; and nudge..
    3195                    ;
    3196                    ;shad1  move    a14,a1
    3197                    ;       move    a14,a4
    3198                    ;       sll     16+4,a1
    3199                    ;       srl     32-2,a1                 ; a1 = trail multiplier
    3200                    ;       sll     16+4+2,a4
    3201                    ;       srl     32-2,a4                 ; a4 = lead multiplier
    3202                    ;
    3203                    ;       ori     DMACNZ,a14
    3204                    ;
    3205                    ;       MOVE    B4,A0
    3206                    ;       move    a0,b8
    3207                    ;       move    b8,*b6,W                ; set x coordinate here !!
    3208                    ;       srl     16,a0
    3209                    ;
    3210                    ;**************************************************************************
    3211                    ;*                                                                                           *
    3212                    ;*  line by line loop                                                                        *
    3213                    ;*                                                                                           *
    3214                    ;**************************************************************************
    3215                    ;
    3216                    ;shad4
    3217                    ;shad3  move    *b0,b3,W
    3218                    ;       jrn     shad3           ; wait for dma while busy
    3219                    ;
    3220                    ;       sub     A7,a10
    3221                    ;       move    a10,*a12,L      ; stuff sag
    3222                    ;       add     A7,a10
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   68

    3223                    ;
    3224                    ;       move    a0,*a6,W        ; set y coordinate
    3225                    ;       move    a14,*a2,W       ; set the GO! bit
    3226                    ;       dsjs    b5,shad5
    3227                    ;
    3228                    ;**************************************************************************
    3229                    ;*                                                                                           *
    3230                    ;*  do the last line again to fill in "holes"                                        *
    3231                    ;*                                                                                           *
    3232                    ;**************************************************************************
    3233                    ;       inc     a0
    3234                    ;       move    a0,*a6,W        ; set y 1 line down
    3235                    ;       dec     a0
    3236                    ;
    3237                    ;shad6  move    *b0,b3,W
    3238                    ;       jrn     shad6           ; wait for dma while busy
    3239                    ;
    3240                    ;       move    a14,*a2,W       ; set the GO
    3241                    ;
    3242                    ;       move    *a3+,a9,L
    3243                    ;
    3244                    ;       jruc    shad2
    3245                    ;
    3246                    ;*
    3247                    ;* skip 4 lines
    3248                    ;*
    3249                    ;shad5  move    *b0,b3,W
    3250                    ;       jrn     shad5           ; wait for dma while busy
    3251                    ;
    3252                    ;       inc     a0
    3253                    ;
    3254                    ;       movk    4,b3
    3255                    ;       setf    8,0,0           ; field 0 is 8 bits (zero extend)
    3256                    ;
    3257                    ;shad7  move    *a10+,a8,W      ; grab a BYTE !!
    3258                    ;
    3259                    ;       move    a8,a13
    3260                    ;       sll     32-4,a13
    3261                    ;       srl     32-4,a13        ; mask off upper b.s.
    3262                    ;       sll     a4,a13          ; a13 = lead zeros
    3263                    ;
    3264                    ;       srl     4,a8            
    3265                    ;       sll     a1,a8           ; a8 = trailing zeros
    3266                    ;
    3267                    ;       add     a8,a13          ; a13 = lead + trailing = all compressed zeros
    3268                    ;       move    a11,a8          ; a8 = x size
    3269                    ;       sub     a13,a8          ; a8 = uncompressed pixels to skip
    3270                    ;
    3271                    ;       sll     1,a8            ; 2x
    3272                    ;       add     a8,a10
    3273                    ;       sll     1,a8            ; + 4x = 6 bits per pixel
    3274                    ;       add     a8,a10          ; a10 ---> sag for next line
    3275                    ;       dsjs    b3,shad7
    3276                    ;
    3277                    ;;xx
TMS340 COFF Macro Assembler Version 6.10     Wed Nov 01 06:20:02 2023
 Copyright (c) 1985-1991  Texas Instruments Incorporated 

DMA object handler                                                   PAGE   69

    3278                    ;       setf    16,1,0          ; field 0 is back to 16 bits
    3279                    ;       jruc    shad4
    3280                    ;
    3281                    ;shad9
    3282                    ;       mmfm    sp,b0,b1,b2,b3,b4,b5,b6,b7,b8,b9,b10,b11,b12,b13,b14
    3283                    ;       mmfm    sp,a0,a1,a2,a3,a4,a5,a6,a7,a8,a9,a10,a11,a12,a13,a14
    3284                    ;       rets
    3285                    ;
    3286                    
    3287                    ******************************************************************************
    3288                    
    3289                            .end

 No Errors,  No Warnings
